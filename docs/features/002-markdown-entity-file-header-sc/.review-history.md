# Review History: 002-markdown-entity-file-header-sc

## Step 1: Spec-Reviewer Review - Iteration 1 - 2026-03-02T18:15:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [factual-error] C1 YAML library constraint is wrong — `yaml` is NOT in Python stdlib; PyYAML is third-party. Creates ambiguous dual-path implementation. (at: C1)
  Suggestion: Mandate the minimal parser as the sole implementation path since schema is flat key-value only.
- [blocker] [contradiction] R14 and AC-16 contradict — R14 says mismatched entity_uuid files "get headers written" (overwrite), AC-16 says mismatched UUID raises ValueError. (at: R14, AC-16)
  Suggestion: Align R14 with AC-16: mismatched entity_uuid raises ValueError, only files WITHOUT frontmatter get new headers.
- [blocker] [unspecified-mechanism] R12 references commitAndComplete as if it's a callable Python function, but it's pseudocode in a SKILL.md. Integration mechanism is unspecified. (at: R12)
  Suggestion: Specify actual mechanism — a shell command step in the SKILL.md pseudocode that invokes a Python CLI script, or a PostToolUse hook.
- [warning] [test-gap] AC-12 integration test lacks fixture specification — how to set up entity registry state and trigger commitAndComplete in test. (at: AC-12)
  Suggestion: Add test fixture specification or mark as manual verification.
- [warning] [underspecified] R13 DB path and type_id resolution mechanisms unspecified — how does integration code find the DB and construct the type_id? (at: R13)
  Suggestion: Specify DB path resolution (env var or known path) and type_id construction from .meta.json fields.
- [warning] [ambiguity] R9/R14/AC-16 replace semantics unclear when existing frontmatter has same UUID but different optional fields. (at: R9, R14)
  Suggestion: Clarify: same UUID → merge/update optional fields; different UUID → raise ValueError.
- [warning] [enforcement-gap] R5 field ordering only enforceable on write, not on read-write cycles if external tools reorder. (at: R5, C4)
  Suggestion: Clarify R5 is write-time only; C4 round-trip fidelity compares values not field order.
- [warning] [traceability] PRD traceability is indirect (PRD → roadmap → feature 002), not direct. (at: PRD Traceability)
  Suggestion: Acknowledge the indirect chain explicitly.

**Changes Made:**
- C1: Mandated minimal custom parser as sole implementation, removed PyYAML reference
- R14: Aligned with AC-16 — mismatched UUID raises ValueError, no overwrite
- R12: Specified CLI script (`frontmatter_inject.py`) invoked in SKILL.md pseudocode
- AC-12: Added subprocess.run + ENTITY_DB_PATH test fixture setup
- R13: Specified ENTITY_DB_PATH env var + fallback path for DB resolution
- R9: Clarified same-UUID merge behavior, different-UUID raises ValueError
- R5: Clarified write-time only convention
- PRD traceability: Acknowledged indirect chain (PRD → roadmap → feature 002)

---

## Step 1: Spec-Reviewer Review - Iteration 2 - 2026-03-02T18:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] C1 custom parser split semantics ambiguous — does not specify split on FIRST `: ` occurrence vs all. Two implementers could produce incompatible parsers. (at: C1)
  Suggestion: Specify split on FIRST `: ` occurrence, key matches `^[a-z_]+`, value is remainder after first `: `, non-matching lines silently ignored.
- [blocker] [testability] R9/R11 interaction — write_frontmatter merge preserves unknown keys, but validate_header rejects unknown fields. Spec must state whether write_frontmatter validates before writing. (at: R9, R11)
  Suggestion: Explicitly state whether write_frontmatter calls validate_header before writing or trusts the caller.
- [warning] [assumptions] C2 os.rename() atomicity assumes POSIX. Not stated explicitly. (at: C2)
  Suggestion: Add explicit POSIX platform assumption.
- [warning] [assumptions] R8/R13/R15 logging mechanism inconsistent — no standard defined. (at: R8, R13, R15)
  Suggestion: Standardize on Python stdlib `logging` module for library, `print(stderr)` for CLI.
- [warning] [testability] AC-9 atomic write verification method unspecified. (at: AC-9)
  Suggestion: Specify mock-based or code review verification.
- [warning] [assumptions] R12 plugin_root resolution in SKILL.md context not specified. (at: R12)
  Suggestion: Specify two-location Glob pattern and plugin venv Python interpreter.
- [warning] [scope] R4 updated_at — ambiguous whether caller-managed or module-managed. (at: R4, R9, R10)
  Suggestion: State explicitly whether write_frontmatter auto-sets updated_at on updates.
- [warning] [clarity] entity_type_id (frontmatter) vs type_id (DB) naming inconsistency not mapped. (at: R3, R13)
  Suggestion: Add field mapping note.
- [warning] [testability] Test Strategy mentions 'binary content guard' but no requirement defines behavior. (at: Test Strategy)
  Suggestion: Add R8a binary detection requirement or remove from Test Strategy.

**Changes Made:**
- C1: Added precise split semantics — split on FIRST `: `, key matches `^[a-z_]+$`, value is remainder, non-matching lines ignored
- R9: Added explicit validation — write_frontmatter calls validate_header on merged result before writing, aborts on failure
- C2: Added explicit POSIX platform assumption, Windows not supported
- R8: Standardized logging on Python stdlib `logging` module, added binary content guard (null bytes in first 8192 bytes)
- AC-9: Specified mock-based verification of os.rename
- R12: Added two-location Glob pattern for plugin root resolution and plugin venv Python interpreter
- R4: Made updated_at explicitly caller-managed
- R13: Added entity_type_id ↔ type_id field mapping note
- Test Strategy: Referenced R8 null-byte detection for binary content guard
- AC-12: Strengthened to verify all R3 required fields
- R15: Clarified exact basename match (case-sensitive)

RESUME-FALLBACK: spec-reviewer iteration 3 — agent_id lost (context compaction)

---

## Step 1: Spec-Reviewer Review - Iteration 3 - 2026-03-02T19:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [warning] [testability] AC-9 "or by code review of the implementation" weakens testability — allows non-automated verification as substitute. (at: AC-9)
  Suggestion: Remove the code review fallback; require mock-based verification only.
- [warning] [underspecified] R13 does not specify how the CLI script accesses the DB — raw SQL, ORM, or EntityDatabase class. (at: R13)
  Suggestion: Specify EntityDatabase instantiation as the DB access method.
- [warning] [ambiguity] R8 "malformed frontmatter" is undefined — does an empty block between `---` delimiters count as malformed? (at: R8)
  Suggestion: Define precisely: only a missing closing `---` is malformed; an empty block is valid (returns empty dict).
- [warning] [assumptions] R12 fail-open clause doesn't cover case where plugin venv Python interpreter doesn't exist. (at: R12)
  Suggestion: Add explicit note that non-zero exit (including missing interpreter) triggers fail-open.
- [warning] [ambiguity] AC-13 "exits with code 0 or logs a warning" — ambiguous whether both or either is required. (at: AC-13)
  Suggestion: Make unambiguous: exit code 0 AND warning logged to stderr.

**Changes Made:**
- AC-9: Removed "or by code review of the implementation" fallback — mock-based verification only
- R13: Specified EntityDatabase instantiation from entity_registry package as DB access method
- R8: Clarified malformed frontmatter — only missing closing `---` is malformed; empty block is valid
- R12: Added explicit venv-missing note in fail-open clause
- AC-13: Changed to unambiguous "exits with code 0 and logs a warning to stderr"

---

## Step 2: Phase Review - Iteration 1 - 2026-03-02T19:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [implementation-leakage] Spec embeds implementation decisions (function signatures, regex, parser algorithm, CLI format) that belong in design. (at: R7-R15, C1-C4)
  Suggestion: Add a Design Constraints section documenting which decisions are locked vs open.
- [warning] [problem-statement] Problem statement is multi-sentence and blends problem with PRD traceability. (at: Problem Statement)
  Suggestion: Condense to one sentence; move traceability to separate subsection.

**Changes Made:**
- Problem Statement: Condensed to single sentence; moved traceability to separate subsection
- Added "Design Constraints (Locked Decisions)" section listing all locked implementation decisions and what remains open for design

---

## Step 2: Phase Review - Iteration 2 - 2026-03-02T19:45:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [underspecified] R9 merge semantics gap — what happens when optional field is passed as None/empty string. (at: R9)
  Suggestion: Specify explicit deletion semantics for None/empty values.
- [warning] [ambiguity] R8 empty dict vs None distinction for callers — no guidance on how to interpret each. (at: R8)
  Suggestion: Document that empty dict means "block found, no parseable lines" vs None means "no block found".

**Changes Made:**
- R9: Added explicit deletion semantics — keys with None or empty string values are removed from merged header
- R8: Added empty dict vs None distinction documentation for callers

---

## Step 2: Phase Review - Iteration 3 - 2026-03-02T20:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [test-gap] R9 deletion semantics has no acceptance criteria coverage. (at: R9, AC section)
  Suggestion: Add AC-17 covering None deletion case.
- [warning] [ambiguity] R8 EOF edge case for unclosed frontmatter not explicitly stated. (at: R8)
  Suggestion: Clarify that opening `---` with no closing `---` anywhere in file (block extends to EOF) is malformed.

**Changes Made:**
- Added AC-17: write_frontmatter with None value removes field from frontmatter
- R8: Added EOF clarification — block extending to EOF is malformed

---

## Step 2: Phase Review - Iteration 4 - 2026-03-02T20:15:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [test-gap] AC-17 only covers None, not empty string — R9 specifies both as deletion triggers. (at: AC-17, R9)
  Suggestion: Add AC-18 for empty string deletion case.
- [warning] [inconsistency] Test Strategy range "AC-14 through AC-16" doesn't include new AC-17. (at: Test Strategy)
  Suggestion: Extend range to "AC-14 through AC-18".

**Changes Made:**
- Added AC-18: write_frontmatter with empty string value removes field from frontmatter
- Test Strategy: Extended range from "AC-14 through AC-16" to "AC-14 through AC-18"

---

## Step 2: Phase Review - Iteration 5 - 2026-03-02T20:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (cap reached — proceeding with warning)

**Issues:**
- [warning] [fragile-coupling] R13 references `_resolve_identifier` (a private method) — fragile coupling to internal API. (at: R13)
  Suggestion: Document stability or rename to remove underscore prefix.
- [warning] [ambiguity] Exact insertion point within commitAndComplete step is ambiguous. (at: R12, Scope Boundary item 4)
  Suggestion: Add one sentence clarifying insertion position.
- [suggestion] AC-12 doesn't specify test DB state setup. (at: AC-12)
  Suggestion: Make pre-registered entity explicit in AC.

**Changes Made:**
- Cap reached (5/5). Concerns stored in .meta.json phaseReview.reviewerNotes. Proceeding to auto-commit.

---

## Design Review - Iteration 1 - 2026-03-02T22:30:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] _parse_block return type inconsistent between C1 (dict | None) and I7 (tuple[dict | None, int]). (at: C1 vs I7)
  Challenge: Which is canonical? I7 tuple is clearly correct for write_frontmatter's data flow.
- [blocker] [completeness] SKILL.md integration (I6) uses {entity_type_id} template var but commitAndComplete has no such parameter. Data lineage undefined. (at: I6, Data Flow step 2)
  Challenge: Where does type_id come from at invocation site?
- [blocker] [completeness] C4 says "single-line addition" but I6 shows 5-line block. SKILL.md is LLM-interpreted pseudocode, not bash. (at: I6, C4)
  Challenge: How does LLM agent interpret the injected block?
- [warning] [completeness] I5 step 7 vaguely says optional fields from "entity metadata and .meta.json context if available" — no explicit sourcing. (at: I5 step 7)
  Challenge: Which R4 fields come from DB vs .meta.json vs CLI args?
- [warning] [consistency] read_frontmatter (I1) reads line-by-line but _parse_block (I7) takes full text string. Contradictory. (at: I1 vs I7)
  Challenge: If line-by-line, can't delegate to _parse_block(text).
- [warning] [feasibility] created_at merge behavior unspecified — can it be overwritten on update? (at: I2, TD-8)
  Challenge: Should created_at be immutable like entity_uuid?
- [warning] [completeness] write_frontmatter contract says ValueError for file-not-found but implementation raises FileNotFoundError. (at: I2)
  Challenge: Catch and convert, or update contract?
- [warning] [completeness] Prior art claim "zero import yaml" hits design.md itself. (at: Prior Art finding 1)
  Challenge: Minor precision issue.

**Changes Made:**
- C1: Updated _parse_block return type to `tuple[dict | None, int]` matching I7
- C4: Changed from "single-line addition" to "pseudocode block addition"
- I6: Added entity_type_id derivation from .meta.json fields (`feature:{id}-{slug}`)
- I6: Rewrote integration as LLM-interpreted pseudocode (not bash)
- I5 step 7: Specified exact optional field sources (type_id parsing, no .meta.json read needed)
- I1/I7: Resolved contradiction — read_frontmatter reads line-by-line, extracts header text, passes to _parse_block which parses extracted text
- TD-8: Added created_at immutability — preserved from existing header on merge
- I2: Specified FileNotFoundError caught and raised as ValueError
- Prior art: Added "in production code" qualifier
- Added explicit UTF-8 encoding note to I1 and I2

---

## Design Review - Iteration 2 - 2026-03-02T23:00:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] I7 `line.strip()` could alter values with whitespace, violating round-trip fidelity (C4). (at: I7 step 2)
  Challenge: Does line.strip() alter values with leading/trailing whitespace? If so, round-trip fidelity is violated.
- [warning] [completeness] I5 step 7 project_id derivation — unclear whether second DB query or string parsing of parent_type_id. (at: I5 step 7)
  Challenge: How does the CLI determine whether the parent is a project?
- [warning] [consistency] File Locations table still says "Single-line addition" for SKILL.md, contradicting updated C4. (at: File Locations table)
  Challenge: Table vs C4 mismatch.
- [warning] [completeness] I1 binary guard implies double file open (binary then text) — TOCTOU not acknowledged. (at: I1)
  Challenge: Is double-open a concern?
- [suggestion] [completeness] Phase derivation mapping in I5 step 7 should be a named constant like ARTIFACT_PHASE_MAP. (at: I5 step 7)

**Changes Made:**
- I7: Removed `strip()` from parsing algorithm, added caller contract requiring pre-stripped newlines
- I5 step 7: Specified string parsing of parent_type_id (split on `:`) — no second DB query needed
- File Locations table: Changed "Single-line addition" to "Pseudocode block addition"
- I1: Added TOCTOU acknowledgment and explicit newline stripping during line accumulation
- I5 step 7: Named the phase mapping as `ARTIFACT_PHASE_MAP` constant

---

## Design Review - Iteration 3 - 2026-03-02T23:20:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] [completeness] ARTIFACT_PHASE_MAP constant placement — consider placing in a named section. (at: I5 step 7)
  Challenge: Minor organizational concern, no functional impact.

**Changes Made:**
- No changes needed — approved with suggestions only

---

## Handoff Review - Iteration 1 - 2026-03-02T23:25:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [ambiguity] ARTIFACT_PHASE_MAP and ARTIFACT_BASENAME_MAP constant ownership ambiguous — not listed under C2 component definition. (at: I5 step 7 / C2)
  Suggestion: Add Constants sub-section under C2 listing both maps explicitly.
- [warning] [test-gap] TD-9 created_at immutability has no acceptance criterion coverage — behavior may go untested. (at: TD-9 / AC list)
  Suggestion: Note in C3 that TD-9 test case belongs under TestWriteFrontmatter.
- [suggestion] [completeness] Risk 1 mitigation doesn't verify get_entity() accepts type_id strings. (at: Risk 1 / Prior Art item 4)
  Suggestion: Add implementer verification note.

**Changes Made:**
- C2: Added Constants sub-section listing ARTIFACT_BASENAME_MAP and ARTIFACT_PHASE_MAP ownership
- C3: Added TD-9 test case note under TestWriteFrontmatter
- Risk 1: Added verification note for get_entity(type_id) acceptance

---

## Handoff Review - Iteration 2 - 2026-03-02T23:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- None (all iteration 1 issues resolved)

**Changes Made:**
- No further changes needed — approved

---

## Step 1: Plan Review - Iteration 1 - 2026-03-03T00:00:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] UUID regex case-handling: Plan defined `_UUID_V4_RE` with `re.IGNORECASE` but DB convention uses `.lower()` without IGNORECASE. Inconsistency risks data mismatch.
  Suggestion: Match DB convention — no IGNORECASE, normalize UUID to lowercase before matching.
- [blocker] Body content blank line: No specification of blank line between closing `---` and body content. Ambiguous for round-trip fidelity.
  Suggestion: Clarify `_serialize_header` ends with `---\n` and body concatenated directly.
- [blocker] DB key mapping: `get_entity()` returns dict with key `uuid`, not `entity_uuid`. Step 5.2 step 6 says "Extract entity_uuid from entity record" which would cause KeyError.
  Suggestion: Explicit mapping: `entity_uuid = entity_record['uuid']`.
- [warning] Fragile feature_id/feature_slug parsing from type_id when no `-` present in entity_id.
  Suggestion: Add defensive guard for type_ids without `-`.
- [warning] Phase 5 has no test-first step — TDD deviation for CLI.
  Suggestion: Add unit tests for CLI parsing/derivation logic.
- [warning] project_id only checks immediate parent, not ancestor traversal.
  Suggestion: Document as intentional limitation.
- [warning] Duplicated read logic between read_frontmatter and write_frontmatter — divergence risk.
  Suggestion: Add divergence guard test.
- [warning] sys.argv off-by-one ambiguity — "exactly 2 args" unclear.
  Suggestion: Clarify `len(sys.argv) == 3`.
- [warning] _serialize_header round-trip slice `[1:-2]` fragile for edge cases.
  Suggestion: Add empty dict edge case test.

**Changes Made:**
- UUID regex: Removed `re.IGNORECASE`, added `.lower()` normalization before matching, matching DB convention
- Body content: Added explicit note that body concatenated directly after `---\n` with no extra blank line
- DB key mapping: Changed to `entity_uuid = entity_record['uuid']` with explicit DB column mapping note
- Feature_id/slug parsing: Added defensive guard for entity_ids without `-`
- Phase 5 TDD: Added Step 5.2 with unit tests for CLI parsing/derivation helpers
- project_id: Added scope note documenting immediate-parent-only as intentional
- Duplicated read logic: Added divergence guard test to TestWriteFrontmatter
- sys.argv: Changed to explicit `len(sys.argv) == 3`
- Serialize round-trip: Replaced fragile slice with explicit delimiter-based extraction, added empty dict edge case

---

## Step 1: Plan Review - Iteration 2 - 2026-03-03T01:30:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] CLI EntityDatabase instantiation catches generic exceptions — should catch `(sqlite3.Error, OSError)` specifically
  Suggestion: Use targeted exception types, not bare `Exception`.
- [blocker] Blanket `try/except` around entire `main()` masks programming bugs — violates fail-fast
  Suggestion: Replace with targeted handlers per operation. Let unexpected exceptions propagate; SKILL.md `|| true` provides fail-open.
- [warning] `write_frontmatter` lacks binary content guard — could corrupt binary files
  Suggestion: Add same null-byte check as `read_frontmatter`, or document the decision.
- [warning] DB schema version assumption not documented — `get_entity` returns `uuid` key only after migration v2
  Suggestion: Note that `EntityDatabase.__init__` auto-migrates to latest schema.
- [warning] Step 5.2 unit tests reference parsing logic but no extracted helper functions in Step 5.1/5.3
  Suggestion: Extract `_parse_feature_type_id()` and `_extract_project_id()` as testable helpers.
- [warning] AC-9 mock test conflicts with real write tests — split into mock-only and content-verification tests
  Suggestion: Separate AC-9 (mock) from AC-1/AC-8 (real write).
- [warning] Integration test subprocess details missing — interpreter and PYTHONPATH unspecified
  Suggestion: Use `sys.executable` and set `PYTHONPATH` to `hooks/lib`.
- [warning] UUID mismatch check in `write_frontmatter` may be case-sensitive — `ABC-...` vs `abc-...` false mismatch
  Suggestion: Use `.lower()` on both UUIDs before comparison, add test case.

**Changes Made:**
- EntityDatabase instantiation: Changed to catch `(sqlite3.Error, OSError)` specifically, added schema migration guarantee note
- Error boundary: Replaced blanket try/except with targeted per-operation handlers listing specific exception types
- Binary guard: Added binary content guard to `write_frontmatter` with test case
- UUID comparison: Added `.lower()` for both UUIDs in mismatch check, added case-insensitive test case
- Helper extraction: Added `_parse_feature_type_id()` and `_extract_project_id()` to Step 5.1
- AC-9: Split into mock-only test (atomic verify) and real write tests (content verify)
- Integration tests: Specified `sys.executable`, `PYTHONPATH`, file-based DB (not `:memory:`), `db.close()` before subprocess
- Phase 6: Clarified insertion point (between heading and bash block, not inside bash block)

---

## Step 1: Plan Review - Iteration 3 - 2026-03-02T23:45:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved (with 3 informational warnings — all stated "no change needed")

**Issues (informational):**
- [warning] Binary content guard placement is adequate — no structural change needed
- [warning] PYTHONPATH text is correct — flagged as common failure mode
- [warning] sqlite3.Error covers all subclasses — no change needed

**Changes Made:**
None required — all warnings were informational acknowledgments of existing plan content.

---

## Step 1: Plan Review - Iteration 4 - 2026-03-02T23:50:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved (zero issues)

**Issues:**
None.

**Changes Made:**
- Added implementation note to binary content guard: guard runs before file modification logic
- Added common pitfall note for PYTHONPATH absolute path resolution in integration tests
- Expanded sqlite3.Error documentation to list all subclasses explicitly

---

## Step 2: Chain Review - Iteration 3 - 2026-03-03T00:15:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Phase 5 Step 5.3 relies on db.get_entity(type_id) accepting a non-UUID string — no verification pre-step

**Changes Made:**
- Added API pre-verification note to Step 5.3: read database.py to confirm get_entity() accepts type_id strings before writing code

---

## Step 2: Chain Review - Iteration 4 - 2026-03-03T00:25:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Step 7.1 db.close() may not exist on EntityDatabase — API assumption unverified
- [suggestion] Phase 4 checklist wording ambiguous about which tests must pass

**Changes Made:**
- Expanded Step 7.1 DB teardown to list three fallback options (close, context manager, gc.collect) with pre-verification note
- Reworded Phase 4 checklist items to distinguish frontmatter tests from pre-existing entity_registry regression tests

---

## Step 2: Chain Review - Iteration 5 (cap) - 2026-03-03T00:35:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (cap reached with 2 warnings)

**Issues (unresolved at cap):**
- [warning] Step 5.3 API pre-verification lacks fallback instruction if get_entity() only accepts UUID
- [warning] Step 7.1 DB teardown pre-verification leaves choice open mid-implementation

**Changes Made:**
Cap reached — concerns noted in .meta.json phaseReview.reviewerNotes.

---

## Task Review Iteration 1 - 2026-03-03T01:00:00+08:00

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 5.1.2: Done criterion has no binary verification command -> Add specific import check command and restructure to TDD (stubs first, tests in 5.2.1, implement in new 5.2.2)
- [blocker] Task 5.3.1: References undefined 'implementation-log' path -> Replace with grep commands for binary verification
- [blocker] Task 5.3.3: Done criterion 'exits gracefully on error paths' is subjective -> Add specific shell commands with expected exit codes
- [warning] Summary: Falsely claims Phase 1 tasks are parallelizable when 1.1.2 depends on 1.1.1 -> Remove false parallel claim, update count to 1
- [warning] Task 5.2.1: Tests written after implementation breaks TDD consistency -> Restructured: 5.1.2 creates stubs, 5.2.1 writes tests (RED), new 5.2.2 implements (GREEN)
- [warning] Task 7.5: AC verification is manual cross-reference with no command -> Add grep command for AC comment markers
- [warning] Task 7.1.1: Cross-task dependency on 5.3.2 not inline -> Added inline teardown options with reference to 5.3.2

**Changes Made:**
- Task 5.1.2: Changed to stub-only implementation with import verification command
- Added Task 5.2.2 for full helper implementation (GREEN phase) with pytest command
- Task 5.2.1: Renamed to include (RED), updated done criterion for RED phase
- Task 5.3.1: Replaced with grep-based verification commands
- Task 5.3.3: Added specific shell commands with expected exit codes
- Task 7.1.1: Inlined teardown options (close/with/del) with 5.3.2 reference
- Task 7.5: Added grep command for AC coverage verification
- Summary: Changed parallel groups from 2 to 1, removed false Phase 1 claim
- Dependency graph: Updated Phase 5 to include 5.2.2 in chain
- Total tasks: Updated from 35 to 36

---

## Task Review Iteration 2 - 2026-03-03T01:10:00+08:00

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 5.3.1: grep for _resolve_identifier matches its own definition, not get_entity's delegation chain -> Replace with `grep -A 10 "def get_entity" | grep "_resolve_identifier"` to confirm body delegation
- [blocker] Task 5.3.2: No artifact target for "document" step; done-when is non-binary -> Specify output as comment in test_frontmatter.py with method name and line number
- [blocker] Task 4.1.3: No test enforcing structural constraint that write_frontmatter must not call read_frontmatter -> Add structural independence test to Task 4.1.2 (patch read_frontmatter to raise AssertionError)
- [warning] Task 2.1.1: "valid UUID (uppercase input)" is ambiguous -> Renamed to specify uppercase hex in entity_uuid dict value
- [warning] Task 3.1.2: FileNotFoundError handling could be confused with write's re-raise pattern -> Added explicit note: catch, log warning, return None; do NOT re-raise
- [warning] Task 7.1.1: PYTHONPATH value not specified for subprocess invocation -> Added Path(__file__).parent.parent derivation with explanation
- [warning] Task 5.1.1: Done-when conflates import success with usage output, wrong interpreter -> Pinned to plugins/iflow/.venv/bin/python with explicit no-ImportError criterion
- [warning] Task 4.1.1: Merge tests lack concrete setup/verify instructions -> Added pre-write + re-write pattern with specific field assertions

**Changes Made:**
- Task 5.3.1: Replaced second grep with `grep -A 10 "def get_entity" | grep "_resolve_identifier"`
- Task 5.3.2: Added comment block output target in test_frontmatter.py with method name + line number
- Task 4.1.2: Added 6th test case (structural independence via patching read_frontmatter), updated count 5→6
- Task 2.1.1: Renamed test case to specify uppercase hex in entity_uuid dict value
- Task 3.1.2: Added explicit note about non-raising behavior vs write's re-raise pattern
- Task 7.1.1: Added PYTHONPATH = str(Path(__file__).parent.parent) with path explanation
- Task 5.1.1: Changed done-when to pin correct interpreter path with no-ImportError criterion
- Task 4.1.1: Added concrete pre-write + re-write patterns with specific field assertions for merge tests

---
