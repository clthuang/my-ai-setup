# Review History: 002-markdown-entity-file-header-sc

## Step 1: Spec-Reviewer Review - Iteration 1 - 2026-03-02T18:15:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [factual-error] C1 YAML library constraint is wrong — `yaml` is NOT in Python stdlib; PyYAML is third-party. Creates ambiguous dual-path implementation. (at: C1)
  Suggestion: Mandate the minimal parser as the sole implementation path since schema is flat key-value only.
- [blocker] [contradiction] R14 and AC-16 contradict — R14 says mismatched entity_uuid files "get headers written" (overwrite), AC-16 says mismatched UUID raises ValueError. (at: R14, AC-16)
  Suggestion: Align R14 with AC-16: mismatched entity_uuid raises ValueError, only files WITHOUT frontmatter get new headers.
- [blocker] [unspecified-mechanism] R12 references commitAndComplete as if it's a callable Python function, but it's pseudocode in a SKILL.md. Integration mechanism is unspecified. (at: R12)
  Suggestion: Specify actual mechanism — a shell command step in the SKILL.md pseudocode that invokes a Python CLI script, or a PostToolUse hook.
- [warning] [test-gap] AC-12 integration test lacks fixture specification — how to set up entity registry state and trigger commitAndComplete in test. (at: AC-12)
  Suggestion: Add test fixture specification or mark as manual verification.
- [warning] [underspecified] R13 DB path and type_id resolution mechanisms unspecified — how does integration code find the DB and construct the type_id? (at: R13)
  Suggestion: Specify DB path resolution (env var or known path) and type_id construction from .meta.json fields.
- [warning] [ambiguity] R9/R14/AC-16 replace semantics unclear when existing frontmatter has same UUID but different optional fields. (at: R9, R14)
  Suggestion: Clarify: same UUID → merge/update optional fields; different UUID → raise ValueError.
- [warning] [enforcement-gap] R5 field ordering only enforceable on write, not on read-write cycles if external tools reorder. (at: R5, C4)
  Suggestion: Clarify R5 is write-time only; C4 round-trip fidelity compares values not field order.
- [warning] [traceability] PRD traceability is indirect (PRD → roadmap → feature 002), not direct. (at: PRD Traceability)
  Suggestion: Acknowledge the indirect chain explicitly.

**Changes Made:**
- C1: Mandated minimal custom parser as sole implementation, removed PyYAML reference
- R14: Aligned with AC-16 — mismatched UUID raises ValueError, no overwrite
- R12: Specified CLI script (`frontmatter_inject.py`) invoked in SKILL.md pseudocode
- AC-12: Added subprocess.run + ENTITY_DB_PATH test fixture setup
- R13: Specified ENTITY_DB_PATH env var + fallback path for DB resolution
- R9: Clarified same-UUID merge behavior, different-UUID raises ValueError
- R5: Clarified write-time only convention
- PRD traceability: Acknowledged indirect chain (PRD → roadmap → feature 002)

---

## Step 1: Spec-Reviewer Review - Iteration 2 - 2026-03-02T18:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] C1 custom parser split semantics ambiguous — does not specify split on FIRST `: ` occurrence vs all. Two implementers could produce incompatible parsers. (at: C1)
  Suggestion: Specify split on FIRST `: ` occurrence, key matches `^[a-z_]+`, value is remainder after first `: `, non-matching lines silently ignored.
- [blocker] [testability] R9/R11 interaction — write_frontmatter merge preserves unknown keys, but validate_header rejects unknown fields. Spec must state whether write_frontmatter validates before writing. (at: R9, R11)
  Suggestion: Explicitly state whether write_frontmatter calls validate_header before writing or trusts the caller.
- [warning] [assumptions] C2 os.rename() atomicity assumes POSIX. Not stated explicitly. (at: C2)
  Suggestion: Add explicit POSIX platform assumption.
- [warning] [assumptions] R8/R13/R15 logging mechanism inconsistent — no standard defined. (at: R8, R13, R15)
  Suggestion: Standardize on Python stdlib `logging` module for library, `print(stderr)` for CLI.
- [warning] [testability] AC-9 atomic write verification method unspecified. (at: AC-9)
  Suggestion: Specify mock-based or code review verification.
- [warning] [assumptions] R12 plugin_root resolution in SKILL.md context not specified. (at: R12)
  Suggestion: Specify two-location Glob pattern and plugin venv Python interpreter.
- [warning] [scope] R4 updated_at — ambiguous whether caller-managed or module-managed. (at: R4, R9, R10)
  Suggestion: State explicitly whether write_frontmatter auto-sets updated_at on updates.
- [warning] [clarity] entity_type_id (frontmatter) vs type_id (DB) naming inconsistency not mapped. (at: R3, R13)
  Suggestion: Add field mapping note.
- [warning] [testability] Test Strategy mentions 'binary content guard' but no requirement defines behavior. (at: Test Strategy)
  Suggestion: Add R8a binary detection requirement or remove from Test Strategy.

**Changes Made:**
- C1: Added precise split semantics — split on FIRST `: `, key matches `^[a-z_]+$`, value is remainder, non-matching lines ignored
- R9: Added explicit validation — write_frontmatter calls validate_header on merged result before writing, aborts on failure
- C2: Added explicit POSIX platform assumption, Windows not supported
- R8: Standardized logging on Python stdlib `logging` module, added binary content guard (null bytes in first 8192 bytes)
- AC-9: Specified mock-based verification of os.rename
- R12: Added two-location Glob pattern for plugin root resolution and plugin venv Python interpreter
- R4: Made updated_at explicitly caller-managed
- R13: Added entity_type_id ↔ type_id field mapping note
- Test Strategy: Referenced R8 null-byte detection for binary content guard
- AC-12: Strengthened to verify all R3 required fields
- R15: Clarified exact basename match (case-sensitive)

RESUME-FALLBACK: spec-reviewer iteration 3 — agent_id lost (context compaction)

---

## Step 1: Spec-Reviewer Review - Iteration 3 - 2026-03-02T19:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [warning] [testability] AC-9 "or by code review of the implementation" weakens testability — allows non-automated verification as substitute. (at: AC-9)
  Suggestion: Remove the code review fallback; require mock-based verification only.
- [warning] [underspecified] R13 does not specify how the CLI script accesses the DB — raw SQL, ORM, or EntityDatabase class. (at: R13)
  Suggestion: Specify EntityDatabase instantiation as the DB access method.
- [warning] [ambiguity] R8 "malformed frontmatter" is undefined — does an empty block between `---` delimiters count as malformed? (at: R8)
  Suggestion: Define precisely: only a missing closing `---` is malformed; an empty block is valid (returns empty dict).
- [warning] [assumptions] R12 fail-open clause doesn't cover case where plugin venv Python interpreter doesn't exist. (at: R12)
  Suggestion: Add explicit note that non-zero exit (including missing interpreter) triggers fail-open.
- [warning] [ambiguity] AC-13 "exits with code 0 or logs a warning" — ambiguous whether both or either is required. (at: AC-13)
  Suggestion: Make unambiguous: exit code 0 AND warning logged to stderr.

**Changes Made:**
- AC-9: Removed "or by code review of the implementation" fallback — mock-based verification only
- R13: Specified EntityDatabase instantiation from entity_registry package as DB access method
- R8: Clarified malformed frontmatter — only missing closing `---` is malformed; empty block is valid
- R12: Added explicit venv-missing note in fail-open clause
- AC-13: Changed to unambiguous "exits with code 0 and logs a warning to stderr"

---

## Step 2: Phase Review - Iteration 1 - 2026-03-02T19:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [implementation-leakage] Spec embeds implementation decisions (function signatures, regex, parser algorithm, CLI format) that belong in design. (at: R7-R15, C1-C4)
  Suggestion: Add a Design Constraints section documenting which decisions are locked vs open.
- [warning] [problem-statement] Problem statement is multi-sentence and blends problem with PRD traceability. (at: Problem Statement)
  Suggestion: Condense to one sentence; move traceability to separate subsection.

**Changes Made:**
- Problem Statement: Condensed to single sentence; moved traceability to separate subsection
- Added "Design Constraints (Locked Decisions)" section listing all locked implementation decisions and what remains open for design

---

## Step 2: Phase Review - Iteration 2 - 2026-03-02T19:45:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [underspecified] R9 merge semantics gap — what happens when optional field is passed as None/empty string. (at: R9)
  Suggestion: Specify explicit deletion semantics for None/empty values.
- [warning] [ambiguity] R8 empty dict vs None distinction for callers — no guidance on how to interpret each. (at: R8)
  Suggestion: Document that empty dict means "block found, no parseable lines" vs None means "no block found".

**Changes Made:**
- R9: Added explicit deletion semantics — keys with None or empty string values are removed from merged header
- R8: Added empty dict vs None distinction documentation for callers

---

## Step 2: Phase Review - Iteration 3 - 2026-03-02T20:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [test-gap] R9 deletion semantics has no acceptance criteria coverage. (at: R9, AC section)
  Suggestion: Add AC-17 covering None deletion case.
- [warning] [ambiguity] R8 EOF edge case for unclosed frontmatter not explicitly stated. (at: R8)
  Suggestion: Clarify that opening `---` with no closing `---` anywhere in file (block extends to EOF) is malformed.

**Changes Made:**
- Added AC-17: write_frontmatter with None value removes field from frontmatter
- R8: Added EOF clarification — block extending to EOF is malformed

---

## Step 2: Phase Review - Iteration 4 - 2026-03-02T20:15:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] [test-gap] AC-17 only covers None, not empty string — R9 specifies both as deletion triggers. (at: AC-17, R9)
  Suggestion: Add AC-18 for empty string deletion case.
- [warning] [inconsistency] Test Strategy range "AC-14 through AC-16" doesn't include new AC-17. (at: Test Strategy)
  Suggestion: Extend range to "AC-14 through AC-18".

**Changes Made:**
- Added AC-18: write_frontmatter with empty string value removes field from frontmatter
- Test Strategy: Extended range from "AC-14 through AC-16" to "AC-14 through AC-18"

---

## Step 2: Phase Review - Iteration 5 - 2026-03-02T20:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (cap reached — proceeding with warning)

**Issues:**
- [warning] [fragile-coupling] R13 references `_resolve_identifier` (a private method) — fragile coupling to internal API. (at: R13)
  Suggestion: Document stability or rename to remove underscore prefix.
- [warning] [ambiguity] Exact insertion point within commitAndComplete step is ambiguous. (at: R12, Scope Boundary item 4)
  Suggestion: Add one sentence clarifying insertion position.
- [suggestion] AC-12 doesn't specify test DB state setup. (at: AC-12)
  Suggestion: Make pre-registered entity explicit in AC.

**Changes Made:**
- Cap reached (5/5). Concerns stored in .meta.json phaseReview.reviewerNotes. Proceeding to auto-commit.

---
