# Review History: 002-markdown-entity-file-header-sc

## Step 1: Spec-Reviewer Review - Iteration 1 - 2026-03-02T18:15:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [factual-error] C1 YAML library constraint is wrong — `yaml` is NOT in Python stdlib; PyYAML is third-party. Creates ambiguous dual-path implementation. (at: C1)
  Suggestion: Mandate the minimal parser as the sole implementation path since schema is flat key-value only.
- [blocker] [contradiction] R14 and AC-16 contradict — R14 says mismatched entity_uuid files "get headers written" (overwrite), AC-16 says mismatched UUID raises ValueError. (at: R14, AC-16)
  Suggestion: Align R14 with AC-16: mismatched entity_uuid raises ValueError, only files WITHOUT frontmatter get new headers.
- [blocker] [unspecified-mechanism] R12 references commitAndComplete as if it's a callable Python function, but it's pseudocode in a SKILL.md. Integration mechanism is unspecified. (at: R12)
  Suggestion: Specify actual mechanism — a shell command step in the SKILL.md pseudocode that invokes a Python CLI script, or a PostToolUse hook.
- [warning] [test-gap] AC-12 integration test lacks fixture specification — how to set up entity registry state and trigger commitAndComplete in test. (at: AC-12)
  Suggestion: Add test fixture specification or mark as manual verification.
- [warning] [underspecified] R13 DB path and type_id resolution mechanisms unspecified — how does integration code find the DB and construct the type_id? (at: R13)
  Suggestion: Specify DB path resolution (env var or known path) and type_id construction from .meta.json fields.
- [warning] [ambiguity] R9/R14/AC-16 replace semantics unclear when existing frontmatter has same UUID but different optional fields. (at: R9, R14)
  Suggestion: Clarify: same UUID → merge/update optional fields; different UUID → raise ValueError.
- [warning] [enforcement-gap] R5 field ordering only enforceable on write, not on read-write cycles if external tools reorder. (at: R5, C4)
  Suggestion: Clarify R5 is write-time only; C4 round-trip fidelity compares values not field order.
- [warning] [traceability] PRD traceability is indirect (PRD → roadmap → feature 002), not direct. (at: PRD Traceability)
  Suggestion: Acknowledge the indirect chain explicitly.

**Changes Made:**
- C1: Mandated minimal custom parser as sole implementation, removed PyYAML reference
- R14: Aligned with AC-16 — mismatched UUID raises ValueError, no overwrite
- R12: Specified CLI script (`frontmatter_inject.py`) invoked in SKILL.md pseudocode
- AC-12: Added subprocess.run + ENTITY_DB_PATH test fixture setup
- R13: Specified ENTITY_DB_PATH env var + fallback path for DB resolution
- R9: Clarified same-UUID merge behavior, different-UUID raises ValueError
- R5: Clarified write-time only convention
- PRD traceability: Acknowledged indirect chain (PRD → roadmap → feature 002)

---

## Step 1: Spec-Reviewer Review - Iteration 2 - 2026-03-02T18:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] C1 custom parser split semantics ambiguous — does not specify split on FIRST `: ` occurrence vs all. Two implementers could produce incompatible parsers. (at: C1)
  Suggestion: Specify split on FIRST `: ` occurrence, key matches `^[a-z_]+`, value is remainder after first `: `, non-matching lines silently ignored.
- [blocker] [testability] R9/R11 interaction — write_frontmatter merge preserves unknown keys, but validate_header rejects unknown fields. Spec must state whether write_frontmatter validates before writing. (at: R9, R11)
  Suggestion: Explicitly state whether write_frontmatter calls validate_header before writing or trusts the caller.
- [warning] [assumptions] C2 os.rename() atomicity assumes POSIX. Not stated explicitly. (at: C2)
  Suggestion: Add explicit POSIX platform assumption.
- [warning] [assumptions] R8/R13/R15 logging mechanism inconsistent — no standard defined. (at: R8, R13, R15)
  Suggestion: Standardize on Python stdlib `logging` module for library, `print(stderr)` for CLI.
- [warning] [testability] AC-9 atomic write verification method unspecified. (at: AC-9)
  Suggestion: Specify mock-based or code review verification.
- [warning] [assumptions] R12 plugin_root resolution in SKILL.md context not specified. (at: R12)
  Suggestion: Specify two-location Glob pattern and plugin venv Python interpreter.
- [warning] [scope] R4 updated_at — ambiguous whether caller-managed or module-managed. (at: R4, R9, R10)
  Suggestion: State explicitly whether write_frontmatter auto-sets updated_at on updates.
- [warning] [clarity] entity_type_id (frontmatter) vs type_id (DB) naming inconsistency not mapped. (at: R3, R13)
  Suggestion: Add field mapping note.
- [warning] [testability] Test Strategy mentions 'binary content guard' but no requirement defines behavior. (at: Test Strategy)
  Suggestion: Add R8a binary detection requirement or remove from Test Strategy.

**Changes Made:**
- C1: Added precise split semantics — split on FIRST `: `, key matches `^[a-z_]+$`, value is remainder, non-matching lines ignored
- R9: Added explicit validation — write_frontmatter calls validate_header on merged result before writing, aborts on failure
- C2: Added explicit POSIX platform assumption, Windows not supported
- R8: Standardized logging on Python stdlib `logging` module, added binary content guard (null bytes in first 8192 bytes)
- AC-9: Specified mock-based verification of os.rename
- R12: Added two-location Glob pattern for plugin root resolution and plugin venv Python interpreter
- R4: Made updated_at explicitly caller-managed
- R13: Added entity_type_id ↔ type_id field mapping note
- Test Strategy: Referenced R8 null-byte detection for binary content guard
- AC-12: Strengthened to verify all R3 required fields
- R15: Clarified exact basename match (case-sensitive)

RESUME-FALLBACK: spec-reviewer iteration 3 — agent_id lost (context compaction)

---
