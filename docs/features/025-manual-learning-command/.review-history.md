# Review History

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-21T01:40:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] Feasibility section overstates what is already implemented vs. what requires code changes for the confidence parameter on store_memory (at: Feasibility Assessment, Key Assumptions)
  Suggestion: Distinguish between 'schema supports it' (true) and 'API already exposes it' (false)
- [blocker] [testability] SC-4's 40% injection cap has no specified enforcement mechanism — could be passive monitoring or active pipeline constraint (at: Success Criteria SC-4)
  Suggestion: Clarify whether enforcement is organic via confidence-based ranking demotion or requires pipeline modification
- [blocker] [testability] AC-2's '<10 characters of meaningful content' threshold is ambiguous (at: Acceptance Criteria AC-2)
  Suggestion: Replace with concrete, deterministic rule using stripped input string length
- [warning] [assumptions] AC-3 does not acknowledge that content_hash is exact-match-after-normalization, not semantic similarity (at: AC-3)
  Suggestion: Add note clarifying content_hash is whitespace/case-normalized exact match
- [warning] [traceability] No acceptance criterion tests the <60 character name constraint or defines overflow behavior (at: AC-1)
  Suggestion: Add truncation rule for generated names exceeding 60 characters
- [warning] [testability] AC-11 trigger patterns are inherently LLM-judgment-based and not deterministically testable (at: AC-11)
  Suggestion: Reframe as documentation/content criterion about skill artifact content
- [warning] [scope] Model-initiated capture fallback when MCP is unavailable is unaddressed (at: AC-4, AC-5)
  Suggestion: Add acceptance criterion for model-initiated capture CLI fallback
- [warning] [clarity] Dependencies section understates store_memory changes needed (at: Dependencies)
  Suggestion: Clarify both confidence param addition and /remember passing confidence=low
- [warning] [testability] SC-5 cannot distinguish user-initiated vs model-initiated captures (at: SC-5)
  Suggestion: Accept combined measurement or add distinguishing field

**Changes Made:**
- Feasibility section reworded to distinguish schema support (verified) from API exposure (requires one-line change)
- SC-4 clarified as organic enforcement via confidence-based ranking demotion with monitoring SQL
- AC-2 threshold changed to 20 characters measured on stripped input string
- AC-3 note added about content_hash being exact-match-after-normalization
- AC-1 name constraint clarified with truncation rule
- AC-11 reframed as documentation/content criterion about skill artifact content
- AC-13 added for model-initiated capture CLI fallback when MCP unavailable
- Dependencies section clarified with both changes needed for store_memory
- SC-5 reworded to explicitly cover combined user+model captures
- SC-1 clarified that embedding may occur asynchronously after confirmation
- AC-10 session-start hint given exact text and placement
- Configuration Keys section added with key names, values, defaults, descriptions

---

## Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-21T01:50:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved

**Issues (addressed post-approval for polish):**
- [warning] [assumptions] AC-3 dedup hash ambiguity — unclear if user raw text or model-generated description is hashed
  Resolved: Clarified that user's raw free-text IS the description field used for hashing
- [warning] [assumptions] AC-1 reasoning generation not explicitly noted as single inference step
  Resolved: Added note that reasoning is generated in single inference step alongside category/name
- [warning] [clarity] Command implementation type unspecified
  Resolved: Dependencies updated to specify command markdown file with model instructions
- [warning] [assumptions] Feasibility says "one-line change" but two changes needed
  Resolved: Reworded to "two changes: tool signature + _process_store_memory passthrough"
- [warning] [testability] AC-12 category inference is LLM-judgment-based
  Resolved: Added note parallel to AC-11 about heuristic nature and spot-check verification

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-21T01:55:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues (addressed post-approval for polish):**
- [warning] Problem statement is two sentences, not one
  Resolved: Condensed to single sentence
- [warning] AC-1 missing error path for reasoning generation failure
  Note: Model processes command directly; failure to generate reasoning is not a realistic scenario
- [warning] AC-8 leaks implementation detail (specific CLI path)
  Resolved: Labeled as "reference implementation" detail to distinguish from behavioral requirement
- [warning] AC-2 threshold discrepancy with PRD not called out
  Resolved: Added note explaining threshold change rationale
- [suggestion] SC-4 monitoring SQL is approximation over all-time recall
  Acknowledged: SQL is sufficient proxy for initial release
- [suggestion] AC-10 placement ambiguity between injector and session-start hook
  Resolved: Clarified as session-start hook's build_context() output

---

## Design Review - Iteration 1 - 2026-02-21T02:20:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [completeness] C2 confidence parameter plumbing lacked precise interface definitions (at: C2)
  Resolved: I2 already had exact signatures; C2 cross-references I2. Both are now consistent.
- [blocker] [completeness] C1 /remember command validation/inference rules underspecified (at: C1)
  Resolved: Expanded C1 flow with concrete validation rules, category inference signals, name truncation algorithm, description=raw input, and full fallback CLI invocation with explicit source field
- [blocker] [completeness] MCP-to-CLI fallback mechanism not concretely defined (at: C1/C3)
  Resolved: Added full fallback procedure with exact CLI command in C1 and referenced from C3
- [warning] [consistency] CLI fallback must explicitly set source='session-capture' in JSON payload (at: TD-1)
  Resolved: Fallback procedure now includes explicit source field in JSON
- [warning] [assumptions] Budget tracking without infrastructure may degrade in long conversations (at: TD-5)
  Resolved: Added expected degradation note and explicit counter statement instruction
- [warning] [completeness] Session-start hint text already specified in I4 but not cross-referenced in C4 (at: C4)
  Note: C4 includes exact bash line; I4 specifies the same
- [warning] [completeness] Config entries not fully specified in C5 (at: C5)
  Resolved: Added exact DEFAULTS dict entries and template additions with no-additional-validation note
- [warning] [feasibility] Test cases not specific enough in C6 (at: C6)
  Resolved: Added named test functions mapping to AC-9
- [warning] [consistency] Confidence immutable on upsert not documented (at: C2/database)
  Resolved: Added R3 risk noting this behavior and why it's acceptable

**Changes Made:**
- C1 expanded with detailed 9-step flow including validation rules, category inference signals, name truncation algorithm, fallback CLI invocation with explicit source='session-capture'
- C3 trigger patterns enumerated with concrete examples; budget tracking instructions clarified with explicit counter statement
- TD-5 updated with expected degradation note
- R3 added for confidence-on-upsert immutability
- C5 expanded with exact config.py and template changes
- C6 test cases named explicitly
- Build order annotated C4 as parallelizable

---

## Design Review - Iteration 2 - 2026-02-21T02:30:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] `_process_store_memory` returns same string for new and upsert, but I1 specifies different outputs ("Stored" vs "Reinforced") (at: C2/I1/I2)
  Resolved: Added existence check before upsert in C2; return differentiates "Stored:" vs "Reinforced:" with observation count. C1 step 8 updated to parse return string prefix. Two new test cases added to C6.
- [warning] [consistency] C5 DEFAULTS uses string "5" for budget but _coerce returns int 5 from config file (at: C5/I5)
  Resolved: Changed DEFAULTS to integer `5` with note about type consistency with `_coerce()`
- [warning] [completeness] Model guidance skill (C3) reads config from `iflow-dev.local.md` but model has no mechanism to read files during session (at: C3)
  Resolved: C4 now injects config values into session-start context. C3 updated to read from session context lines instead of file directly.
- [warning] [consistency] Session-start hint placed unconditionally but AC-10 has "memory injection enabled" precondition (at: C4)
  Resolved: C4 documented as unconditional with rationale — /remember and model capture use MCP directly, not the injection pipeline

**Changes Made:**
- C2 now specifies differentiated return: check `db.get_entry(entry_id)` before upsert, return "Reinforced" with observation count for existing entries
- I2 updated with differentiated return code snippet
- C1 step 8 updated to parse store_memory return string prefix
- C5/I5 DEFAULTS budget changed from string "5" to integer 5 with consistency note
- C3 updated to read config from session context (not file)
- C4 expanded to inject memory_model_capture_mode and memory_silent_capture_budget via read_local_md_field
- C4 documented as unconditional with rationale
- I4 updated with full 3-line injection including config values
- C6 added two new test cases for differentiated return
- Dependency graph updated: C4 now depends on C5
- Build order updated: C4 grouped with C3 (both depend on C2, C5)

---

## Design Review - Iteration 3 - 2026-02-21T02:40:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues (addressed post-approval for polish):**
- [warning] [consistency] C2 pre-upsert db.get_entry duplicates the post-upsert get_entry at line 106
  Note: Implementation can optimize by using post-upsert observation_count > 1 check instead
- [warning] [consistency] CLI fallback (writer.py) always returns "Stored:", never "Reinforced"
  Note: Acceptable for v1 — fallback path is rare. Entry still correctly upserted.
- [warning] [completeness] C3 skill has no defensive default for invalid config values
  Note: Will add fallback-to-ask-first instruction in skill content
- [warning] [assumptions] C4 references "line 207" which is brittle
  Note: Implementation will reference by content, not line number
- [warning] [feasibility] C6 test_duplicate_entry_returns_reinforced overlaps with existing test
  Note: Tests coexist — one verifies DB state, other verifies return value

---

## Stage 4: Handoff Review - Iteration 1 - 2026-02-21T02:45:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] C2 confidence validation detail not explicit in Components section
  Resolved: Added exact error message format and cross-reference to I2 code
- [warning] C1 steps 2-4 model-judgment nature not clarified
  Resolved: Added note that steps 2-5 are natural language instructions, model infers in single pass
- [warning] C4 injection location and shell code not precise enough in Components
  Resolved: Changed "after line 207" to "after Available commands line (reference by content)"
- [warning] I1 output variants seem not fully enumerated
  Note: I1 already lists all 4 variants (success, duplicate, too short, error). No change needed.
- [suggestion] C3/C4 co-dependency not noted in dependency graph
  Resolved: Added runtime co-dependency note to build order

**Changes Made:**
- C2 validation step expanded with exact error message and cross-reference to I2
- C2 change #2 now includes docstring update mention
- C1 flow preamble added explaining model inference nature
- C4 changed to reference content rather than line number
- Build order step 4 now notes C3/C4 runtime co-dependency

---

## Stage 4: Handoff Review - Iteration 2 - 2026-02-21T02:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues (addressed post-approval for polish):**
- [warning] Reinforced confirmation format inconsistent across I1, C1 step 8, and I2
  Resolved: Standardized I1 to "observation count incremented" matching C1 step 8
- [warning] I2 get_entry ordering change noted as plan-phase concern
  Note: Implementation detail — plan will handle control flow ordering
- [warning] Domain reviewer's 5 non-blocking warnings carried forward
  Note: Items 1, 3, 5 are acceptable implementation notes, not design gaps
- [suggestion] Existing test_duplicate_increments_observation_count may need assertion update
  Note: Plan phase will address test refactoring alongside C6

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-21T03:00:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [dependency] TDD order violation: tests (Step 3) placed after implementation (Steps 1-2) (at: Steps 1-3)
  Suggestion: Reorder to Step 1 = tests (RED), Step 2 = implementation (GREEN), Step 3 = MCP wrapper
- [blocker] [consistency] get_entry called AFTER upsert means entry always found — cannot distinguish new vs. existing (at: Step 1, change #4)
  Suggestion: Move existence check BEFORE upsert, read post-upsert state for observation_count
- [blocker] [consistency] observation_count arithmetic uses pre-upsert value + 1 which is fragile (at: Step 1, change #4)
  Suggestion: Read post-upsert state via db.get_entry for accurate incremented value
- [warning] Step 1 code snippet shows return inside embedding logic block, unclear control flow
- [warning] Step 4 verification command path assumes specific working directory
- [warning] No explicit note about existing test compatibility
- [warning] Step 5 CLI fallback command not fully specified
- [warning] Dependency graph doesn't show Step 6 depends on Steps 2-3
- [warning] No risk mitigation section
- [suggestion] Add AC coverage table
- [suggestion] Add parallelization opportunities section
- [suggestion] Add config type consistency note

**Changes Made:**
- Completely rewritten plan with corrected step order: Step 1 = tests (RED), Step 2 = core impl (GREEN), Step 3 = MCP wrapper
- Fixed get_entry ordering: existence check BEFORE upsert, post-upsert read for observation_count
- Added Risk Mitigations section addressing 6 concerns
- Added AC Coverage table mapping all 13 ACs to steps
- Added Parallelization Opportunities section
- Fixed dependency graph (Step 6 depends on Steps 2-3 and Step 4)
- Added config type consistency note in Step 4
- Added confidence immutability note in Step 2

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-21T03:10:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [tdd-order] test_new_entry_returns_stored passes with current code — not a valid RED test (at: Step 1, test 4)
  Suggestion: Replace with test that exercises NEW confidence parameter so it genuinely fails in RED
- [blocker] [failure-mode] Pre/post-upsert get_entry calls outside transaction boundary — undocumented single-connection safety assumption (at: Step 2, existence check)
  Suggestion: Add explicit safety assumption note and require implementation code comment
- [warning] [assumption] Confidence in entry dict consistent with writer CLI path — informational
- [warning] [failure-mode] Model-enforced 20-char validation is non-deterministic — accepted pattern per add-to-backlog
- [warning] [dependency] Step 6 dependencies are documentation-accuracy, not build/test dependencies
- [warning] [assumption] Config injection/skill parsing implicit contract — skill should handle absent config lines
- [warning] [feasibility] Tests in RED phase will ERROR (TypeError) not FAIL — expected-state should reflect this

**Changes Made:**
- Replaced test_new_entry_returns_stored with test_new_entry_with_confidence_returns_stored (calls with confidence="low", genuinely fails in RED)
- Updated expected-state to accurately describe TypeError errors, not assertion failures
- Added single-connection serialization safety assumption note to Step 2 with code comment requirement
- Clarified Step 6 dependencies as documentation-accuracy dependencies, not build/test
- Added config-lines-absent fallback to Step 6 skill content (default to ask-first with budget 5)
- Updated AC-2 coverage note to reflect model-enforced validation pattern

---

## Stage 1: Plan Review - Iteration 3 - 2026-02-21T03:20:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved

**Issues (addressed post-approval for polish):**
- [warning] RED phase explanation for test 5 inaccurate — fails with AssertionError not TypeError
  Resolved: Fixed expected-state to distinguish TypeError (tests 1-4) from AssertionError (test 5)
- [warning] Step 2 safety assumption code comment should mention embedding commit boundary
  Note: Implementation will include precise comment about transaction boundaries
- [warning] No test coverage for new config defaults in Step 4
  Note: Existing test_config.py tests pass; new defaults follow established pattern. Can add if needed.
- [warning] Step 7 injection location underspecified
  Resolved: Added grep patterns for precise location identification

---

## Stage 2: Chain Review - Iteration 1 - 2026-02-21T03:25:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues (addressed post-approval for polish):**
- [warning] Step 2 code snippet vs design I2 use different observation_count approaches
  Note: Plan intentionally uses post-upsert get_entry (safer). Code and prose within plan are consistent. Design I2 divergence is intentional improvement.
- [warning] Step 5 duplicates design C1 flow rather than referencing it
  Resolved: Added "see design.md C1 for authoritative details" reference
- [suggestion] Step 4 template insertion location could be more precise
- [suggestion] AC-2 verification is manual-only — noted for task creation

---

## Task Review Iteration 1 - 2026-02-21T03:35:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 1.1: test_confidence_defaults_to_medium won't ERROR — no confidence kwarg passed, DB default applies, test passes immediately → Fixed RED-phase expectations to reflect 4 of 5 non-passing
- [blocker] Task 1.3: Imprecise insertion point "before line 102" → Changed to "between entry dict closing brace (line 100) and db.upsert_entry"
- [blocker] Tasks 2.1, 2.2, 2.3: Lacking content detail → FALSE POSITIVE: actual tasks.md has full content, reviewer saw abbreviated prompt
- [warning] Task 1.1: Mixed case in description vs content_hash → Fixed to use consistent lowercase
- [warning] Task 1.2: Ambiguous line reference → Made explicit "new line after line 47"
- [warning] Task 1.5: No test coverage for new defaults → Added optional test assertion step
- [warning] Tasks 3.1-3.3: Insufficient detail → Added specific actions and Why fields
- [warning] Time estimates instead of complexity → Replaced with Simple/Medium/Complex
- [warning] No Why fields tracing to ACs → Added Why field to all tasks

**Changes Made:**
- Fixed Task 1.1 Done-when section: test 1 PASSES immediately, tests 2-4 ERROR, test 5 FAILS
- Fixed Task 1.1 description strings to lowercase for consistency
- Fixed Task 1.3 insertion point to reference entry dict closing brace
- Simplified Task 1.3 safety comment
- Added Why field to all 12 tasks tracing to specific ACs/FRs
- Added optional test assertions to Task 1.5
- Expanded Tasks 3.1-3.3 with specific actions
- Replaced Est. column with Complexity (Simple/Medium)

---

## Task Review Iteration 2 - 2026-02-21T03:40:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] Tasks 1.2, 1.3, 1.4: Fragile line-number references shift across sequential file modifications → Replaced with contextual code anchors
- [blocker] Task 1.3: TOCTOU pattern undocumented as safe-by-design → Added safety comment in code snippet
- [blocker] Task 1.3: Done-when section missing key test cross-reference → Expanded with existing test coverage notes
- [warning] Task 1.2: Confidence immutability on upsert not documented → Added note about _update_existing behavior
- [warning] Task 2.1: CLI fallback lacks input escaping note → Added escaping instruction
- [warning] Task 2.3: Line number references fragile → Replaced with content anchors
- [warning] Task 2.3: Verification command doesn't test new content → Noted but kept existing test
- [warning] Tasks 3.1, 3.2: Reference "increment counts" in non-existent summary section → Removed count instructions
- [warning] Task 3.3: References utility commands list that doesn't exist in workflow-state → Changed to no-op verification task
- [warning] Task 1.5: "Optionally" for test assertions should be mandatory → Made mandatory

**Changes Made:**
- Replaced all line-number references in Tasks 1.2, 1.3, 1.4 with contextual code anchors
- Added TOCTOU safety comment to Task 1.3 code snippet
- Expanded Task 1.3 Done-when with existing test cross-references
- Added confidence immutability note to Task 1.2
- Added input escaping note to Task 2.1 CLI fallback
- Replaced Task 2.3 line numbers with content anchors
- Removed "increment counts" from Tasks 3.1, 3.2 (README has no explicit counts)
- Changed Task 3.3 from file modification to no-op verification (workflow-state has no utility commands list)
- Changed Task 1.5 test assertions from "optionally" to mandatory

---

## Task Review Iteration 3 - 2026-02-21T03:45:00Z

**Decision:** Approved (with warnings addressed)

**Issues:**
- [warning] Task 1.1: SQL DEFAULT mechanism explanation could be clearer → Revised Done-when to explain `_insert_new()` path
- [warning] Task 1.2: Dict key order cosmetic only → No change needed (reviewer confirmed)
- [warning] Task 1.3: TOCTOU comment could be more precise → Adjusted to "single-threaded with one DB connection"
- [warning] Task 1.5: Test assertion insertion point unspecified → Added "after memory_injection_limit assert"
- [warning] Task 1.6: YAML type handling → No change needed (reviewer confirmed consistent)
- [warning] Task 2.3: Verification doesn't validate content → Added secondary python verification command

**Changes Made:**
- Task 1.1: Revised Done-when explanation to clarify SQLite DEFAULT mechanism
- Task 1.3: Adjusted safety comment to be more precise about single-threaded context
- Task 1.5: Specified exact insertion point for test assertions
- Task 2.3: Added secondary content verification command

---

## Stage 2: Chain Review - Iteration 1 - 2026-02-21T03:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (1 warning, 2 suggestions)

**Issues:**
- [warning] Task 1.1 Done-when mechanism explanation could be more explicit about _insert_new omitting column
  Resolved: Expanded explanation to mention _insert_new omitting the column and SQLite DEFAULT constraint
- [suggestion] Task 1.3 diverges from design I2 observation_count approach (post-upsert read vs pre-upsert compute)
  Note: Intentional refinement documented in plan; both equivalent in single-threaded context
- [suggestion] Tasks 3.1/3.2 don't mention count summaries
  Note: Verified README files have no explicit count numbers — no action needed

**Changes Made:**
- Task 1.1 Done-when expanded with precise _insert_new/DEFAULT mechanism

---

## Implementation Review - Iteration 1 - 2026-02-21T04:30:00Z

**Implementation Review:** Approved
  - Level 1 (Tasks): pass
  - Level 2 (Spec): pass
  - Level 3 (Design): pass
  - Level 4 (PRD): pass
**Quality Review:** Approved
**Security Review:** Approved

**Issues:**
- [warning] [tasks] implementation-reviewer: README_FOR_DEV.md has no commands table — /remember command not added there (at: README_FOR_DEV.md)
  Suggestion: No action needed — file structure does not support it. Command documented in README.md.
- [warning] [design] code-quality-reviewer: Hardcoded confidence tuple ("high", "medium", "low") duplicates DB schema CHECK constraint (at: memory_server.py:67)
  Suggestion: Extract to VALID_CONFIDENCE constant matching VALID_CATEGORIES pattern.
- [suggestion] security-reviewer: CLI fallback embeds user text via natural-language escaping instructions (at: remember.md:37-41)
  Suggestion: Consider --entry-file alternative. Low risk — writer.py uses json.loads().
- [suggestion] security-reviewer: Pre-existing inline Python in session-start.sh uses string interpolation (at: session-start.sh:27)
  Suggestion: Pre-existing pattern, not introduced by this PR.

**Changes Made:**
- Extracted VALID_CONFIDENCE = frozenset({"high", "medium", "low"}) to semantic_memory/__init__.py
- Updated memory_server.py to import and use VALID_CONFIDENCE constant
- All 30 tests pass after change

---
