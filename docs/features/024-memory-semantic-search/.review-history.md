# Review History: 024-memory-semantic-search

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-20T10:30:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [testability] AC1 "30-entry test fixture" undefined — no fixture file path or programmatic construction specified
- [blocker] [assumptions] Component 1 assumes .meta.json has slug field with no fallback
- [blocker] [completeness] Config validation for memory_relevance_weight unspecified
- [blocker] [testability] ACs not measurable enough (vague thresholds)
- [blocker] [assumptions] lastCompletedPhase availability unverified

**Changes Made:**
- Added Prerequisites section verifying .meta.json field availability
- Specified explicit normalization formula for prominence_score
- Added git error handling edge cases (detached HEAD, < 3 commits)
- Made all ACs measurable with concrete thresholds

---

## Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-20T10:45:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] AC1 test fixture still not programmatically defined
- [blocker] .meta.json fallback handling incomplete
- [blocker] Config validation contract not specified
- [warning] Diagnostic output active/inactive format ambiguous
- [warning] Git keyword extraction unbounded

**Changes Made:**
- Defined programmatic 30-entry fixture (10 parser, 20 other, equal prominence)
- Added try/except for .meta.json, skip on missing fields
- Specified config validation: non-numeric or out-of-range → fallback 0.6 with stderr warning
- Clarified diagnostic active vs inactive format
- Added max 20 keywords, dotfile exclusion

---

## Stage 1: Spec-Reviewer Review - Iteration 3 - 2026-02-20T11:15:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved (0 blockers, 6 warnings, 3 suggestions)

**Issues (warnings addressed):**
- [warning] [assumptions] FTS5 availability not guaranteed — fixed: updated Prerequisites wording
- [warning] [testability] AC2 contradicts Component 3 behavioral note — fixed: reworded to test fallback consistency not byte-identical parity
- [warning] [clarity] Active feature discovery duplication not acknowledged — fixed: added note about independent Python implementation
- [warning] [testability] AC1 fixture category-balance confound — fixed: all entries same category, parser entries lower prominence
- [warning] [assumptions] Git fallback chain ambiguous for <2 commits — fixed: explicit chain HEAD~3 → HEAD~1 → empty
- [warning] [clarity] Diagnostic truncation rule vague — fixed: append "..." only if exceeds 30 chars

---

## Stage 2: Phase Review - Iteration 0 - 2026-02-20T11:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 3 warnings, 2 suggestions)

**Issues (warnings addressed):**
- [warning] PRD language/domain detection mapping not explicit — fixed: added note that git file extensions serve as implicit language detection
- [warning] PRD deviation (persistent vs ephemeral index) not in Scope Boundaries — fixed: added to Out of Scope list
- [warning] Edge case for sanitized-to-empty query — fixed: treat as context_query=None, fall back to prominence
- [suggestion] Multiple active features handling — fixed: use most recently modified .meta.json
- [suggestion] AC4 benchmark verification method — accepted as manual verification during implementation review

---

## [REWORKED SPEC] Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-20T12:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] Gemini default output is 3072 dimensions, not 768. Spec must specify `output_dimensionality=768` parameter.
- [blocker] [completeness] MCP server infrastructure undefined — no server location, transport type, or registration mechanism specified.
- [blocker] [testability] AC5 keyword quality untestable — "specific to the entry content" is subjective with no objective criterion.
- [blocker] [assumptions] Local/global merge semantics ambiguous — spec says "single global database" but original system had local/global split.
- [warning] [completeness] Recency decay function undefined — "more recent might matter more" but no formula specified.
- [warning] [assumptions] Normalisation edge cases — what happens when max score for a signal is 0 or all entries have identical scores?
- [warning] [clarity] Ambiguous dual-write strategy in D9 — "both the SQLite database AND markdown files" needs to be definitive, not optional.
- [warning] [completeness] Missing metadata table for provider tracking — no mechanism to detect embedding provider changes.
- [warning] [clarity] Timeout budget allocation unclear — "within 3-second timeout" but no specific budget for the semantic pipeline.
- [warning] [completeness] Context query composition undefined — D2 references "context query" but no template or formula given.
- [warning] [assumptions] numpy dependency management — spec says pip but project uses uv/pyenv.
- [warning] [completeness] Reasoning field enforcement gap — D6 MCP tool should require reasoning field.

**Changes Made:**
- Fixed Gemini dimensionality: specified `output_dimensionality=768` parameter in D4
- Added MCP server details: Python stdio server at `plugins/iflow-dev/mcp/memory-server.py`, registered in `.mcp.json`
- Made AC5 testable: added generic stopword list, required 3+ content-specific keywords
- Clarified single global DB with `source_project` tracking origin (no local/global split)
- Added hyperbolic recency decay formula: `1.0 / (1.0 + days_since_updated / 30.0)` with 30-day half-life
- Added normalisation edge cases: max=0 → weight redistributed; identical scores → all normalised to 1.0
- Made D9 definitively dual-write (both SQLite AND markdown)
- Added `_metadata` table to D1 for provider/model/dimensions/schema_version tracking
- Specified 2-second budget for semantic pipeline within 3-second timeout
- Added full context query template with signal sources in D2
- Changed all pip references to uv/pyenv
- Made reasoning field required in D6 MCP tool interface

---

## [REWORKED SPEC] Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-20T12:30:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] Missing Gemini `taskType` parameter — RETRIEVAL_DOCUMENT for write, RETRIEVAL_QUERY for query
- [blocker] [assumptions] Missing L2 normalization for 768-dimension embeddings (Gemini requires it for sub-3072)
- [blocker] [assumptions] No API key configuration mechanism for embedding providers
- [warning] [testability] AC1 depends on third-party embedding quality, not reproducible
- [warning] [assumptions] Pure-Python cosine similarity over 10K x 768 would exceed 2-second budget
- [warning] [clarity] Content hash deduplication semantics (description-only vs multi-field) unclear
- [warning] [scope] D9 dual-write divergence — no reconciliation strategy
- [warning] [assumptions] Git diff fallback for shallow history (<3 commits) unspecified
- [warning] [traceability] Recency uses `updated_at` which re-embedding resets artificially
- [warning] [clarity] Category-balanced fill is undocumented behavior change from current system
- [warning] [testability] AC5 "derived from" is subjective, not mechanically verifiable
- [warning] [assumptions] MCP server registration location unclear (project root vs plugin-level .mcp.json)

**Changes Made:**
- Added Gemini taskType: RETRIEVAL_DOCUMENT (write) and RETRIEVAL_QUERY (query) to D4
- Added L2 normalization requirement for all embeddings in D4
- Added API key config via environment variables (GEMINI_API_KEY, VOYAGE_API_KEY, OPENAI_API_KEY) in D4
- Added AC1b unit test with pre-computed embeddings isolating ranking from embedding quality
- Changed pure-Python fallback: vector retrieval skipped entirely when numpy unavailable (keyword + prominence only)
- Specified content hash normalization formula matching current memory.py
- Clarified D9: SQLite is source of truth, markdown is append-only audit trail, D7 import rebuilds from markdown
- Added git diff fallback chain for shallow history (HEAD~3 → HEAD~1 → skip)
- Specified `updated_at` only updates on content changes/retro observations, NOT re-embedding
- Acknowledged category fill behavior change from priority-based to relevance-based in D3
- Tightened AC5: substring or morphological variant (mechanically verifiable)
- Clarified MCP registration in project root `.mcp.json` with JSON entry shape
- Added configuration defaults note
- Clarified AC9 precision (up to 10K entries, p95 over 10 runs)

---

## [REWORKED SPEC] Stage 1: Spec-Reviewer Review - Iteration 3 - 2026-02-20T13:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved (0 blockers, 6 warnings, 3 suggestions)

**Issues:**
- [warning] [assumptions] MTEB 68.32 score not independently verifiable from Gemini API docs
- [warning] [assumptions] Gemini free tier rate limits undocumented; bulk import/migration could hit 429
- [warning] [testability] AC9 network latency not a controlled variable, not reproducible across environments
- [warning] [clarity] D5 auto mode tier order implicit; keyword generation prompt unspecified
- [warning] [traceability] Content recency (updated_at) vs recall recency (last_recalled_at) could be confused
- [warning] [assumptions] Concurrent SQLite writes from MCP and retro — WAL mode not specified

**Changes Made:**
- Removed unverifiable MTEB score from D4
- Added HTTP 429 handling: pause re-embedding, resume at next retro
- Split AC9 into controllable local computation (<100ms mock) and best-effort end-to-end (<2s)
- Added auto mode tier order explanation and noted keyword prompt deferred to design
- Explicitly labeled recency (content) vs recall frequency in D3 prominence breakdown
- Added WAL journal mode and busy_timeout=5000 to Technical Constraints

---

## [REWORKED SPEC] Stage 1: Spec-Reviewer Review - Iteration 4 - 2026-02-20T13:30:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision (4 blockers, 5 warnings — several false positives identified)

**Issues (valid, addressed):**
- [warning] [completeness] D5 keyword generation tier lacks timeout specs → Added 5-second timeout per tier, non-blocking note
- [warning] [clarity] Empty context query could waste API call → Explicitly skip API call when context is None
- [warning] [testability] AC9 contradicts Technical Constraints on hard vs best-effort timeout → Clarified 3-second is hard kill, 2-second is target

**Issues (false positives, not addressed):**
- [blocker] L2 normalization "already normalized" — spec already states normalizing pre-normalized vectors is a no-op
- [blocker] AC1 reproducibility — already addressed in iteration 3 with AC1b unit test
- [blocker] Scope mismatch with PRD phases — user explicitly rejected phased approach in brainstorm session
- [blocker] D5 keyword generation error handling — overspecified for spec level; deferred to design
- [warning] MCP registration in .mcp.json — manually maintained in this codebase, not auto-generated

**Changes Made:**
- Added 5-second timeout per keyword generation tier, non-blocking failures
- Explicit None handling for empty context query: skip API call, prominence-only ranking
- Clarified 3-second timeout as hard kill in Technical Constraints, 2-second as target budget

---

## [REWORKED SPEC] Stage 1: Spec-Reviewer Review - Iteration 5 - 2026-02-20T14:00:00Z

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved (0 blockers, 2 warnings, 1 suggestion)

**Issues:**
- [warning] [testability] AC9(a) mock embedding definition imprecise → Fixed: random float32 (10000,768), pre-normalized
- [warning] [clarity] D2 FTS5 behavior when context_query=None unclear → Fixed: skip both vector and FTS5
- [suggestion] [clarity] D4 L2 normalization detection — spec already says "no-op for pre-normalized", accepted as-is

**Changes Made:**
- Specified mock embedding definition for AC9(a)
- Clarified both vector AND FTS5 skipped when context_query=None

---

## [REWORKED SPEC] Stage 2: Phase Review - Iteration 0 - 2026-02-20T14:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 4 warnings, 3 suggestions)

**Issues:**
- [warning] Problem statement multi-sentence (reviewer: "clear and testable")
- [warning] Implementation detail depth constrains design (reviewer: "quality observation, not a blocker")
- [warning] AC format narrative not Given/When/Then (reviewer: "unambiguous")
- [warning] No Open Questions section

**Changes Made:**
- Added Open Questions section listing deferred items (keyword prompt, BLOB serialization)
- Other warnings are format preferences, spec content is unambiguous per reviewer's own assessment

---

## [REWORKED SPEC] Stage 2: Phase Review - Iteration 1 - 2026-02-20T15:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved (0 blockers, 0 warnings, 0 suggestions)

**Summary:** Spec is complete and ready for design. All requirements clearly defined with measurable acceptance criteria, scope boundaries explicit, technical constraints specified, open questions documented.

---
