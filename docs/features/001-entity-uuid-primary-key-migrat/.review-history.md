# Review History: 001-entity-uuid-primary-key-migrat

## Step 1: Spec-Reviewer Review - Iteration 1 - 2026-03-01T22:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [contradiction] R26 raises ValueError vs AC-11 returns None — contradictory error handling semantics (at: R26, AC-11)
  Suggestion: Clarify per-method error handling — get_entity catches ValueError, others propagate
- [blocker] [missing-requirement] set_parent() must update both parent_type_id and parent_uuid atomically (at: R16)
  Suggestion: Add explicit requirement and AC for dual-column update
- [blocker] [logic-error] register_entity() INSERT OR IGNORE: freshly generated UUID returned but never stored on duplicate (at: R13, C6)
  Suggestion: Add requirement to query existing UUID on duplicate detection
- [blocker] [unjustified-assertion] R31 claims no backfill changes without analysis (at: R31)
  Suggestion: Add explicit analysis of why backfill works unchanged
- [warning] [traceability] No PRD traceability chain documented (at: Problem Statement)
  Suggestion: Add PRD section reference
- [warning] [safety] executescript() auto-commits — breaks transactional migration safety (at: R8)
  Suggestion: Specify conn.execute() instead of executescript()
- [warning] [completeness] Internal CTE queries need explicit enumeration (at: R21)
  Suggestion: List each CTE that needs uuid/parent_uuid migration
- [warning] [testability] AC-25 needs specific verification method (at: AC-25)
  Suggestion: Specify capture-compare approach
- [warning] [testability] AC-7 needs separate INSERT and UPDATE test cases (at: AC-7)
  Suggestion: Split into AC-7a and AC-7b
- [warning] [ambiguity] R20 is vague — which methods change return type? (at: R20)
  Suggestion: Enumerate each method's before/after return type
- [warning] [assumption] C4 idempotency relies on schema_version check — not documented (at: C4)
  Suggestion: Document detection mechanism

**Changes Made:**
- Added PRD traceability paragraph to Problem Statement
- R8: Specified conn.execute() not executescript() for transactional safety
- R12: Split into separate INSERT and UPDATE triggers
- R16: Added "updates BOTH parent_type_id and parent_uuid columns atomically"
- R20: Enumerated each method's return type change explicitly
- R21: Listed specific CTEs (set_parent, get_lineage, _export_tree)
- R22a: Added duplicate handling requirement for register_entity()
- R23: Added lowercase normalization before regex matching
- R26: Documented per-method error handling (get_entity catches, others propagate)
- R31: Added explicit analysis of why backfill works unchanged
- AC-7: Split into AC-7a (INSERT) and AC-7b (UPDATE)
- AC-11: Clarified get_entity catches ValueError
- AC-12: Added dual-column update verification
- AC-15a: Added duplicate detection returns existing UUID
- AC-18: Specified conn.execute() not executescript()
- AC-25: Added verification method (capture-compare)
- AC-27: Expanded to specific test scenarios
- AC-28, AC-29: Added set_parent atomicity criteria
- C3: Added input normalization
- C4: Documented schema_version detection mechanism
- C5: Documented pragma persistence mechanism

---

## Step 1: Spec-Reviewer Review - Iteration 2 - 2026-03-01T22:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] R8/AC-18 transactional safety incorrect — DDL does not start implicit transactions under legacy transaction control; explicit BEGIN IMMEDIATE required (at: R8, AC-18)
  Suggestion: Specify explicit BEGIN IMMEDIATE before DDL sequence
- [blocker] [assumptions] R26 get_lineage() behavioral change undocumented — current behavior returns [] for nonexistent entities, spec changes to ValueError without documenting breaking change (at: R26, backward compatibility)
  Suggestion: Preserve current [] behavior by catching ValueError internally
- [warning] [clarity] R21 doesn't address root-finding query in export_lineage_markdown(type_id=None) — needs uuid for CTE starting points (at: R21)
  Suggestion: Add root-finding query to R21 enumeration
- [warning] [traceability] R33 render_tree() internal changes not enumerated — by_id dict, children map, root parameter all need uuid migration (at: R33)
  Suggestion: Expand R33 with specific internal structure changes
- [warning] [testability] AC-26 "all 184 tests pass" not achievable without test updates due to R20 return value changes (at: AC-26)
  Suggestion: Reword to acknowledge test updates needed
- [warning] [clarity] R22/R22a numbering collision — separate concerns sharing same prefix (at: R22, R22a)
  Suggestion: Renumber R22a to R35
- [warning] [assumptions] C5 FK integrity after ALTER TABLE RENAME not documented (at: C5, R8)
  Suggestion: Add PRAGMA foreign_key_check verification note

**Changes Made:**
- R8: Specified explicit BEGIN IMMEDIATE transaction for DDL migration with rollback semantics
- R21: Added export_lineage_markdown() root-finding query to CTE enumeration
- R22: Added edge case note for empty/whitespace inputs
- R22a: Renumbered to R35 to avoid numbering collision
- R26: Changed get_lineage() to catch ValueError and return [] (preserving current behavior)
- R33: Expanded with specific internal data structure changes (by_id, children, root parameter)
- AC-18: Updated to specify explicit BEGIN IMMEDIATE transaction
- AC-26: Reworded to acknowledge test updates needed for behavioral changes
- C5: Added FK integrity verification via PRAGMA foreign_key_check after rename
- AC-27: Added minimum test count (10 new test functions)

---

## Step 1: Spec-Reviewer Review - Iteration 3 - 2026-03-01T23:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision (approved: true but 3 warnings under strict threshold)

**Issues:**
- [warning] [assumptions] R8 rollback placement ambiguity — unclear where try/except/rollback lives (at: R8)
  Suggestion: Clarify that migration function wraps DDL/DML in try/except with rollback before re-raise
- [warning] [clarity] R28 MCP message format scope unclear — which tools include both UUID and type_id? (at: R28)
  Suggestion: Enumerate each MCP tool's message format explicitly
- [warning] [assumptions] Python 3.16 forward-compatibility — legacy transaction control may change defaults (at: R8, C5)
  Suggestion: Add informational constraint note about Python version compatibility

**Changes Made:**
- R8: Clarified try/except/rollback placement — migration function wraps all DDL/DML, rollback before re-raise
- R28: Enumerated each MCP tool's return message format (register, set_parent, update, get_lineage, export)
- C7: Added informational constraint about Python 3.16+ autocommit behavior change

---

*--- Review counter reset by user request ---*

## Step 1: Spec-Reviewer Review - Iteration 1 (reset) - 2026-03-02T00:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] R35 cursor.lastrowid detection incorrect — retains previous value on ignored inserts
- [blocker] PRD NFR-UUID-3 (<100ms) silently dropped from spec
- [blocker] AC-26 test count weaker than PRD NFR-UUID-4
- [blocker] R8 Migration 1 executescript vs Migration 2 BEGIN IMMEDIATE interaction unclear
- [warning] AC-18 no testable rollback verification method
- [warning] R23 UUID v4 only regex strictness not documented
- [warning] R22 None input handling unspecified
- [warning] R33 root_type_id naming inconsistency
- [warning] AC-25 vague dataset specification
- [warning] R35 INSERT OR IGNORE detection mechanism unclear
- [warning] C5 FK reference update verification missing
- [warning] R31/R23 existing entity_id cannot match UUID format (not documented)

**Changes Made:**
13 fixes applied — NFR-UUID-3 justified in Non-Goals, R8 migration interaction clarified, AC-18 rollback test strategy added, R22 None input documented, R23 v4 strictness noted, R33 naming retention documented, R35 detection approach specified, AC-25 concrete scenario added, AC-26 tightened, AC-27 expanded, C5 FK check added, C8 ambiguity impossibility constraint added, R11 existing triggers retained.

---

## Step 1: Spec-Reviewer Review - Iteration 2 (reset) - 2026-03-02T00:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] R35 cursor.lastrowid == 0 is technically incorrect — lastrowid retains previous value on ignored inserts, NOT reset to 0
- [warning] C5 SQLite version requirement (>= 3.26.0) for FK reference updating is implicit
- [warning] R8 outer commit no-op needs docstring for future migration authors

**Changes Made:**
- R35: Replaced cursor.lastrowid approach with "always-SELECT" — always follow INSERT OR IGNORE with SELECT uuid FROM entities WHERE type_id = ?
- C5: Added explicit SQLite >= 3.26.0 requirement (Python 3.9+ bundles >= 3.31.0)
- R8: Added mandatory docstring requirement for Migration 2 function

---

## Step 1: Spec-Reviewer Review - Iteration 3 (reset) - 2026-03-02T01:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] AC numbering non-sequential (cosmetic)

**Changes Made:**
None required — approved.

---

## Step 2: Phase Review - Iteration 1 - 2026-03-02T01:15:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] AC-5 lacks explicit pragma persistence verification post-migration
- [warning] AC-18 outer-commit no-op assumption not explicitly tested

**Changes Made:**
- AC-5: Added PRAGMA foreign_keys returns 1 verification after migration
- AC-18: Added outer-commit no-op verification (implicit via EntityDatabase.__init__ clean completion)

---

## Step 2: Phase Review - Iteration 2 - 2026-03-02T01:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] AC numbering non-sequential (cosmetic, same as spec-reviewer)

**Changes Made:**
None required — approved.

---

## Design Review - Iteration 1 - 2026-03-02T03:45:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Migration 2 schema_version update gap — v2 schema committed but schema_version updated outside transaction; crash between causes re-run against migrated table (at: C1, I1, _migrate() interaction)
  Challenge: What happens if Migration 2 commits but schema_version update fails?
- [blocker] [feasibility] Missing idx_parent_uuid index — design claims 3 indexes but child-lookup CTEs need index on parent_uuid column, not on uuid PK (at: I9, C1 step 9)
  Challenge: How will WHERE parent_uuid = ? queries perform without dedicated index?
- [warning] [completeness] Raw SQL INSERT tests need uuid column — test_entity_type_check_constraint and test_valid_entity_types_accepted bypass API (at: C6)
  Challenge: Which tests perform raw SQL INSERTs that break due to NOT NULL uuid?
- [warning] [completeness] Pre-migration FK integrity check missing — I10 silently skips dangling parent_type_id references (at: I10 step 4)
  Challenge: What if parent_type_id references non-existent entity?
- [warning] [consistency] render_tree _render_node parameter naming confusion — type_id parameter carries UUID values post-migration (at: I7, C4)
  Challenge: Will implementer understand the semantic overloading?
- [warning] [completeness] FK references to UNIQUE columns needs explicit acknowledgment (at: I9, C1)
  Challenge: Does SQLite enforce FK to UNIQUE (non-PK) columns after rename?
- [warning] [completeness] CREATE TABLE entities_new DDL not shown explicitly (at: C1 step 3)
  Challenge: What exact DDL does the implementer write?

**Changes Made:**
- C1: Added schema_version ownership — Migration 2 updates schema_version INSIDE its transaction before COMMIT
- C1: Added pre-migration PRAGMA foreign_key_check (step 3) to validate FK integrity before migration
- C1: Added explicit CREATE TABLE entities_new DDL matching I9 schema (step 4)
- C1: Updated step count (12→14) and renumbered remaining steps
- C1: Updated index count from 3 to 4 (new idx_parent_uuid)
- I1: Updated contract to reflect schema_version ownership and atomic update
- I9: Updated index count to 4, added FK-to-UNIQUE acknowledgment, added parent_uuid nullable note
- C4: Added render_tree _render_node semantic overloading clarification
- C4: Changed _process_register_entity to construct type_id from input params (no extra DB call)
- C6: Added raw SQL INSERT test update requirement with specific test names
- I8: Updated register_entity handler to construct type_id from inputs
- Added Risk 2a for pre-existing FK violations

---

## Design Review - Iteration 2 - 2026-03-02T04:15:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (approved: true but 3 warnings under strict threshold)

**Issues:**
- [warning] [completeness] _export_tree truncation check not updated — leaf_ids extraction and child-existence check need uuid/parent_uuid (at: I6, C3)
  Challenge: What happens when _export_tree checks for children beyond max_depth using type_id columns?
- [warning] [consistency] C5 FK pragma wording misleading — SQLite >= 3.26.0 always updates FK references on rename regardless of foreign_keys pragma state (at: C5, TD-3)
  Challenge: Is PRAGMA foreign_keys = OFF actually needed for FK reference updating?
- [warning] [completeness] _process_get_lineage() 'Entity not found' error message not addressed for UUID input (at: C4)
  Challenge: What does the user see when they pass a UUID and the entity doesn't exist?

**Changes Made:**
- I6: Added _export_tree truncation check documentation — leaf_ids use row['uuid'], child check uses WHERE parent_uuid IN (...)
- C5: Added detailed note clarifying FK pragma vs FK reference updating behavior in SQLite >= 3.26.0
- C4: Added _process_get_lineage() error message handling for UUID input
- C6: Added test_self_parent_on_insert to raw SQL INSERT test list

---

## Design Review - Iteration 3 - 2026-03-02T04:30:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] [consistency] FK pragma note placed under C5 instead of TD-3 (at: C5, line 154)
- [suggestion] [complexity] I10 step 4 Python loop could be simplified to SQL UPDATE (at: I10)

**Changes Made:**
None required — approved.

---

## Handoff Review - Iteration 1 - 2026-03-02T04:45:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (approved: true but 2 warnings under strict threshold)

**Issues:**
- [warning] I10 Step 3 INSERT omits parent_uuid without explicit comment — planner may miscount columns (at: I10, Step 3)
  Suggestion: Add comment noting parent_uuid intentionally omitted, populated in Step 4
- [warning] C1 step 1 PRAGMA foreign_keys verification guard only appears in Risk 2, not in numbered step list (at: C1, step 1)
  Suggestion: Add explicit step 1b for verification and abort on failure
- [suggestion] _export_tree truncation check not listed in C3 method table (at: C3, I6)

**Changes Made:**
- C1: Added step 1b — verify PRAGMA foreign_keys returns 0 with abort guard
- I10: Added comment above Step 3 INSERT noting parent_uuid intentionally omitted
- C3: Added _export_tree() row to method table with internal change details

---

## Handoff Review - Iteration 2 - 2026-03-02T05:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] I10 pseudocode local import inconsistent with module-level convention (at: I10)

**Changes Made:**
None required — approved.

---
