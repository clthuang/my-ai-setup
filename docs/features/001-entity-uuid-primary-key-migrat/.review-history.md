# Review History: 001-entity-uuid-primary-key-migrat

## Step 1: Spec-Reviewer Review - Iteration 1 - 2026-03-01T22:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [contradiction] R26 raises ValueError vs AC-11 returns None — contradictory error handling semantics (at: R26, AC-11)
  Suggestion: Clarify per-method error handling — get_entity catches ValueError, others propagate
- [blocker] [missing-requirement] set_parent() must update both parent_type_id and parent_uuid atomically (at: R16)
  Suggestion: Add explicit requirement and AC for dual-column update
- [blocker] [logic-error] register_entity() INSERT OR IGNORE: freshly generated UUID returned but never stored on duplicate (at: R13, C6)
  Suggestion: Add requirement to query existing UUID on duplicate detection
- [blocker] [unjustified-assertion] R31 claims no backfill changes without analysis (at: R31)
  Suggestion: Add explicit analysis of why backfill works unchanged
- [warning] [traceability] No PRD traceability chain documented (at: Problem Statement)
  Suggestion: Add PRD section reference
- [warning] [safety] executescript() auto-commits — breaks transactional migration safety (at: R8)
  Suggestion: Specify conn.execute() instead of executescript()
- [warning] [completeness] Internal CTE queries need explicit enumeration (at: R21)
  Suggestion: List each CTE that needs uuid/parent_uuid migration
- [warning] [testability] AC-25 needs specific verification method (at: AC-25)
  Suggestion: Specify capture-compare approach
- [warning] [testability] AC-7 needs separate INSERT and UPDATE test cases (at: AC-7)
  Suggestion: Split into AC-7a and AC-7b
- [warning] [ambiguity] R20 is vague — which methods change return type? (at: R20)
  Suggestion: Enumerate each method's before/after return type
- [warning] [assumption] C4 idempotency relies on schema_version check — not documented (at: C4)
  Suggestion: Document detection mechanism

**Changes Made:**
- Added PRD traceability paragraph to Problem Statement
- R8: Specified conn.execute() not executescript() for transactional safety
- R12: Split into separate INSERT and UPDATE triggers
- R16: Added "updates BOTH parent_type_id and parent_uuid columns atomically"
- R20: Enumerated each method's return type change explicitly
- R21: Listed specific CTEs (set_parent, get_lineage, _export_tree)
- R22a: Added duplicate handling requirement for register_entity()
- R23: Added lowercase normalization before regex matching
- R26: Documented per-method error handling (get_entity catches, others propagate)
- R31: Added explicit analysis of why backfill works unchanged
- AC-7: Split into AC-7a (INSERT) and AC-7b (UPDATE)
- AC-11: Clarified get_entity catches ValueError
- AC-12: Added dual-column update verification
- AC-15a: Added duplicate detection returns existing UUID
- AC-18: Specified conn.execute() not executescript()
- AC-25: Added verification method (capture-compare)
- AC-27: Expanded to specific test scenarios
- AC-28, AC-29: Added set_parent atomicity criteria
- C3: Added input normalization
- C4: Documented schema_version detection mechanism
- C5: Documented pragma persistence mechanism

---

## Step 1: Spec-Reviewer Review - Iteration 2 - 2026-03-01T22:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] R8/AC-18 transactional safety incorrect — DDL does not start implicit transactions under legacy transaction control; explicit BEGIN IMMEDIATE required (at: R8, AC-18)
  Suggestion: Specify explicit BEGIN IMMEDIATE before DDL sequence
- [blocker] [assumptions] R26 get_lineage() behavioral change undocumented — current behavior returns [] for nonexistent entities, spec changes to ValueError without documenting breaking change (at: R26, backward compatibility)
  Suggestion: Preserve current [] behavior by catching ValueError internally
- [warning] [clarity] R21 doesn't address root-finding query in export_lineage_markdown(type_id=None) — needs uuid for CTE starting points (at: R21)
  Suggestion: Add root-finding query to R21 enumeration
- [warning] [traceability] R33 render_tree() internal changes not enumerated — by_id dict, children map, root parameter all need uuid migration (at: R33)
  Suggestion: Expand R33 with specific internal structure changes
- [warning] [testability] AC-26 "all 184 tests pass" not achievable without test updates due to R20 return value changes (at: AC-26)
  Suggestion: Reword to acknowledge test updates needed
- [warning] [clarity] R22/R22a numbering collision — separate concerns sharing same prefix (at: R22, R22a)
  Suggestion: Renumber R22a to R35
- [warning] [assumptions] C5 FK integrity after ALTER TABLE RENAME not documented (at: C5, R8)
  Suggestion: Add PRAGMA foreign_key_check verification note

**Changes Made:**
- R8: Specified explicit BEGIN IMMEDIATE transaction for DDL migration with rollback semantics
- R21: Added export_lineage_markdown() root-finding query to CTE enumeration
- R22: Added edge case note for empty/whitespace inputs
- R22a: Renumbered to R35 to avoid numbering collision
- R26: Changed get_lineage() to catch ValueError and return [] (preserving current behavior)
- R33: Expanded with specific internal data structure changes (by_id, children, root parameter)
- AC-18: Updated to specify explicit BEGIN IMMEDIATE transaction
- AC-26: Reworded to acknowledge test updates needed for behavioral changes
- C5: Added FK integrity verification via PRAGMA foreign_key_check after rename
- AC-27: Added minimum test count (10 new test functions)

---

## Step 1: Spec-Reviewer Review - Iteration 3 - 2026-03-01T23:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision (approved: true but 3 warnings under strict threshold)

**Issues:**
- [warning] [assumptions] R8 rollback placement ambiguity — unclear where try/except/rollback lives (at: R8)
  Suggestion: Clarify that migration function wraps DDL/DML in try/except with rollback before re-raise
- [warning] [clarity] R28 MCP message format scope unclear — which tools include both UUID and type_id? (at: R28)
  Suggestion: Enumerate each MCP tool's message format explicitly
- [warning] [assumptions] Python 3.16 forward-compatibility — legacy transaction control may change defaults (at: R8, C5)
  Suggestion: Add informational constraint note about Python version compatibility

**Changes Made:**
- R8: Clarified try/except/rollback placement — migration function wraps all DDL/DML, rollback before re-raise
- R28: Enumerated each MCP tool's return message format (register, set_parent, update, get_lineage, export)
- C7: Added informational constraint about Python 3.16+ autocommit behavior change

---

*--- Review counter reset by user request ---*

## Step 1: Spec-Reviewer Review - Iteration 1 (reset) - 2026-03-02T00:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] R35 cursor.lastrowid detection incorrect — retains previous value on ignored inserts
- [blocker] PRD NFR-UUID-3 (<100ms) silently dropped from spec
- [blocker] AC-26 test count weaker than PRD NFR-UUID-4
- [blocker] R8 Migration 1 executescript vs Migration 2 BEGIN IMMEDIATE interaction unclear
- [warning] AC-18 no testable rollback verification method
- [warning] R23 UUID v4 only regex strictness not documented
- [warning] R22 None input handling unspecified
- [warning] R33 root_type_id naming inconsistency
- [warning] AC-25 vague dataset specification
- [warning] R35 INSERT OR IGNORE detection mechanism unclear
- [warning] C5 FK reference update verification missing
- [warning] R31/R23 existing entity_id cannot match UUID format (not documented)

**Changes Made:**
13 fixes applied — NFR-UUID-3 justified in Non-Goals, R8 migration interaction clarified, AC-18 rollback test strategy added, R22 None input documented, R23 v4 strictness noted, R33 naming retention documented, R35 detection approach specified, AC-25 concrete scenario added, AC-26 tightened, AC-27 expanded, C5 FK check added, C8 ambiguity impossibility constraint added, R11 existing triggers retained.

---

## Step 1: Spec-Reviewer Review - Iteration 2 (reset) - 2026-03-02T00:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] R35 cursor.lastrowid == 0 is technically incorrect — lastrowid retains previous value on ignored inserts, NOT reset to 0
- [warning] C5 SQLite version requirement (>= 3.26.0) for FK reference updating is implicit
- [warning] R8 outer commit no-op needs docstring for future migration authors

**Changes Made:**
- R35: Replaced cursor.lastrowid approach with "always-SELECT" — always follow INSERT OR IGNORE with SELECT uuid FROM entities WHERE type_id = ?
- C5: Added explicit SQLite >= 3.26.0 requirement (Python 3.9+ bundles >= 3.31.0)
- R8: Added mandatory docstring requirement for Migration 2 function

---

## Step 1: Spec-Reviewer Review - Iteration 3 (reset) - 2026-03-02T01:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] AC numbering non-sequential (cosmetic)

**Changes Made:**
None required — approved.

---

## Step 2: Phase Review - Iteration 1 - 2026-03-02T01:15:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] AC-5 lacks explicit pragma persistence verification post-migration
- [warning] AC-18 outer-commit no-op assumption not explicitly tested

**Changes Made:**
- AC-5: Added PRAGMA foreign_keys returns 1 verification after migration
- AC-18: Added outer-commit no-op verification (implicit via EntityDatabase.__init__ clean completion)

---

## Step 2: Phase Review - Iteration 2 - 2026-03-02T01:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] AC numbering non-sequential (cosmetic, same as spec-reviewer)

**Changes Made:**
None required — approved.

---

## Design Review - Iteration 1 - 2026-03-02T03:45:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Migration 2 schema_version update gap — v2 schema committed but schema_version updated outside transaction; crash between causes re-run against migrated table (at: C1, I1, _migrate() interaction)
  Challenge: What happens if Migration 2 commits but schema_version update fails?
- [blocker] [feasibility] Missing idx_parent_uuid index — design claims 3 indexes but child-lookup CTEs need index on parent_uuid column, not on uuid PK (at: I9, C1 step 9)
  Challenge: How will WHERE parent_uuid = ? queries perform without dedicated index?
- [warning] [completeness] Raw SQL INSERT tests need uuid column — test_entity_type_check_constraint and test_valid_entity_types_accepted bypass API (at: C6)
  Challenge: Which tests perform raw SQL INSERTs that break due to NOT NULL uuid?
- [warning] [completeness] Pre-migration FK integrity check missing — I10 silently skips dangling parent_type_id references (at: I10 step 4)
  Challenge: What if parent_type_id references non-existent entity?
- [warning] [consistency] render_tree _render_node parameter naming confusion — type_id parameter carries UUID values post-migration (at: I7, C4)
  Challenge: Will implementer understand the semantic overloading?
- [warning] [completeness] FK references to UNIQUE columns needs explicit acknowledgment (at: I9, C1)
  Challenge: Does SQLite enforce FK to UNIQUE (non-PK) columns after rename?
- [warning] [completeness] CREATE TABLE entities_new DDL not shown explicitly (at: C1 step 3)
  Challenge: What exact DDL does the implementer write?

**Changes Made:**
- C1: Added schema_version ownership — Migration 2 updates schema_version INSIDE its transaction before COMMIT
- C1: Added pre-migration PRAGMA foreign_key_check (step 3) to validate FK integrity before migration
- C1: Added explicit CREATE TABLE entities_new DDL matching I9 schema (step 4)
- C1: Updated step count (12→14) and renumbered remaining steps
- C1: Updated index count from 3 to 4 (new idx_parent_uuid)
- I1: Updated contract to reflect schema_version ownership and atomic update
- I9: Updated index count to 4, added FK-to-UNIQUE acknowledgment, added parent_uuid nullable note
- C4: Added render_tree _render_node semantic overloading clarification
- C4: Changed _process_register_entity to construct type_id from input params (no extra DB call)
- C6: Added raw SQL INSERT test update requirement with specific test names
- I8: Updated register_entity handler to construct type_id from inputs
- Added Risk 2a for pre-existing FK violations

---

## Design Review - Iteration 2 - 2026-03-02T04:15:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (approved: true but 3 warnings under strict threshold)

**Issues:**
- [warning] [completeness] _export_tree truncation check not updated — leaf_ids extraction and child-existence check need uuid/parent_uuid (at: I6, C3)
  Challenge: What happens when _export_tree checks for children beyond max_depth using type_id columns?
- [warning] [consistency] C5 FK pragma wording misleading — SQLite >= 3.26.0 always updates FK references on rename regardless of foreign_keys pragma state (at: C5, TD-3)
  Challenge: Is PRAGMA foreign_keys = OFF actually needed for FK reference updating?
- [warning] [completeness] _process_get_lineage() 'Entity not found' error message not addressed for UUID input (at: C4)
  Challenge: What does the user see when they pass a UUID and the entity doesn't exist?

**Changes Made:**
- I6: Added _export_tree truncation check documentation — leaf_ids use row['uuid'], child check uses WHERE parent_uuid IN (...)
- C5: Added detailed note clarifying FK pragma vs FK reference updating behavior in SQLite >= 3.26.0
- C4: Added _process_get_lineage() error message handling for UUID input
- C6: Added test_self_parent_on_insert to raw SQL INSERT test list

---

## Design Review - Iteration 3 - 2026-03-02T04:30:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] [consistency] FK pragma note placed under C5 instead of TD-3 (at: C5, line 154)
- [suggestion] [complexity] I10 step 4 Python loop could be simplified to SQL UPDATE (at: I10)

**Changes Made:**
None required — approved.

---

## Handoff Review - Iteration 1 - 2026-03-02T04:45:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (approved: true but 2 warnings under strict threshold)

**Issues:**
- [warning] I10 Step 3 INSERT omits parent_uuid without explicit comment — planner may miscount columns (at: I10, Step 3)
  Suggestion: Add comment noting parent_uuid intentionally omitted, populated in Step 4
- [warning] C1 step 1 PRAGMA foreign_keys verification guard only appears in Risk 2, not in numbered step list (at: C1, step 1)
  Suggestion: Add explicit step 1b for verification and abort on failure
- [suggestion] _export_tree truncation check not listed in C3 method table (at: C3, I6)

**Changes Made:**
- C1: Added step 1b — verify PRAGMA foreign_keys returns 0 with abort guard
- I10: Added comment above Step 3 INSERT noting parent_uuid intentionally omitted
- C3: Added _export_tree() row to method table with internal change details

---

## Handoff Review - Iteration 2 - 2026-03-02T05:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] I10 pseudocode local import inconsistent with module-level convention (at: I10)

**Changes Made:**
None required — approved.

---

## Step 1: Plan Review - Iteration 1 - 2026-03-02T05:30:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] Missing "Tests first" for get_entity (2.4) and export_lineage_markdown (2.6) — violates TDD principle stated in plan preamble (at: 2.4, 2.6)
  Suggestion: Add explicit "Tests first" blocks for AC-9/AC-10/AC-11 (get_entity) and AC-25 (export_lineage_markdown)
- [blocker] Ambiguous _resolve_identifier return type — plan doesn't specify tuple(uuid, type_id) return per I2; set_parent (2.3) needs to unpack both values (at: 2.1)
  Suggestion: Explicitly state tuple return in 2.1 description
- [blocker] Phase 3 parallel claim contradiction — 3.2 passes uuid to render_tree, which must be updated first (3.1); they are NOT independent (at: Parallel groups, 3.1, 3.2)
  Suggestion: Remove parallel claim, mark 3.2 dependent on 3.1
- [warning] Phase 1.4 error handling scope — try/except wraps steps 2-12 but commit is step 13; should wrap 2-13 with FK re-enable in finally block (at: 1.4)
  Suggestion: Clarify try/except scope as steps 2-13, FK re-enable in finally
- [warning] Raw SQL INSERT test enumeration incomplete — need explicit list of tests that bypass API (at: 5.1)
  Suggestion: List test_entity_type_check_constraint, test_valid_entity_types_accepted, test_self_parent_on_insert
- [warning] _make_entity helper in test_server_helpers.py needs uuid/parent_uuid fields — render_tree tests will crash with KeyError (at: 5.1)
  Suggestion: Add _make_entity helper update to Phase 5.1 or Phase 3.1
- [warning] register_entity (2.2) doesn't use _resolve_identifier — incorrect dependency on 2.1 (at: dependency graph)
  Suggestion: Make 2.2 parallel with 2.1 after Phase 1
- [warning] Trigger recreation needs verification of all 8 triggers including existing 5 — not just 3 new ones (at: 1.3)
  Suggestion: Add explicit verification of all 8 triggers post-recreation
- [warning] update_entity MCP handler error path message format not addressed (at: 4.1)
  Suggestion: Note that error path messages remain unchanged
- [warning] Test count mismatch — spec AC-27 says minimum 10, plan says 15 (at: 5.2)
  Suggestion: Align as "target 15, hard minimum 10 per AC-27"
- [warning] Outer _migrate() loop interaction with Migration 2's internal commit not verified (at: 1.4)
  Suggestion: Add verification that EntityDatabase.__init__ completes with schema_version=2
- [suggestion] Replace LOC estimates with deliverable descriptions
- [suggestion] Add rationale annotations per phase item
- [suggestion] Clarify incremental test verification between phases
- [suggestion] Note which Phase 2 methods need test updates vs new tests

**Changes Made:**
- [blocker fix] 2.4 get_entity: Added "Tests first" block covering AC-9, AC-10, AC-11
- [blocker fix] 2.6 export_lineage_markdown: Added "Tests first" block covering AC-25 with capture-compare approach
- [blocker fix] 2.1: Explicitly stated return type as `tuple[str, str]` returning (uuid, type_id); updated 2.3 to show unpacking
- [blocker fix] Phase 3 parallel claim removed; 3.2 now marked as dependent on 3.1 with explanation
- [warning fix] 1.4: Clarified try/except wraps steps 2-13 (through commit), FK re-enable in finally block
- [warning fix] 5.1: Enumerated raw SQL INSERT tests explicitly (test_entity_type_check_constraint, test_valid_entity_types_accepted, test_self_parent_on_insert)
- [warning fix] 3.1: Added _make_entity helper update as "Tests first" prerequisite for render_tree
- [warning fix] Dependency graph: Made 2.2 parallel with 2.1 (register_entity doesn't use _resolve_identifier)
- [warning fix] 1.3: Added explicit verification of all 8 triggers post-recreation including existing 5
- [warning fix] 4.1: Added note that update_entity error path messages remain unchanged
- [warning fix] 5.2: Aligned test count as "target 15, hard minimum 10 per AC-27"
- [warning fix] 1.4: Added verification that EntityDatabase.__init__ completes with schema_version=2
- Removed LOC estimates from Files Changed Summary (replaced with deliverable descriptions)

---

## Step 1: Plan Review - Iteration 2 - 2026-03-02T06:00:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] Phase 4 (MCP Server) has no "Tests first" step — violates TDD commitment stated in plan preamble (at: 4.1)
  Suggestion: Add "Tests first" block for set_parent and update_entity handler message format changes
- [blocker] Phase 1.1/1.4 confused step numbering and unclear PRAGMA foreign_keys lifecycle — PRAGMA OFF before BEGIN IMMEDIATE, then re-enable in finally may silently fail if connection is corrupted (at: 1.1, 1.4)
  Suggestion: Clarify step ordering (PRAGMA OFF first, then BEGIN IMMEDIATE) and add defensive check in finally block
- [blocker] Phase 2.3 set_parent doesn't explicitly specify that resolved type_id (not raw input) must be stored in parent_type_id column (at: 2.3)
  Suggestion: Explicitly state UPDATE sets parent_type_id = parent_type_id from _resolve_identifier result, not raw input
- [warning] _migrate() loop interaction with Migration 2's internal commit needs explicit safety confirmation (at: 1.4)
  Suggestion: Add note confirming outer _migrate() loop is safe because schema_version check prevents re-entry
- [warning] _process_get_lineage entities[0]["uuid"] needs directional confirmation — works for both up and down? (at: 3.2)
  Suggestion: Confirm entities[0]["uuid"] is the start entity regardless of direction
- [warning] test_self_parent_on_insert needs TWO test cases — old parent_type_id trigger + new parent_uuid trigger (at: 5.1)
  Suggestion: Specify two separate test assertions
- [warning] export_lineage_markdown root-finding query changes from SELECT type_id to SELECT uuid not explicitly stated (at: 2.6)
  Suggestion: Explicitly state root-finding query returns uuid column instead of type_id
- [warning] register_entity commit ordering — should commit happen before or after the always-SELECT? (at: 2.2)
  Suggestion: Specify INSERT and SELECT within same transaction (autocommit handles it)
- [warning] Trigger recreation DDL must be copied exactly from Migration 1 for existing 5 triggers (at: 1.3)
  Suggestion: Note existing trigger DDL must match Migration 1 exactly
- [warning] _make_entity helper needs internally consistent uuid/parent_uuid values (at: 3.1)
  Suggestion: Specify helper generates deterministic uuid values and parent_uuid references existing entity uuids

**Changes Made:**
- [blocker fix] 4.1: Added "Tests first" block with test_set_parent_handler_dual_identity_message and test_update_entity_handler_dual_identity_message
- [blocker fix] 1.1: Clarified step ordering — PRAGMA OFF (step 1) + verify (step 1b) execute BEFORE BEGIN IMMEDIATE (step 2); added explicit note on step ordering rationale
- [blocker fix] 1.4: Clarified finally block runs AFTER commit/rollback (outside transaction), PRAGMA failure propagates naturally; noted defensive lifecycle
- [blocker fix] 2.3: Explicitly stated UPDATE sets parent_type_id from _resolve_identifier result (not raw input parameter)
- [warning fix] 1.4: Added safety note confirming _migrate() loop is safe via schema_version check preventing re-entry
- [warning fix] 3.2: Added directional note confirming entities[0] is always start entity regardless of up/down direction
- [warning fix] 5.1: Specified test_self_parent_on_insert needs TWO test cases (parent_type_id trigger + parent_uuid trigger)
- [warning fix] 2.6: Explicitly stated root-finding query changes from SELECT type_id to SELECT uuid
- [warning fix] 2.2: Added commit ordering note — INSERT and SELECT execute in same autocommit context
- [warning fix] 1.3: Added note that existing 5 trigger DDL must be copied exactly from Migration 1
- [warning fix] 3.1: Specified _make_entity helper needs internally consistent uuid/parent_uuid values with deterministic generation approach

---

## Step 1: Plan Review - Iteration 3 - 2026-03-02T06:30:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] Phase 5.1 missing `test_has_three_indexes` → assert 4 indexes (idx_parent_uuid added) (at: 5.1)
  Suggestion: Add index count assertion update to Phase 5.1
- [warning] Phase 2.5 update_entity resolution strategy ambiguity — should use get_entity (which resolves internally) instead of direct _resolve_identifier, to preserve metadata merge path (at: 2.5)
  Suggestion: Clarify update_entity uses _resolve_identifier directly (not get_entity) and explain why
- [warning] Phase 2.2 register_entity commit ordering — specify INSERT → SELECT → commit sequence explicitly (at: 2.2)
  Suggestion: Clarify that autocommit handles each statement individually
- [warning] Phase 5.1 missing `test_insert_or_ignore_idempotency` update — return value changes from type_id to UUID (at: 5.1)
  Suggestion: Add return value assertion update for idempotency tests
- [warning] Phase 3.1 _make_entity parent_uuid derivation from parent_type_id not explicit (at: 3.1)
  Suggestion: Specify parent_uuid = uuid5(NAMESPACE_DNS, parent_type_id) if parent_type_id else None
- [warning] Phase 4.1 MCP handler test approach unclear — integration test or extract to server_helpers? (at: 4.1)
  Suggestion: Clarify test approach — test via server helper functions
- [warning] Phase 1.3 trigger recreation DDL fidelity — need explicit confirmation existing 5 are byte-identical to Migration 1 (at: 1.3)
  Suggestion: Add explicit note that existing trigger DDL is reproduced identically

**Changes Made:**
- [blocker fix] 5.1: Added `test_has_three_indexes` → assert 4 indexes; renumbered subsequent items (6→7, 7→8, 8→9)
- [warning fix] 2.5: Added explicit note explaining _resolve_identifier is correct (not get_entity) — update_entity only needs uuid for WHERE clause, metadata merge is caller-driven
- [warning fix] 2.2: Clarified each statement auto-commits individually; SELECT reads committed state
- [warning fix] 5.1: Added `test_insert_or_ignore_idempotency` return value change to item 7
- [warning fix] 3.1: Added explicit parent_uuid derivation formula: `uuid5(NAMESPACE_DNS, parent_type_id) if parent_type_id else None`
- [warning fix] 4.1: Clarified test approach — test via server helper functions, not MCP protocol integration
- [warning fix] 1.3: Strengthened to "reproduced identically from Migration 1" with "no modifications to logic or naming"

---

## Step 1: Plan Review - Iteration 4 - 2026-03-02T07:00:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] Phase 1 TDD order: migration tests cannot run before _migrate_to_uuid_pk exists — tests need to call the function directly on a pre-prepared v1 DB, not via EntityDatabase.__init__ (at: 1.1-1.4)
  Suggestion: Clarify tests call _migrate_to_uuid_pk(conn) directly on manually-constructed v1 schema
- [blocker] Phase 2.2 commit ordering rationale incorrect — Python sqlite3 default isolation_level='' does NOT auto-commit each DML statement; INSERT starts implicit transaction committed by explicit conn.commit() (at: 2.2)
  Suggestion: Correct to state both INSERT and SELECT execute within same implicit transaction, committed by existing conn.commit()
- [warning] Phase 2.5 update_entity needs get_entity (not _resolve_identifier) for metadata shallow merge — existing code reads entity dict for json.loads(existing['metadata']) (at: 2.5)
  Suggestion: Change to call get_entity, extract uuid from returned dict
- [warning] Phase 1.3 missing explicit list of all 8 trigger names (at: 1.3)
  Suggestion: Enumerate all 8 sorted trigger names
- [warning] Phase 1.4 missing note about EntityDatabase instance being unusable after migration failure (at: 1.4)
  Suggestion: Add note that failed migration propagates through __init__, instance is not usable
- [warning] Phase 3.2 _process_get_lineage error message handling not explicit enough (at: 3.2)
  Suggestion: Add explicit note that error message works for both UUID and type_id inputs unchanged
- [warning] Phase 2.3 circular reference CTE anchor query not specified (at: 2.3)
  Suggestion: Specify CTE anchor uses WHERE uuid = ? with resolved parent_uuid
- [warning] Phase 4.1 references non-existent _process_set_parent function (at: 4.1)
  Suggestion: Either create the helper functions or test via mock db at handler level
- [warning] Phase 5.1 item 7 return value assertions not specific enough — should list test_happy_path, test_type_id_auto_constructed, test_all_valid_types (at: 5.1)
  Suggestion: Enumerate specific test names that assert return value

**Changes Made:**
- [blocker fix] 1.1: Added TDD approach note — tests call `_migrate_to_uuid_pk(conn)` directly on v1 schema, MIGRATIONS[2] registration is final wiring in 1.4
- [blocker fix] 2.2: Corrected commit ordering — INSERT starts implicit transaction, SELECT executes within it, existing `conn.commit()` commits both; removed incorrect "auto-commits individually" claim
- [warning fix] 2.5: Changed to call `self.get_entity(identifier)` for metadata shallow merge path; extract uuid from returned dict
- [warning fix] 1.3: Added complete sorted list of all 8 trigger names
- [warning fix] 1.4: Added failure note — exception propagates through __init__, instance not usable (fail-fast)
- [warning fix] 3.2: Added explicit error message handling — raw identifier echoed verbatim, works for both UUID and type_id
- [warning fix] 2.3: Specified CTE anchor: `SELECT parent_uuid FROM entities WHERE uuid = ?`, recursive join, child check
- [warning fix] 4.1: Removed reference to non-existent `_process_set_parent`/`_process_update_entity`; handlers call db methods directly, test via mock/real DB
- [warning fix] 5.1: Enumerated specific test names for return value assertions

---

## Step 1: Plan Review - Iteration 5 - 2026-03-02T08:30:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision (iteration cap reached — 5/5)

**Issues:**
- [blocker] Phase 1.4 outer _migrate() loop's INSERT OR REPLACE schema_version is characterized as "no-op" but is actual DML (functionally harmless but description misleading) (at: 1.4)
  Suggestion: Clarify it's actual DML that writes same value — not literally "no-op"
- [blocker] Phase 2.2 commit ordering note describes intended post-modification flow as if it were existing flow — "existing conn.commit()" is misleading since the SELECT doesn't exist yet. Current: INSERT -> commit -> return type_id. New: INSERT -> SELECT -> commit -> return uuid (at: 2.2)
  Suggestion: Explicitly distinguish current vs new code flow
- [blocker] Phase 1.1 test_migration_fresh_db asserts 8 triggers + 4 indexes but those aren't implemented until step 1.3 — violates TDD red-green-refactor (at: 1.1)
  Suggestion: Scope test_migration_fresh_db to only assert what 1.1 delivers (schema DDL), defer trigger/index assertions to 1.3
- [warning] Phase 2.5 update_entity WHERE clause needs explicit documentation of change from WHERE type_id = ? to WHERE uuid = ? (at: 2.5)
  Suggestion: Add explicit WHERE clause change note
- [warning] Phase 3.1 uuid5 test fixtures produce v5 UUIDs that won't match _UUID_V4_RE validation regex (at: 3.1)
  Suggestion: Note uuid5 is safe here since render_tree doesn't validate UUID format, or switch to uuid4
- [warning] Phase 2.3 circular reference CTE walks wrong direction — should walk UP via parent_uuid, not down (at: 2.3)
  Suggestion: Verify CTE anchor walks from proposed parent toward root
- [warning] Phase backfill.py may need test assertion updates for register_entity return values (at: 5.1)
  Suggestion: Audit backfill tests for type_id return assumptions
- [warning] Phase 4.1 async handler testing needs pytest-asyncio and _db monkeypatching (at: 4.1)
  Suggestion: Add pytest-asyncio marker and monkeypatch approach
- [warning] Phase 5.1/5.2 test count 184+ needs baseline verification before migration (at: 5.1)
  Suggestion: Run test suite first to establish actual baseline
- [warning] Phase 1.2/1.3 transaction boundary — steps are development increments, not transaction boundaries (at: 1.2-1.3)
  Suggestion: Add note clarifying steps are code increments within single transaction
- [warning] Phase 2.6 _export_tree parameter semantics change — type_id param now accepts UUID too (at: 2.6)
  Suggestion: Document parameter name vs actual semantics
- [suggestion] Move re import and _UUID_V4_RE to Phase 2.1 where it's first used (at: 1.1)
- [suggestion] Parallel groups text misleading about 2.4/2.5 independence — update_entity depends on get_entity (at: parallel groups)
- [suggestion] Clarify whether parent_uuid self-parent test is new function or added to existing test (at: 1.3)

**Changes Made:**
Iteration cap reached (5/5). Unresolved issues noted in .meta.json reviewerNotes. Proceeding to Step 2 (phase-reviewer) with warning.

---

## Step 2: Chain Review - Iteration 1 - 2026-03-02T06:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [blocker] Phase 3.1 uuid5 test fixture produces v5 UUIDs that fail _UUID_V4_RE validation — tests silently route to type_id branch (at: 3.1)
  Suggestion: Use hardcoded UUID v4 strings or uuid.uuid4() instead of uuid5
- [blocker] Phase 1.1 test_migration_fresh_db asserts triggers/indexes not implemented until 1.3 — TDD red-green violation (at: 1.1)
  Suggestion: Split assertions — 1.1 asserts schema shape only, defer trigger/index assertions to 1.3
- [warning] Phase 2.2 commit ordering describes intended post-implementation flow as existing behavior (at: 2.2)
  Suggestion: Distinguish current vs new flow explicitly
- [warning] Phase 2.3 CTE anchor too terse — no complete SQL shown (at: 2.3)
  Suggestion: Add complete CTE SQL with anchor, recursive step, termination
- [warning] Phase 3.2 entities[0] is NOT always start entity — wrong for up-traversal where ORDER BY depth DESC puts root first (at: 3.2)
  Suggestion: Correct reasoning about directional semantics
- [warning] Phase 5.2 backfill test "if available" is ambiguous — no definition of what available means (at: 5.2)
  Suggestion: Replace with definitive verification approach
- [warning] Phase 4.1 async handler testing needs pytest-asyncio guidance (at: 4.1)
  Suggestion: Specify async def handlers, pytest-asyncio, monkeypatch entity_server._db
- [suggestion] Phase 1.4 outer _migrate() schema_version already uses idempotent upsert — document this (at: 1.4)

**Changes Made:**
1. [blocker fix] 3.1: Changed uuid5 to hardcoded UUID v4 strings with ENTITY_UUIDS mapping
2. [blocker fix] 1.1/1.3: Split test_migration_fresh_db — 1.1 asserts schema shape only, 1.3 extends to assert triggers/indexes
3. [warning fix] 2.2: Rewrote commit ordering to distinguish current vs new flow explicitly
4. [warning fix] 2.3: Added complete CTE SQL for circular reference detection
5. [warning fix] 3.2: Corrected entities[0] reasoning — root for render_tree in both directions for different reasons
6. [warning fix] 5.2: Replaced ambiguous "if available" with definitive backfill verification approach
7. [warning fix] 4.1: Added pytest-asyncio + monkeypatch guidance for async handlers

---

## Step 2: Chain Review - Iteration 2 - 2026-03-02T06:30:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [blocker] Phase 1.4 outer _migrate() schema_version UPDATE described as 'no-op' but is real DML (INSERT OR REPLACE) — misleading for implementer (at: 1.4 step 4 safety note)
  Suggestion: Replace 'no-op' with idempotent DML description and add verification step
- [blocker] Phase 2.2 commit ordering stated as fact without verification step — if wrong, implementer inserts SELECT in wrong position (at: 2.2 commit ordering note)
  Suggestion: Add pre-step to read actual code and verify commit position before modifying
- [warning] Phase 4.1 requires pytest-asyncio but no step to verify dependency is installed (at: 4.1 test approach)
  Suggestion: Add pre-condition check for pytest-asyncio installation
- [warning] test_update_entity_with_uuid (2.5) not in design C6 canonical list of 15 — count discrepancy (at: 5.2 test count)
  Suggestion: Clarify total target is 16 (15 from C6 + 1 additional)
- [suggestion] Dependency graph shows 2.6 as leaf with no arrow to 3.1 — implicit parallelism not documented (at: dependency graph)

**Changes Made:**
1. [blocker fix] 1.4: Replaced 'no-op' with detailed idempotency explanation — real DML but produces no net change, added verification step
2. [blocker fix] 2.2: Added pre-step verification to read actual register_entity code before modifying
3. [warning fix] 4.1: Added pytest-asyncio pre-condition check with install command
4. [warning fix] 5.2: Clarified test count — 16 total target (15 from C6 + test_update_entity_with_uuid)

---

## Step 2: Chain Review - Iteration 3 - 2026-03-02T06:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] Phase 1.4 SQL syntax example may not match actual code syntax (INSERT OR REPLACE vs ON CONFLICT) (at: 1.4 idempotency detail)
  Suggestion: Verify actual SQL syntax during implementation

**Changes Made:**
No changes needed — approved with suggestion only.

---
