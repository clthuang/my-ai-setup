# Review History: 001-entity-uuid-primary-key-migrat

## Step 1: Spec-Reviewer Review - Iteration 1 - 2026-03-01T22:00:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [contradiction] R26 raises ValueError vs AC-11 returns None — contradictory error handling semantics (at: R26, AC-11)
  Suggestion: Clarify per-method error handling — get_entity catches ValueError, others propagate
- [blocker] [missing-requirement] set_parent() must update both parent_type_id and parent_uuid atomically (at: R16)
  Suggestion: Add explicit requirement and AC for dual-column update
- [blocker] [logic-error] register_entity() INSERT OR IGNORE: freshly generated UUID returned but never stored on duplicate (at: R13, C6)
  Suggestion: Add requirement to query existing UUID on duplicate detection
- [blocker] [unjustified-assertion] R31 claims no backfill changes without analysis (at: R31)
  Suggestion: Add explicit analysis of why backfill works unchanged
- [warning] [traceability] No PRD traceability chain documented (at: Problem Statement)
  Suggestion: Add PRD section reference
- [warning] [safety] executescript() auto-commits — breaks transactional migration safety (at: R8)
  Suggestion: Specify conn.execute() instead of executescript()
- [warning] [completeness] Internal CTE queries need explicit enumeration (at: R21)
  Suggestion: List each CTE that needs uuid/parent_uuid migration
- [warning] [testability] AC-25 needs specific verification method (at: AC-25)
  Suggestion: Specify capture-compare approach
- [warning] [testability] AC-7 needs separate INSERT and UPDATE test cases (at: AC-7)
  Suggestion: Split into AC-7a and AC-7b
- [warning] [ambiguity] R20 is vague — which methods change return type? (at: R20)
  Suggestion: Enumerate each method's before/after return type
- [warning] [assumption] C4 idempotency relies on schema_version check — not documented (at: C4)
  Suggestion: Document detection mechanism

**Changes Made:**
- Added PRD traceability paragraph to Problem Statement
- R8: Specified conn.execute() not executescript() for transactional safety
- R12: Split into separate INSERT and UPDATE triggers
- R16: Added "updates BOTH parent_type_id and parent_uuid columns atomically"
- R20: Enumerated each method's return type change explicitly
- R21: Listed specific CTEs (set_parent, get_lineage, _export_tree)
- R22a: Added duplicate handling requirement for register_entity()
- R23: Added lowercase normalization before regex matching
- R26: Documented per-method error handling (get_entity catches, others propagate)
- R31: Added explicit analysis of why backfill works unchanged
- AC-7: Split into AC-7a (INSERT) and AC-7b (UPDATE)
- AC-11: Clarified get_entity catches ValueError
- AC-12: Added dual-column update verification
- AC-15a: Added duplicate detection returns existing UUID
- AC-18: Specified conn.execute() not executescript()
- AC-25: Added verification method (capture-compare)
- AC-27: Expanded to specific test scenarios
- AC-28, AC-29: Added set_parent atomicity criteria
- C3: Added input normalization
- C4: Documented schema_version detection mechanism
- C5: Documented pragma persistence mechanism

---

## Step 1: Spec-Reviewer Review - Iteration 2 - 2026-03-01T22:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumptions] R8/AC-18 transactional safety incorrect — DDL does not start implicit transactions under legacy transaction control; explicit BEGIN IMMEDIATE required (at: R8, AC-18)
  Suggestion: Specify explicit BEGIN IMMEDIATE before DDL sequence
- [blocker] [assumptions] R26 get_lineage() behavioral change undocumented — current behavior returns [] for nonexistent entities, spec changes to ValueError without documenting breaking change (at: R26, backward compatibility)
  Suggestion: Preserve current [] behavior by catching ValueError internally
- [warning] [clarity] R21 doesn't address root-finding query in export_lineage_markdown(type_id=None) — needs uuid for CTE starting points (at: R21)
  Suggestion: Add root-finding query to R21 enumeration
- [warning] [traceability] R33 render_tree() internal changes not enumerated — by_id dict, children map, root parameter all need uuid migration (at: R33)
  Suggestion: Expand R33 with specific internal structure changes
- [warning] [testability] AC-26 "all 184 tests pass" not achievable without test updates due to R20 return value changes (at: AC-26)
  Suggestion: Reword to acknowledge test updates needed
- [warning] [clarity] R22/R22a numbering collision — separate concerns sharing same prefix (at: R22, R22a)
  Suggestion: Renumber R22a to R35
- [warning] [assumptions] C5 FK integrity after ALTER TABLE RENAME not documented (at: C5, R8)
  Suggestion: Add PRAGMA foreign_key_check verification note

**Changes Made:**
- R8: Specified explicit BEGIN IMMEDIATE transaction for DDL migration with rollback semantics
- R21: Added export_lineage_markdown() root-finding query to CTE enumeration
- R22: Added edge case note for empty/whitespace inputs
- R22a: Renumbered to R35 to avoid numbering collision
- R26: Changed get_lineage() to catch ValueError and return [] (preserving current behavior)
- R33: Expanded with specific internal data structure changes (by_id, children, root parameter)
- AC-18: Updated to specify explicit BEGIN IMMEDIATE transaction
- AC-26: Reworded to acknowledge test updates needed for behavioral changes
- C5: Added FK integrity verification via PRAGMA foreign_key_check after rename
- AC-27: Added minimum test count (10 new test functions)

---
