# Tasks: Root Cause Analysis Agent & Command

## Overview

- **Total Tasks:** 8
- **Phases:** 4 (Setup, References, Components, Validation)
- **Parallel Groups:** 1 (reference files can be created in parallel)

---

## Phase 1: Setup

### Task 1.1: Create skill directory structure
**Action:** Run `mkdir -p plugins/iflow-dev/skills/root-cause-analysis/references`
**Done when:** `ls -d plugins/iflow-dev/skills/root-cause-analysis/references` succeeds
**Time:** ~2 min

---

## Phase 2: Reference Files (PARALLEL - can run simultaneously)

### Task 2.1: Create five-whys-template.md
**File:** `plugins/iflow-dev/skills/root-cause-analysis/references/five-whys-template.md`
**Content source:** design.md lines 172-193
**Content:**
- H1: "5 Whys Template"
- Problem Statement section with placeholder
- Why Analysis table (5 rows: #, Question, Answer, Evidence)
- Root Cause section with placeholder
- "When to Stop" section with 3 bullets (outside control, process issue, actionable)
**Done when:** File exists with Problem Statement, 5-row Why table, Root Cause, When to Stop sections
**Time:** ~5 min

### Task 2.2: Create fishbone-categories.md
**File:** `plugins/iflow-dev/skills/root-cause-analysis/references/fishbone-categories.md`
**Content source:** design.md lines 195-227
**Content:**
- H1: "Fishbone (Ishikawa) Categories for Software"
- H2: "Software-Specific Categories"
- Table with 6 categories: Code, Config, Data, Environment, Dependencies, Integration
- Each row: Category | What to Check | Examples
- H2: "Mermaid Diagram Template" with sample diagram code
**Done when:** File exists with 6-category table and mermaid template
**Time:** ~5 min

### Task 2.3: Create rca-report-template.md
**File:** `plugins/iflow-dev/skills/root-cause-analysis/references/rca-report-template.md`
**Content source:** design.md lines 229-294
**Content:**
- H1: "RCA Report: {Title}"
- Summary section (Issue, Reported, Investigated, Status)
- Timeline table
- Reproduction section (Environment, Steps, Result)
- Investigation section (Hypotheses table with 3+ rows, Experiments subsection)
- Root Causes section (Primary, Contributing, Interaction Effects)
- Fishbone Analysis placeholder
- Recommendations list
- Next Steps checklist
- Footer: "*Generated by rca-investigator agent*"
**Done when:** File exists with all 9 major sections matching spec.md report format
**Time:** ~10 min

---

## Phase 3: Core Components (SEQUENTIAL)

### Task 3.1: Create SKILL.md
**File:** `plugins/iflow-dev/skills/root-cause-analysis/SKILL.md`
**Content source:** design.md lines 119-166, 498-507
**Content:**
1. Frontmatter:
   ```yaml
   ---
   name: root-cause-analysis
   description: |
     This skill should be used when the user says 'run RCA', 'thorough investigation',
     'find ALL root causes', 'comprehensive debugging', or runs /root-cause-analysis command.
     For quick debugging guidance, use systematic-debugging skill instead.
     This skill produces a formal RCA report with reproduction, experiments, and evidence.
   ---
   ```
2. H1: "Root Cause Analysis"
3. Process Overview with mermaid diagram (CLARIFY → REPRODUCE → INVESTIGATE → EXPERIMENT → ANALYZE → REPORT)
4. Six phase sections (Phase 1-6), each with: Actions, Output, Tools, Reference link
5. Behavioral Rules section (4 MUST rules from spec)
6. Related Resources section linking to `../systematic-debugging/SKILL.md` and `../verifying-before-completion/SKILL.md`

**Done when:**
- `grep -q "^name: root-cause-analysis" SKILL.md` returns true
- File contains mermaid diagram with 6 phases
- File contains "Behavioral Rules" section
- File contains "Related Resources" section
**Time:** ~15 min

### Task 3.2: Create rca-investigator agent
**File:** `plugins/iflow-dev/agents/rca-investigator.md`
**Content source:** design.md lines 413-491
**Content:**
1. Frontmatter:
   ```yaml
   ---
   name: rca-investigator
   description: |
     Proactive root cause analysis agent that finds ALL contributing causes.
     Use this agent when: (1) user runs /root-cause-analysis command,
     (2) user says 'run RCA' or 'thorough investigation',
     (3) user says 'find ALL root causes' (emphasis on ALL),
     (4) user mentions failed multiple fix attempts (3-fix rule).

     <example>
     Context: User has a failing test
     user: "/root-cause-analysis test_auth is failing with 'token expired'"
     assistant: "I'll investigate all potential root causes for this test failure."
     <commentary>User explicitly invokes RCA command with test failure.</commentary>
     </example>

     <example>
     Context: User wants thorough investigation
     user: "The API returns 500 sometimes but not always, I need a thorough RCA"
     assistant: "I'll use the rca-investigator to systematically find all contributing factors."
     <commentary>User explicitly requests thorough RCA for intermittent issue.</commentary>
     </example>

     <example>
     Context: User frustrated with repeated failures
     user: "This test keeps failing, I've tried fixing it 3 times already"
     assistant: "Multiple fix attempts indicate this needs systematic RCA. Let me investigate."
     <commentary>3-fix rule triggers thorough investigation.</commentary>
     </example>
   tools: [Read, Glob, Grep, Bash, Write, Edit, WebSearch]
   color: cyan
   ---
   ```
2. Body with:
   - H1: "RCA Investigator Agent"
   - "You are a proactive root cause analysis agent..."
   - H2: "Your Process" with 6 phases
   - H2: "Behavioral Rules" (6 rules: reproduce first, 3+ hypotheses, sandbox only, no fixes, verification scripts, CLAUDE.md guidelines)
   - H2: "Edge Cases" (cannot reproduce, external dependency, fewer than 3 causes)

**Done when:**
- `grep -q "^name: rca-investigator" rca-investigator.md` returns true
- File contains 3 `<example>` blocks
- File contains "Behavioral Rules" section
- File contains "Edge Cases" section
**Time:** ~10 min

### Task 3.3: Create root-cause-analysis command
**File:** `plugins/iflow-dev/commands/root-cause-analysis.md`
**Content source:** design.md lines 398-407, plan.md lines 141-165
**Content:**
1. Frontmatter:
   ```yaml
   ---
   description: Investigate bugs and failures to find all root causes
   argument-hint: <bug description or test failure>
   ---
   ```
2. Body instructions (FOR Claude, not messages TO users):
   - Accept $ARGUMENTS as bug/test description
   - If $ARGUMENTS empty, prompt with AskUserQuestion for bug description
   - Reference skill: `@plugins/iflow-dev/skills/root-cause-analysis/SKILL.md`
   - Dispatch to rca-investigator agent via Task tool
   - On completion, offer AskUserQuestion handoff with options:
     - "Create feature for fix" → invoke `/create-feature "Fix: {rca-title}"`
     - "Save and exit" → confirm report saved
   - Display: "RCA report available at: {path}"

**Done when:**
- `grep -q "^description:" root-cause-analysis.md` returns true
- File contains `argument-hint:`
- File contains `@plugins/iflow-dev/skills/root-cause-analysis/SKILL.md` reference
- File contains AskUserQuestion handoff structure
**Time:** ~10 min

---

## Phase 4: Validation & Testing (SEQUENTIAL)

### Task 4.1: Run static validation
**Command:** `./validate.sh`
**Verification:**
```bash
./validate.sh 2>&1 | grep -E "(rca-investigator|root-cause-analysis)"
echo "Exit code: $?"
```
**Done when:**
- Exit code is 0
- Output contains "Checking ./plugins/iflow-dev/agents/rca-investigator.md"
- Output contains "Checking ./plugins/iflow-dev/skills/root-cause-analysis"
- Output contains "Checking ./plugins/iflow-dev/commands/root-cause-analysis.md"
**Time:** ~3 min

### Task 4.2: Manual integration test
**Test procedure:**
1. Start new Claude Code session: `claude`
2. Run command: `/iflow-dev:root-cause-analysis "test failure - integration test"`
3. Observe:
   - Command parses without error
   - Skill content appears in context (look for "6-phase" or "CLARIFY")
   - Agent dispatch begins (Task tool invoked)
4. Abort with Ctrl+C after confirming dispatch (full RCA not needed)
5. Verify reference files: `ls plugins/iflow-dev/skills/root-cause-analysis/references/`

**Done when:**
- Command loads without syntax errors
- Agent dispatches (Task tool shows "rca-investigator")
- `ls` shows 3 reference files: five-whys-template.md, fishbone-categories.md, rca-report-template.md
**Time:** ~5 min

---

## Dependency Graph

```
Phase 1: Setup
  Task 1.1 (mkdir)
      │
      ▼
Phase 2: References (PARALLEL GROUP)
  ┌─────────┬─────────┬─────────┐
  │Task 2.1 │Task 2.2 │Task 2.3 │
  │ 5-whys  │fishbone │ report  │
  └────┬────┴────┬────┴────┬────┘
       └─────────┼─────────┘
                 │
                 ▼
Phase 3: Components (SEQUENTIAL)
  Task 3.1 (SKILL.md) ─── depends on refs existing
      │
      ▼
  Task 3.2 (Agent) ─── depends on skill for content alignment
      │
      ▼
  Task 3.3 (Command) ─── depends on skill (@file ref) and agent (dispatch target)
      │
      ▼
Phase 4: Validation (SEQUENTIAL)
  Task 4.1 (validate.sh)
      │
      ▼
  Task 4.2 (integration test)
```

## AC Coverage

| Task | Acceptance Criteria |
|------|---------------------|
| 3.2 | AC-1: Agent Creation (frontmatter, examples, tools, color) |
| 2.1-2.3, 3.1 | AC-2: Skill Creation (SKILL.md, references directory) |
| 3.3 | AC-3: Command Creation (frontmatter, dispatch, handoff) |
| 3.2 | AC-4: Sandbox Isolation (agent behavioral rules) |
| 3.1, 3.2 | AC-5: Multiple Hypotheses (skill + agent enforce) |
| 2.3, 3.1 | AC-6: Report Generation (template + process) |
| 3.3, 4.2 | AC-7: Workflow Handoff (command + test) |
| 4.1 | AC-8: Validation (./validate.sh passes) |
