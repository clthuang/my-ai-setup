# Review History: 023-cross-project-persistent-memory

## Design Review - Iteration 1 - 2026-02-17T03:55:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [completeness] constitution.md (4th knowledge bank file) not addressed — excluded with rationale
- [blocker] [feasibility] --skip-memory CLI arg passing via hooks.json unverified — replaced with wrapper script + env var
- [blocker] [consistency] Parser state machine doesn't handle ## section headers or varied metadata — rewritten as split-and-partition with defaults
- [warning] [consistency] Content hash input not precisely defined — added explicit definition (description text only)
- [warning] [consistency] main() not forwarding $@ — no longer needed with env var approach
- [warning] [completeness] Fill strategy sort criteria undefined — added primary/secondary/tertiary sort keys
- [warning] [completeness] .last-injection.json schema — was already defined in I7 (reviewer missed)
- [warning] [completeness] No anchoring examples for classification — added 5 examples
- [warning] [feasibility] New .py file type in hooks/lib/ — noted, validate.sh check needed
- [warning] [completeness] Ambiguous dependency graph — rewritten with clear parallel notation
- [suggestion] compact event not addressed — documented: not in any matcher, intentional
- [suggestion] State machine over-engineering — simplified to split-and-partition
- [suggestion] No timeout for memory.py — added `timeout 3` wrapper

**Changes Made:**
1. Added constitution.md exclusion rationale before Architecture Overview
2. Replaced --skip-memory CLI args with session-start-clear.sh wrapper script (5 lines)
3. Rewrote parser from formal state machine to split-and-partition approach with defaults for missing fields
4. Added precise content hash definition (description text only, excluding header and metadata)
5. Added 5 anchoring examples for universal/project-specific classification
6. Added explicit priority sort criteria (observation count → confidence → recency)
7. Added `timeout 3` to memory.py subprocess call
8. Rewrote dependency graph with clear parallel notation
9. Documented compact event handling (not in matchers, intentional)
10. Added note about hooks/lib/ new file type check

---

## Design Review - Iteration 2 - 2026-02-17T04:05:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues (warnings, no blockers):**
- [warning] [consistency] Fill strategy overflow: aligned with spec (category-priority)
- [warning] [completeness] C1 dedup hash input not explicit: added note "Description text only"
- [warning] [consistency] Last observed format differs local vs global: clarified file position for local
- [warning] [feasibility] Inline Python interpolation anti-pattern: changed to stdin pipe

**Changes Made:** All 4 warnings addressed inline in design.md.

---

## Handoff Review - Iteration 1 - 2026-02-17T04:10:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues (warnings, no blockers):**
- [warning] macOS `timeout` command portability: added gtimeout/timeout detection pattern
- [warning] Heading-level collision in output format: noted, cosmetic
- [warning] Step 4c ordering relative to 4b: added explicit "MUST run after 4b" note
- [warning] Spec AC-1.6 superseded: added explicit deviation note with updated criterion

**Changes Made:** All 4 warnings addressed inline in design.md.

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-17T04:30:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] No TDD ordering — no test steps before implementation for ~120-line Python module
- [blocker] Step 3 line count claim (22 lines) unverifiable — actual content not shown
- [warning] Config defaults not clarified (enabled=true, limit=20)
- [warning] Timeout fallback behavior undefined (what if no timeout command)
- [warning] mkdir for .last-injection.json parent directory not mentioned
- [warning] validate.sh may not cover .py files in hooks/lib/
- [warning] Shell metacharacters in hash computation
- [warning] Fill strategy edge case when limit < total min-guarantees

**Changes Made:**
1. Added verification approach note (manual verification, no test framework for hook utilities)
2. Moved py_compile + functional verification into each step as "run immediately after"
3. Replaced line count claim with exact insertion text (20 lines, counted from content block)
4. Clarified config defaults match template (enabled=true, limit=20)
5. Documented timeout fallback: runs unguarded, acceptable for ~50ms operation
6. Added os.makedirs for .last-injection.json parent directory
7. Added validate.sh note about .py file coverage gap
8. Added fill strategy edge case handling (proportional reduction when limit < min-guarantees)
9. Added R4 (global store conflicts) to risk table
10. Specified exact config file path in Step 4 verification

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-17T04:45:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] HTML comment blocks in knowledge bank files contain `### ` entries that parser would parse as real entries
- [warning] Fill strategy edge case: "reduce proportionally" contradicts spec ("skip minimum guarantee")
- [warning] Step 3 heading level `#### Step 4c` inconsistent with existing `### Step 4b`
- [warning] File selection (hardcoded vs glob) not specified — constitution.md could be included
- [warning] Step 4 function placement description misleading ("after build_context()" vs "before main()")
- [warning] AC-1.8 performance test with 500 entries not in verification steps

**Changes Made:**
1. Added HTML comment stripping as preprocessing step in parse_entries
2. Added hardcoded filenames note (excludes constitution.md per design)
3. Aligned fill strategy edge case with spec: skip minimum guarantee, pure priority allocation
4. Fixed heading level: `### Step 4c` (matches `### Step 4b`)
5. Clarified function placement: "before main() (after existing build_context() function)"
6. Added AC-1.8 performance verification with 500 synthetic entries
7. Expanded spec deviations to clarify entire event-filtering mechanism is dropped
8. Added diagnostic guidance for Step 4 integration test

---

## Task Review Iteration 1 - 2026-02-17T05:00:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 5.1: Missing dependency on Task 1.3 (memory.py verification) — could validate before memory.py is verified → Added 1.3 to deps
- [warning] Task 1.3: Time estimate 5 min misleading (synthetic data generation + perf test) → Changed to 10 min
- [warning] Task 3.1: Done-when "4 anchoring examples" subjective → Specified exact 4 examples
- [warning] Task 4.2: Done-when "shows memory block" subjective → Changed to grep for `## Engineering Memory` in JSON output

**Changes Made:**
1. Task 5.1 dependencies updated from "3.1, 4.2" to "1.3, 3.1, 4.2"
2. Task 1.3 time estimate changed from 5 min to 10 min
3. Task 3.1 done-when lists specific anchoring examples by name
4. Task 4.2 done-when uses binary check (grep additionalContext for Engineering Memory header)
5. Summary table updated to match

---

## Task Review Iteration 2 - 2026-02-17T05:05:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 1.2: Header `(from knowledge bank)` present in task but plan uses shortened form → Verified: spec/design use full form, task is correct, plan was shorthand. No change needed.
- [blocker] Task 1.3: Synthetic entry format unspecified → Added explicit format template with header/description/metadata structure
- [blocker] Task 4.2: Verification requires env setup not specified → Added full pipeline command with JSON parsing and explicit prereq note

**Changes Made:**
1. Task 1.3 performance test now specifies exact entry format (### Entry N, description, metadata lines)
2. Task 4.2 verification now uses complete pipeline: bash → python3 JSON parse → substring check for 'Engineering Memory', with prereq note about config file
3. Header consistency confirmed: Task 1.2 matches spec/design (full form), Task 4.2 uses substring match

---

## Task Review Iteration 3 - 2026-02-17T05:10:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 1.3: Synthetic entry format missing `Last observed` metadata field — parser extracts 3 fields, format only showed 2 → Added all 3 metadata fields with full format block
- [warning] Task 4.2: Precondition about config file not documented → Added explicit precondition note
- [warning] Summary table: Time estimates removed (not useful for task execution) → Removed Est. column

**Changes Made:**
1. Task 1.3 synthetic format now includes all 3 metadata fields (Observation count, Confidence, Last observed) in a code block
2. Task 4.2 has explicit precondition: `.claude/iflow-dev.local.md` must contain `memory_injection_enabled: true`
3. Summary table simplified to Task/File/Depends On (removed Est. column)

---

## Task Review Iteration 4 - 2026-02-17T05:15:00Z

**Decision:** Approved with warnings (no blockers)

**Issues:**
- [warning] Task 4.1: `$config_file` variable not defined → Added `local config_file=` definition line
- [warning] Task 1.2: `write_tracking` signature missing `project_root` param → Fixed signature and clarified path/mkdir
- [warning] Task 1.1: `content_hash(text)` doesn't clarify text=description only → Added note matching C4 hash definition
- [warning] Task 3.1: 4 vs 5 anchoring examples (plan vs design) → Kept plan's 4 per approved scope
- [warning] Task 4.2: Misleading precondition → Reworded to explain read_local_md_field defaults

**Changes Made:**
1. Task 4.1: Added `local config_file="${PROJECT_ROOT}/.claude/iflow-dev.local.md"` instruction
2. Task 1.2: Fixed write_tracking signature to `(entries, project_root, global_store)` with explicit path details
3. Task 1.1: Added note that `text` parameter is description only (matches C4 hash definition)
4. Task 4.2: Reworded precondition to explain defaults behavior

---

## Implementation Review - Iteration 1 - 2026-02-17T06:15:00Z

**Implementation Review:** Issues found
  - Level 1 (Tasks): fail — Task 5.1 flagged as missing test artifacts
  - Level 2 (Spec): pass — all AC criteria satisfied
  - Level 3 (Design): pass — clean alignment
  - Level 4 (PRD): pass — all SC delivered
**Quality Review:** Approved with 2 warnings
**Security Review:** Approved with 1 warning (pre-existing pattern)

**Issues:**
- [blocker] [tasks] implementation-reviewer: Task 5.1 has no test artifacts (at: hooks/tests/test-hooks.sh)
  Suggestion: Add memory-specific tests
  Note: Task 5.1 is defined in tasks.md/plan.md as "Run validate.sh and final checks" — NOT as "write unit tests". Plan explicitly states "no automated test framework for hook utilities". All validation checks (validate.sh, py_compile, functional output, performance) passed. Blocker is false positive from misread task scope.
- [warning] [quality] code-quality-reviewer: _source tracking uses implicit absence-based counting (at: memory.py:227)
  Suggestion: Tag local entries explicitly
- [warning] [quality] code-quality-reviewer: Metadata partition heuristic may truncate heuristic descriptions in content_hash (at: memory.py:75-84)
  Note: Informational — both stores parse identically so dedup works; output preserves all text
- [warning] [security] security-reviewer: Pre-existing shell-to-Python interpolation pattern at session-start.sh:27,69
  Note: Not introduced by this feature — pre-existing code. New code (build_memory_context) uses proper external CLI invocation

**Changes Made:**
1. Fixed _source tracking: local entries now explicitly tagged with `entry["_source"] = "local"`, tracking uses exact match comparison instead of string-absence heuristic
2. Implementation blocker noted as false positive (Task 5.1 scope is "run validate.sh" per plan, not "write tests")
3. Security warning noted as pre-existing pattern not in scope of this feature

---

## Implementation Review - Iteration 2 - 2026-02-17T06:30:00Z

**Implementation Review:** Approved (0 issues)
**Quality Review:** Approved with 3 warnings
**Security Review:** Approved with 1 warning

**Issues:**
- [warning] [quality] code-quality-reviewer: Metadata extraction silently defaults for malformed entries (at: memory.py:89-107)
  Note: By design per spec ("Malformed entry = default to observation count 1"). Silent defaults are intentional.
- [warning] [quality] code-quality-reviewer: select_entries() edge case not documented (at: memory.py:153-190)
  Fix: Added inline comment explaining min-guarantee skip behavior
- [warning] [quality] code-quality-reviewer: Limit not validated in bash before Python (at: session-start.sh:231)
  Fix: Added regex validation `[[ "$limit" =~ ^-?[0-9]+$ ]] || limit="20"`
- [warning] [security] security-reviewer: Path traversal risk with hardcoded filenames (at: memory.py:256-271)
  Note: CATEGORIES is a hardcoded constant, filenames are string literals. Zero traversal risk. Defensive realpath() check is over-engineering for this context.

**Changes Made:**
1. Added inline comment to select_entries() explaining min-guarantee skip
2. Added bash-side integer validation for limit before passing to Python

---

## Implementation Review - Iteration 3 - 2026-02-17T06:45:00Z

**Implementation Review:** Approved (0 issues)
**Quality Review:** Not approved (1 blocker + 3 warnings — all pre-existing or by-design)
**Security Review:** Approved (1 suggestion)

**Issues:**
- [blocker] [quality] code-quality-reviewer: Bare except: clause at session-start.sh:42
  Note: PRE-EXISTING CODE. Line 42 is inside find_active_feature() which predates Feature 023. Not introduced by this feature. build_memory_context() is at lines 222-247.
- [warning] [quality] Content hash normalization may cause false dedup
  Note: BY DESIGN per spec — "normalized by: lowercasing, stripping, collapsing whitespace". Spec decision, not a bug.
- [warning] [quality] Silent metadata parse failures
  Note: BY DESIGN per spec — "Malformed entry = default to observation count 1". Silent defaults are intentional.
- [warning] [quality] Dictionary mutation during iteration in select_entries
  Note: FALSE POSITIVE — code iterates over `non_empty` list, not `buckets` dict. Mutation of `buckets[cat]` is intentional (slice off already-selected entries for fill phase).

**Changes Made:**
None required — all issues are either pre-existing code, design-intentional, or false positives.

---

## Implementation Review - Iteration 4 - 2026-02-17T07:00:00Z

**Implementation Review:** Approved (0 issues)
**Quality Review:** Approved with 1 warning + 5 suggestions
**Security Review:** Approved (1 suggestion)

**Issues:**
- [warning] [quality] code-quality-reviewer: stderr suppression silently discards memory.py errors (at: session-start.sh:242-245)
  Fix: Added inline comment explaining intentional suppression (errors must not corrupt hook JSON output)

**Changes Made:**
1. Added comment above stderr-suppressed Python call: "stderr suppressed: memory.py errors must not corrupt hook JSON output"

---

## Implementation Review - Iteration 5 (Final) - 2026-02-17T07:15:00Z

**Implementation Review:** Approved (0 issues)
**Quality Review:** Approved (0 issues)
**Security Review:** Approved (0 issues)

**Issues:** None — all three reviewers passed with zero blockers and zero warnings.

**Result:** FULL PASS — review phase complete after 5 iterations.

---
