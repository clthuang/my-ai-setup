# Review History: 023-cross-project-persistent-memory

## Design Review - Iteration 1 - 2026-02-17T03:55:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [completeness] constitution.md (4th knowledge bank file) not addressed — excluded with rationale
- [blocker] [feasibility] --skip-memory CLI arg passing via hooks.json unverified — replaced with wrapper script + env var
- [blocker] [consistency] Parser state machine doesn't handle ## section headers or varied metadata — rewritten as split-and-partition with defaults
- [warning] [consistency] Content hash input not precisely defined — added explicit definition (description text only)
- [warning] [consistency] main() not forwarding $@ — no longer needed with env var approach
- [warning] [completeness] Fill strategy sort criteria undefined — added primary/secondary/tertiary sort keys
- [warning] [completeness] .last-injection.json schema — was already defined in I7 (reviewer missed)
- [warning] [completeness] No anchoring examples for classification — added 5 examples
- [warning] [feasibility] New .py file type in hooks/lib/ — noted, validate.sh check needed
- [warning] [completeness] Ambiguous dependency graph — rewritten with clear parallel notation
- [suggestion] compact event not addressed — documented: not in any matcher, intentional
- [suggestion] State machine over-engineering — simplified to split-and-partition
- [suggestion] No timeout for memory.py — added `timeout 3` wrapper

**Changes Made:**
1. Added constitution.md exclusion rationale before Architecture Overview
2. Replaced --skip-memory CLI args with session-start-clear.sh wrapper script (5 lines)
3. Rewrote parser from formal state machine to split-and-partition approach with defaults for missing fields
4. Added precise content hash definition (description text only, excluding header and metadata)
5. Added 5 anchoring examples for universal/project-specific classification
6. Added explicit priority sort criteria (observation count → confidence → recency)
7. Added `timeout 3` to memory.py subprocess call
8. Rewrote dependency graph with clear parallel notation
9. Documented compact event handling (not in matchers, intentional)
10. Added note about hooks/lib/ new file type check

---

## Design Review - Iteration 2 - 2026-02-17T04:05:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues (warnings, no blockers):**
- [warning] [consistency] Fill strategy overflow: aligned with spec (category-priority)
- [warning] [completeness] C1 dedup hash input not explicit: added note "Description text only"
- [warning] [consistency] Last observed format differs local vs global: clarified file position for local
- [warning] [feasibility] Inline Python interpolation anti-pattern: changed to stdin pipe

**Changes Made:** All 4 warnings addressed inline in design.md.

---

## Handoff Review - Iteration 1 - 2026-02-17T04:10:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues (warnings, no blockers):**
- [warning] macOS `timeout` command portability: added gtimeout/timeout detection pattern
- [warning] Heading-level collision in output format: noted, cosmetic
- [warning] Step 4c ordering relative to 4b: added explicit "MUST run after 4b" note
- [warning] Spec AC-1.6 superseded: added explicit deviation note with updated criterion

**Changes Made:** All 4 warnings addressed inline in design.md.

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-17T04:30:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] No TDD ordering — no test steps before implementation for ~120-line Python module
- [blocker] Step 3 line count claim (22 lines) unverifiable — actual content not shown
- [warning] Config defaults not clarified (enabled=true, limit=20)
- [warning] Timeout fallback behavior undefined (what if no timeout command)
- [warning] mkdir for .last-injection.json parent directory not mentioned
- [warning] validate.sh may not cover .py files in hooks/lib/
- [warning] Shell metacharacters in hash computation
- [warning] Fill strategy edge case when limit < total min-guarantees

**Changes Made:**
1. Added verification approach note (manual verification, no test framework for hook utilities)
2. Moved py_compile + functional verification into each step as "run immediately after"
3. Replaced line count claim with exact insertion text (20 lines, counted from content block)
4. Clarified config defaults match template (enabled=true, limit=20)
5. Documented timeout fallback: runs unguarded, acceptable for ~50ms operation
6. Added os.makedirs for .last-injection.json parent directory
7. Added validate.sh note about .py file coverage gap
8. Added fill strategy edge case handling (proportional reduction when limit < min-guarantees)
9. Added R4 (global store conflicts) to risk table
10. Specified exact config file path in Step 4 verification

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-17T04:45:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] HTML comment blocks in knowledge bank files contain `### ` entries that parser would parse as real entries
- [warning] Fill strategy edge case: "reduce proportionally" contradicts spec ("skip minimum guarantee")
- [warning] Step 3 heading level `#### Step 4c` inconsistent with existing `### Step 4b`
- [warning] File selection (hardcoded vs glob) not specified — constitution.md could be included
- [warning] Step 4 function placement description misleading ("after build_context()" vs "before main()")
- [warning] AC-1.8 performance test with 500 entries not in verification steps

**Changes Made:**
1. Added HTML comment stripping as preprocessing step in parse_entries
2. Added hardcoded filenames note (excludes constitution.md per design)
3. Aligned fill strategy edge case with spec: skip minimum guarantee, pure priority allocation
4. Fixed heading level: `### Step 4c` (matches `### Step 4b`)
5. Clarified function placement: "before main() (after existing build_context() function)"
6. Added AC-1.8 performance verification with 500 synthetic entries
7. Expanded spec deviations to clarify entire event-filtering mechanism is dropped
8. Added diagnostic guidance for Step 4 integration test

---
