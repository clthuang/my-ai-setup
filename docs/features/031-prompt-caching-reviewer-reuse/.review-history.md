# Review History: 031-prompt-caching-reviewer-reuse

## Implement Review - Iteration 1 - 2026-02-28T21:30:00Z

**Implementation Review:** Issues found
  - Level 1 (Tasks): pass
  - Level 2 (Spec): pass
  - Level 3 (Design): pass
  - Level 4 (PRD): pass
**Quality Review:** Issues found
**Security Review:** Issues found

**Issues:**
- [warning] [tasks] Implementation-reviewer: LAZY-LOAD-WARNING count audit (Task 16) — count verified correct at 15, no action needed
- [warning] [spec] Implementation-reviewer: NFR3 verification (Task 18) not yet executed — Phase 5 verification task, implement phase still in-progress
- [warning] [readability] Quality-reviewer: phase_iteration starts at 0 but fresh-dispatch condition checks == 1 — dead code condition relies on resume_state fallback (at: specify.md:204, design.md:403, create-plan.md:171, create-tasks.md:206)
  Suggestion: Change 'Set phase_iteration = 0' to 'Set phase_iteration = 1'
- [warning] [readability] Quality-reviewer: CHANGED_FILES includes implementing/SKILL.md but dispatch-block tests don't distinguish command files from skill files (at: test-token-efficiency-content.sh:63-71)
  Suggestion: Create separate COMMAND_FILES array for dispatch-block-specific tests
- [warning] [config] Security-reviewer: git add -A in 7e-commit stages all files, could include secrets (pre-existing pattern, not introduced by this feature) (at: implement.md:871)
  Suggestion: Use explicit file staging from files_changed list
- [suggestion] [formatting] Quality-reviewer: create-tasks.md uses ASCII '->' inconsistently vs Unicode '→' in other files
- [suggestion] [kiss] Quality-reviewer: implement.md 7d/7e duplicate dispatch decision logic (pseudocode then prose)
- [suggestion] [readability] Quality-reviewer: test function names slightly broader than actual grep patterns
- [suggestion] [exposure] Security-reviewer: Path traversal validation in fallback extraction is prose, not code (low severity)
- [suggestion] [exposure] Security-reviewer: Git diff in resumed prompts includes code content (informational, same trust boundary)

**Changes Made:**
1. Changed 'Set phase_iteration = 0' to 'Set phase_iteration = 1' in specify.md, design.md, create-plan.md, create-tasks.md (QUALITY WARNING: dead code)
2. Created COMMAND_FILES array in test-token-efficiency-content.sh, updated test_all_changed_files_have_required_artifacts to use COMMAND_FILES (QUALITY WARNING: array scope)
3. Changed 'git add -A' to 'git add {space-separated list of files from files_changed}' in implement.md 7e-commit (SECURITY WARNING: explicit staging)
4. Implementation-reviewer warnings are informational (count verified correct, NFR3 is Phase 5 task) — no code changes needed

---

LAZY-LOAD-WARNING: phase-reviewer did not confirm artifact reads
LAZY-LOAD-WARNING: phase-reviewer did not confirm artifact reads (iteration 1)
LAZY-LOAD-WARNING: phase-reviewer did not confirm artifact reads (iteration 2)

## Stage 2: Chain Review - Iteration 5 (cap) - 2026-02-28T20:25:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved with warnings (iteration cap reached — 5/5)

**Issues:**
- [warning] Tasks 8-12: Exceed 15-min task target, not further decomposable (at: Tasks 8-12)
- [warning] Task 12: Grep verification for decision matrix scenarios is label-dependent — may be vacuous (at: Task 12 acceptance criteria)

**Changes Made:**
None — warning 1 contradicts user directive against time/complexity estimates; warning 2 is non-blocking. Both noted as concerns in .meta.json.

---

## Stage 2: Chain Review - Iteration 4 - 2026-02-28T20:05:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (approved: true but 1 warning under strict threshold)

**Issues:**
- [warning] Task 7: Curly-brace placeholder notation inside code-fenced grep command is not valid shell (at: Task 7 Step 0b)
- [suggestion] Task 14: No fallback instruction if function name has drifted (at: Task 14 insertion point)

**Changes Made:**
1. Task 7: Removed curly-brace template notation entirely — Step 0b now uses only concrete example with prose instruction to repeat per file (WARNING)

---

## Stage 2: Chain Review - Iteration 3 - 2026-02-28T19:45:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (approved: true but 1 warning under strict threshold)

**Issues:**
- [warning] Task 7: Step 0b pattern construction lacks concrete escaping template for special regex characters in discovered headers (at: Task 7 Step 0b)
- [suggestion] Task 12: Grep verification is label-dependent — implementer must use literal annotation strings (at: Task 12 acceptance criteria)

**Changes Made:**
1. Task 7: Added explicit escaping template with rule (parentheses → `\(`, brackets → `\[`, etc.) and concrete command format (WARNING)

---

## Stage 2: Chain Review - Iteration 2 - 2026-02-28T19:25:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [blocker] Task 8: git add/diff commands target `plugins/iflow/commands/specify.md` (command file) instead of `{feature_path}/spec.md` (artifact under review) (at: Task 8 description items b and c)
- [warning] Task 1: V1 simplified prompt may not produce countable issue list for V4 validation (at: Task 1 V1 prompt vs V4 acceptance)
- [warning] Tasks 2-5 phase-reviewer ordering matches design I1-R4 canonical skeleton — no change needed (at: Tasks 2-5 acceptance criteria)

**Changes Made:**
1. Task 8: Replaced `plugins/iflow/commands/specify.md` with `{feature_path}/spec.md` in git add and git diff commands (BLOCKER)
2. Task 1: Updated V1 prompt to include "list any obvious issues you notice" for V4 countability, and clarified V4 passes with 0 count (WARNING)

---

## Stage 2: Chain Review - Iteration 1 - 2026-02-28T19:05:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [blocker] Task 7: `{actual_headers}` placeholder in Step 0b grep command is not valid shell — literal placeholder would produce vacuous matches (at: Task 7 description, Step 0b)
- [warning] Task 2: Missing acceptance criterion for PRD-resolution conditional preservation during reorder (at: Task 2 acceptance criteria)
- [suggestion] Task 8: NO_CHANGES path acceptance criteria should verify no RESUME-FALLBACK marker written (at: Task 8 acceptance criteria)

**Changes Made:**
1. Task 7: Replaced `{actual_headers}` placeholder with explicit substitution instructions — record discovered headers from Step 0a, construct grep patterns using actual text (BLOCKER)
2. Task 2: Added acceptance criterion for PRD resolution conditional preservation (WARNING)

---

## Stage 2: Chain Review - Iteration 0 - 2026-02-28T18:25:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [blocker] Task 15: Line 12 replacement content not specified — acceptance criteria unverifiable
- [warning] Task 14: Insertion point for new test function unspecified — may not execute
- [warning] Task 1: V4 call separation from V2+V3 ambiguous — could merge calls

**Changes Made:**
1. Task 15: Added explicit branch-conditional replacement text for line 12 (BLOCKER)
2. Task 14: Added insertion point guidance (WARNING)
3. Task 1: Added explicit 3-call enumeration note (WARNING)

---

## Task Review Iteration 5 - 2026-02-28T18:15:00Z

**Decision:** Needs Revision (iteration cap reached — 5/5)

**Issues (blockers — addressed post-review):**
- [blocker] Task 6: Wrong file path `implementation-reviewer/agent.md` → fixed to `implementation-reviewer.md`
- [blocker] Task 6: Incomplete schema excerpt missing `levels`/`evidence` fields → fixed with full schema
- [blocker] Task 8: `{phase}` placeholder ambiguous → resolved to literal `specify`
- [blocker] Task 8: Contradictory plan reference for NO_CHANGES → removed
- [blocker] Task 12: Self-attestation verification method → replaced with grep verification

**Issues (warnings — noted as concerns):**
- [warning] Task 1: V4 as separate resume call not explicitly called out
- [warning] Task 7: `{actual_headers}` placeholder not valid shell
- [warning] Task 15: Line 12 new content not specified
- [warning] Task 2: PRD-resolution edge case for no-PRD features
- [warning] Task 14: Insertion point in test file unspecified

**Changes Made:**
All 5 blockers addressed. Warnings noted as concerns in .meta.json.

---

## Task Review Iteration 4 - 2026-02-28T18:00:00Z

**Decision:** Needs Revision

**Issues:**
- [warning] Task 1: V2/V3 combined call lacks explicit failure attribution for partial failure (V2 pass, V3 fail)
- [warning] Task 7: No concrete list of expected section headers — engineer must guess grep patterns
- [warning] Task 8: NO_CHANGES behavior contradicts plan's "reuse previous delta" option
- [warning] Task 12: Self-attestation verification ("Mark each checked") not concrete

**Changes Made:**
1. Task 1: Added V2/V3 disambiguation rule in acceptance criteria (WARNING)
2. Task 7: Added Step 0a header discovery with concrete grep command (WARNING)
3. Task 8: Added note that design TD2 supersedes plan's "reuse previous delta" (WARNING)
4. Task 12: Replaced "trace each — mark checked" with line-number cross-reference method (WARNING)
5. All tasks: Removed Complexity fields per user directive (anti-pattern: estimates in create-tasks are pointless)

---

## Task Review Iteration 3 - 2026-02-28T17:45:00Z

**Decision:** Needs Revision

**Issues:**
- [warning] Task 1: V2/V3 combined call muddies V2 signal — unclear how to distinguish V2 pass from V3 pass in a single response
- [warning] Task 6: No pre-edit baseline count recorded — engineer has no reference to compare post-edit count against
- [warning] Task 7: No fallback if Step 0 reveals actual section headers don't match grep patterns
- [warning] Task 8: NO_CHANGES template ambiguity — unclear whether I3 fallback note should appear (NO_CHANGES is not a resume error)

**Changes Made:**
1. Task 1: Added explicit V2/V3 signal separation rationale (WARNING)
2. Task 6: Added pre-edit baseline recording step (WARNING)
3. Task 7: Added concrete mismatch recovery procedure (WARNING)
4. Task 8: Clarified NO_CHANGES uses plain I1-R4, not I3 (WARNING)

---

## Task Review Iteration 2 - 2026-02-28T17:20:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] Task 1: Pass-path documentation not specified — where to record gate decision when V1-V4 pass
- [blocker] Task 1: V2/V3 dispatch ambiguity — single or separate resume calls
- [blocker] Task 6: Schema-sourcing contradiction — agent.md vs design-prescribed schema
- [blocker] Task 7: Grep patterns may match no content, causing silent vacuous pass
- [blocker] Task 8: Commit message format conflicts between task and plan
- [blocker] Task 8: NO_CHANGES branch underspecified — which template to use
- [warning] Task 2: Spec-reviewer Required Artifacts contains only PRD, not spec.md
- [warning] Task 6: No verification command for selective re-dispatch preservation
- [warning] Task 8: Context compaction agent_id loss detection not spelled out
- [warning] Task 12: No verification method for 9 Decision Matrix scenarios
- [warning] Task 14: No guidance on dispatch block boundary detection
- [warning] Task 15: .meta.json path not fully qualified

**Changes Made:**
Addressing all blockers and warnings in tasks.md revision below.

---

LAZY-LOAD-WARNING: task-reviewer did not confirm artifact reads

## Task Review Iteration 1 - 2026-02-28T16:50:00Z

**Decision:** Needs Revision

**Issues:**
- [blocker] All tasks: Time estimates used instead of complexity levels → Replace "Estimate: X min" with "Complexity: Simple|Medium|Complex"
- [blocker] Task 8: NO_CHANGES acceptance criterion omits resume_state[role] reset → Add reset step
- [blocker] Task 8: Git commit message placeholder '...' unresolved → Use exact pattern from TD2: "iflow: {phase} review iteration {n}"
- [warning] Task 1: V3/V4 ambiguous whether separate resume calls → Clarify each as separate Task({resume:...}) call
- [warning] Task 7: grep uses \| without -E flag → Add -E for extended regex
- [warning] Task 17: Same grep -E issue + bundled audits → Fix grep, annotate each check with pass/fail marker
- [warning] Task 13: Dependencies omit Task 7 (R4 Checkpoint) → Add Task 7 to dependency list

**Changes Made:**
Addressing all blockers and warnings in tasks.md revision below.

---

## Stage 2: Chain Review - Iteration 4 - 2026-02-28T16:30:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
(none)

**Changes Made:**
(none required)

---

## Stage 2: Chain Review - Iteration 3 - 2026-02-28T16:20:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Phase 4 item 3 mixes two distinct work items: (a) update test_fresh_dispatch_in_all_reviewer_loops and (b) audit test_total_i9_warning_count — risks implementer treating audit as implicit (at: Phase 4, item 3)
- [warning] Phase 5 item 3 "manual inspection of 5 files" is weakest verification step — no concrete method beyond visual examination (at: Phase 5, item 3)
- [suggestion] Dependency graph still ambiguous about per-file vs sequential within phases

**Changes Made:**
1. Split Phase 4 item 3 into two items: item 3 (test function update + header comment) and item 4 (LAZY-LOAD-WARNING count audit) (WARNING)
2. Replaced "manual inspection" in Phase 5 item 3 with concrete grep command from R4 Checkpoint step 2 (WARNING)
3. Suggestion noted — dependency graph notes already clarify sequential execution strategy (no change)

---

## Stage 2: Chain Review - Iteration 2 - 2026-02-28T16:10:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Fallback tracking test is interactive and non-automatable — no acknowledgment or fallback path (at: Phase 5, item 5)
- [warning] Phase 3 items lack individual Phase 2 prerequisite references (at: Phase 3, items 1-5)

**Changes Made:**
1. Added "interactive, non-automatable" acknowledgment and deferral note to fallback tracking test (WARNING)
2. Added explicit "Prerequisite: Phase 2 item N" to each Phase 3 item (WARNING)

---

## Stage 2: Chain Review - Iteration 1 - 2026-02-28T16:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Phase 4 item 3 does not mention test_total_i9_warning_count (line ~914) which asserts 15 LAZY-LOAD-WARNINGs — could break if R4/R1 changes affect the count (at: Phase 4, item 3)

**Changes Made:**
1. Added test_total_i9_warning_count audit to Phase 4 item 3 deliverable with verification grep command

---

## Stage 1: Plan Review - Iteration 4 - 2026-02-28T15:50:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [warning] [assumption] Dependency graph ASCII diagram missing Phase 2 → Phase 3 arrow (at: Dependency Graph)
  Suggestion: Add connecting arrow from Phase 2 to Phase 3.
- [warning] [assumption] COMMIT_OK/COMMIT_FAILED and NO_CHANGES patterns not unified into single command (at: Phase 3 preamble + item 1)
  Suggestion: Provide reconciled three-state Bash command.
- [suggestion] Fallback tracking test manual corruption mechanism relies on LLM cooperating with meta-instruction

**Changes Made:**
1. Updated dependency graph to show sequential Phase 1 → Phase 2 → Phase 3 flow (WARNING: diagram)
2. Unified git patterns into three-state command: `git add {path} && git diff --cached --quiet && echo NO_CHANGES || (git commit -m "..." && echo COMMIT_OK || echo COMMIT_FAILED)` (WARNING: Bash pattern)
3. Suggestion noted — no plan change needed (manual test feasibility is acceptable)

---

## Stage 1: Plan Review - Iteration 3 - 2026-02-28T15:35:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [dependency] Plan deviates from design's TD2 `git add -A` for implement.md without acknowledging the override (at: Phase 3, item 5)
  Suggestion: Align with design's `git add -A` or acknowledge deviation.
- [blocker] [tdd-order] No persistent regression test for R4 ordering — R4 Checkpoint is ad-hoc grep, not automated test (at: Phase 2, all items)
  Suggestion: Add persistent test function to test-token-efficiency-content.sh.
- [warning] [failure-mode] Git failure detection markers not specified for LLM orchestrator (at: Phase 3, all items)
  Suggestion: Use COMMIT_OK/COMMIT_FAILED explicit markers.
- [warning] [assumption] V1 simplified prompt does not test resume with production I1-R4 template structure (at: Phase 1)
  Suggestion: Acknowledge as known limitation.
- [warning] [dependency] Phase 1/Phase 2 overlap ambiguity — can Phase 2 start before Phase 1 completes? (at: Phase 2 header)
  Suggestion: Clarify recommended execution order.
- [warning] [failure-mode] Context compaction could lose resume_state agent_id for implement.md long loops (at: Phase 3, item 5)
  Suggestion: Explicit I3 fallback note for agent_id loss.
- [warning] [assumption] New files created by implementer not in original file list won't be staged with `git add {specific_files}` (at: Phase 3, Assumption block)
  Suggestion: Use `git add -A` as design specifies.
- [warning] [feasibility] NFR3 worst-case at guard boundary fails NFR3 — spec has hard requirement language (at: Phase 5, item 4)
  Suggestion: Make decision explicit: representative conditions or spec amendment.
- [warning] [dependency] Test file header comment at line 12 references "Fresh dispatch" phrase (at: Phase 4, item 3)
  Suggestion: Update header comment alongside test function.
- [suggestion] Read implementation-reviewer agent.md before constructing Phase 2 item 5 JSON schema
- [suggestion] Concrete corruption mechanism for fallback tracking test
- [suggestion] Phase 3 items practically sequential despite being logically independent

**Changes Made:**
1. Reverted implement.md to `git add -A` per design TD2 (BLOCKER: design deviation)
2. Added Phase 4 item 2: `test_json_schema_before_artifact_content` regression test (BLOCKER: R4 test)
3. Added COMMIT_OK/COMMIT_FAILED markers to Phase 3 git patterns and Assumption block (WARNING: failure detection)
4. Added V1 known limitation note about simplified vs production prompt (WARNING: V1 scope)
5. Added Phase 2 execution order clarification (WARNING: Phase 1/2 overlap)
6. Added context compaction agent_id loss → I3 fallback note to implement.md deliverable (WARNING: compaction)
7. Aligned Assumption block with `git add -A` for implement.md (WARNING: new files)
8. Made NFR3 decision explicit: validated under representative conditions, threshold tunable post-deployment (WARNING: NFR3)
9. Added test file header comment update to Phase 4 item 3 (WARNING: header comment)
10. Added pre-step to read implementation-reviewer agent.md for Phase 2 item 5 (SUGGESTION)
11. Updated fallback test with concrete corruption mechanism via chat instruction (SUGGESTION)
12. Clarified Phase 3 internal ordering: practically sequential, item 1 establishes pattern (SUGGESTION)
13. Updated Testing Strategy and Definition of Done for R4 regression test

---

## Design Review - Iteration 1 - 2026-02-28T13:30:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Annotation count stated as 13 but actual is 12; 0 in implement.md (at: Architecture Overview annotation count)
  Challenge: Verify by grep — implement.md has zero "Fresh dispatch" annotations.
- [blocker] [completeness] I1-R4 canonical template assumes uniform prompt structure across all reviewers, but plan-reviewer and task-reviewer have no Iteration Context, implementation-reviewer has prose-only return (at: I1-R4 template + deviations)
  Challenge: Each reviewer's prompt structure must be documented individually.
- [blocker] [feasibility] TD2 "In-memory string comparison" conflates LLM orchestration with programmatic operations — LLMs cannot compute diffs (at: TD2)
  Challenge: The orchestrator is an LLM following markdown instructions; it needs Bash tool for diffs.
- [warning] [consistency] TD3 specifies `git diff HEAD~1` but no per-iteration commits exist (at: TD3)
  Challenge: Without intermediate commits, git diff shows cumulative changes.
- [warning] [completeness] I2-FV references git diff between iterations but resume_state has no commit SHA field (at: I2-FV + I6)
  Challenge: Need `last_commit_sha` field for diff range calculation.
- [warning] [completeness] Per-reviewer JSON schema field variations not documented — task-reviewer uses 'task' not 'location', plan-reviewer omits 'category', implementation-reviewer has prose (at: I1-R4 deviations)
  Challenge: Schema deviations must be explicit so implementation doesn't use wrong fields.
- [warning] [assumptions] R4 token count benefit not estimated — stable prefix may be below 1,024-token minimum (at: R4 section)
  Challenge: Estimate actual token savings to validate R4 value proposition.
- [warning] [completeness] Unified text diff format for R1.2a unspecified for LLM orchestrator (at: TD2)
  Challenge: LLM needs explicit mechanism (Bash tool) to produce diffs.
- [suggestion] Move "Your job: Find weaknesses..." rubric coda to stable prefix
- [suggestion] Add decision matrix table for implement.md template variants

**Changes Made:**
1. Fixed annotation count from 13 to 12, removed incorrect implement.md claim, documented per-reviewer prompt structure variations
2. Replaced simplified BEFORE/AFTER diagram with per-reviewer R4 transformation table showing exact current-to-target reordering. Added token count estimate with explanation of how Claude Code cache breakpoints work
3. Replaced TD2 "In-Memory Diff" with "Bash Diff" approach using `cp` + `diff -u` via Bash tool. Added explicit mechanism steps for command files
4. Updated TD3 to specify per-iteration commits: `git add -A && git commit -m "review iteration {n} fixes"` after each implementer fix dispatch
5. Added `last_commit_sha` field to I6 resume_state dict with lifecycle documentation
6. Added per-reviewer JSON schema field deviations to I1-R4 per-command deviations (task-reviewer 'task' field, plan-reviewer no 'category', implementation-reviewer prose→explicit JSON, code-quality/security-reviewer specific categories)
7. Added R4 Guiding Principle statement: "All static content MUST appear at TOP, all dynamic content MUST appear at BOTTOM"
8. Updated C3 component description from "In-memory string comparison preferred" to Bash diff mechanism
9. Updated implement.md File Change Summary row (removed incorrect "1 annotation" claim, added explicit JSON schema block for implementation-reviewer)
10. Added Template Selection Decision Matrix for implement.md dispatch scenarios
11. Moved rubric coda into stable prefix in I1-R4 template, added validate/check list placement in template
12. Updated R4 transformation table with explicit column showing reordered structure per reviewer

---

## Design Review - Iteration 2 - 2026-02-28T14:00:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] I2 template uses `git diff HEAD~1` but I6 specifies `git diff {last_commit_sha} HEAD`. Contradictory — HEAD~1 is wrong for selective re-dispatch where multiple commits intervene (at: I2 delta section + I6 last_commit_sha)
  Challenge: HEAD~1 only works when exactly one commit separates iterations; selective re-dispatch and final validation break this assumption.
- [warning] [consistency] design-reviewer agent's JSON schema has 'challenge' field not in dispatch prompt (uses 'suggestion' instead). Pre-existing but should document (at: I1-R4 per-command deviations)
  Challenge: Implementation may use wrong field name if not documented.
- [warning] [feasibility] Empty commit scenario — `git commit` fails if no changes staged. Need to handle (at: TD2 mechanism)
  Challenge: If orchestrator revisions produce no file changes, git commit exits non-zero.
- [warning] [consistency] Spec R1.2a prefers in-memory first, design uses git exclusively. Should document deviation (at: TD2 rationale)
  Challenge: Spec says "prefer simplest available mechanism: in-memory string comparison" — design should acknowledge deviation.
- [warning] [consistency] TD3 numbering gap (merged into TD2). Should document or renumber (at: Technical Decisions section)
  Challenge: Missing TD3 confuses implementers looking for sequential numbering.
- [warning] [completeness] 50% delta size guard applicability to I2-FV not stated (at: I2-FV section)
  Challenge: Unclear whether final validation resumes are subject to delta size guard.
- [suggestion] .meta.json schema change for r1_deferred_reason not in File Change Summary
- [suggestion] Per-iteration commits may pollute git history — check finish-feature squash logic

**Changes Made:**
1. Fixed I2 template and TD2 decision text to use `git diff {last_commit_sha} HEAD` consistently instead of `HEAD~1` (BLOCKER)
2. Fixed C3 component descriptions to use `{last_commit_sha}` instead of `HEAD~1` for consistency
3. Added `git diff --cached --quiet && echo "NO_CHANGES" || git commit` pattern in TD2 mechanism for empty commit handling (WARNING: empty commit)
4. Added spec deviation acknowledgment in TD2 rationale: "The spec prefers in-memory string comparison, but the orchestrator is an LLM that cannot programmatically compute diffs." (WARNING: spec deviation)
5. Added "TD3 merged into TD2" note between TD2 and TD4 (WARNING: numbering gap)
6. Added explicit delta size guard exemption for I2-FV: "50% threshold does NOT apply to I2-FV. Final validation is mandatory." (WARNING: delta guard for I2-FV)
7. Documented design-reviewer 'challenge' vs 'suggestion' field inconsistency in per-command deviations (WARNING: field mismatch)
8. Added .meta.json row to File Change Summary for r1_deferred_reason field (SUGGESTION)
9. Updated TD2 working commits note: finish-feature uses `git merge` (not `--squash`), per-iteration commits persist as audit trail (SUGGESTION)

---

## Design Review - Iteration 3 - 2026-02-28T14:30:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [warning] [completeness] resume_state not explicitly documented as reset when "Fix and rerun reviews" resets iteration counters (at: TD4 / I6)
  Challenge: Stale agent_ids could be used if resume_state survives a rerun.
- [warning] [consistency] spec-reviewer stable prefix is thinner (only PRD line) — cache benefit is minimal (at: I1-R4 per-command deviations)
  Challenge: Reviewer self-withdrew — already documented, no change needed.
- [warning] [feasibility] Context compaction could lose stored SHAs mid-loop (at: TD2)
  Challenge: LLM has no variable binding; SHA values must survive in context across turns.
- [warning] [completeness] git diff handles file deletions in implement.md I2 (at: I2 template)
  Challenge: Reviewer self-withdrew — git diff --stat correctly shows deletions.
- [suggestion] Add suggested order for R4 implementation across 5 files (at: Implementation Sequence)
- [suggestion] Phase-reviewer static section ordering within stable prefix (at: I1-R4 / R4 table)

**Changes Made:**
1. Added "Reset on rerun" note in TD4: resume_state is reset when iteration counters reset (WARNING: resume_state rerun)
2. Added context compaction SHA fallback note in TD2: fall back to I3 fresh dispatch if SHA lost (WARNING: context compaction)
3. Warnings 2 and 4 self-withdrawn by reviewer — no changes needed
4. Suggestions noted as low-priority — not blocking

---

## Handoff Review - Iteration 1 - 2026-02-28T14:40:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Implementation sequence does not explicitly state conditional branch for R1.0 failure (at: Implementation Sequence)
- [warning] Template Selection Decision Matrix missing implementer fix delta-too-large row (at: Decision Matrix)
- [suggestion] NO_CHANGES branch in TD2 does not specify resume_state behavior (at: TD2 mechanism)

**Changes Made:**
1. Added explicit conditional branch in Implementation Sequence: "If R1.0 fails: skip step 3, proceed with steps 2, 4, 5 only"
2. Added implementer fix delta-too-large row to Template Selection Decision Matrix
3. Added resume_state reset note for NO_CHANGES branch in TD2

---

## Handoff Review - Iteration 2 - 2026-02-28T14:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
(none)

**Changes Made:**
(none required)

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-28T15:20:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Phase 4 dependency description contradicts itself for R1.0 failure case — says "Depends on Phase 2 and Phase 3" but also "Applies regardless of R1.0 outcome" (at: Phase 4 header)
  Suggestion: Reword to clarify Phase 3 dependency is conditional on R1.0 pass.
- [blocker] [completeness] Phase 3 items missing git commit/diff failure fallback in deliverables — design TD2 documents fallback but plan deliverables omit it (at: Phase 3 items 1-5)
  Suggestion: Add "(h) git commit/diff failure falls back to fresh dispatch per TD2 fallback" to all deliverables.
- [blocker] [tdd-order] No automated verification of R4 section ordering — R4 Checkpoint only checks schema presence, not that schema lines precede content lines (at: R4 Checkpoint)
  Suggestion: Add section ordering grep comparing line numbers.
- [warning] [feasibility] `git add -A` in implement.md could commit unrelated changes with misleading messages (at: Phase 3 item 5)
  Suggestion: Use `git add {specific_files}` from implementation files list.
- [warning] [completeness] Removing test entirely when R1.0 fails loses behavioral pinning for annotation removal (at: Phase 4 item 2)
  Suggestion: Replace with inverted assertion verifying annotations do NOT appear.
- [warning] [consistency] Dependency graph ambiguity — sequential vs interleaved execution strategy not stated (at: Dependency Graph notes)
  Suggestion: Clarify whether phases execute sequentially or can be interleaved per-file.
- [warning] [assumptions] NFR3 worst-case ratio at delta guard boundary = 60% (fails NFR3) (at: Phase 5 item 4)
  Suggestion: Document limitation and representative vs worst-case distinction.
- [warning] [completeness] implement.md delta size guard comparison baseline unclear — I1 prompt length excludes file contents read via Read tool (at: Phase 3 item 5)
  Suggestion: Document what I1 prompt length includes for delta guard calculation.
- [suggestion] Fallback tracking test (Phase 5, item 5) needs concrete test procedure
- [suggestion] R4 Checkpoint implementation-reviewer specific check could be more targeted

**Changes Made:**
1. Fixed Phase 4 dependency wording: conditional on R1.0 pass for Phase 3 dependency (BLOCKER)
2. Added git commit/diff failure fallback to all Phase 3 deliverables (BLOCKER)
3. Enhanced R4 Checkpoint with two-step verification: schema presence + section ordering (BLOCKER)
4. Changed implement.md to use `git add {specific_files}` instead of `git add -A` (WARNING)
5. Updated Phase 4 item 2: inverted assertion if R1.0 fails (WARNING)
6. Added execution strategy clarification to dependency graph notes: sequential by phase (WARNING)
7. Added NFR3 worst-case analysis at guard boundary with limitation documentation (WARNING)
8. Documented implement.md I1 prompt length baseline for delta guard (WARNING)
9. Added concrete fallback tracking test procedure (SUGGESTION)

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-28T15:10:00Z

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [dependency] Phase 4 annotation removal will break `test_fresh_dispatch_in_all_reviewer_loops` test in `test-token-efficiency-content.sh:811` that asserts annotations are present (at: Phase 4, item 1)
  Suggestion: Add plan item to update or remove the test alongside annotation removal.
- [warning] [dependency] Phase 2/3 not truly independent — Phase 3's I3 fallback references R4-reordered I1 template from Phase 2. Per-file dependency needed (at: Dependency Graph notes)
  Suggestion: Correct to per-file dependency: R4 before R1 on same file.
- [warning] [assumption] Git working tree cleanliness assumed for TD2 but not documented. Unrelated uncommitted changes could pollute deltas (at: Phase 3 all items)
  Suggestion: Document assumption explicitly. Note `git add {artifact}` for phase commands and delta guard self-correction for implement.md.
- [warning] [failure-mode] "Fix and rerun reviews" resets resume_state but old per-iteration git commits persist. New iteration 1 diff anchor unclear (at: Phase 3 item 1)
  Suggestion: Clarify that fresh iteration 1 establishes new SHA anchor; old commits are harmless history.
- [warning] [tdd-order] No intermediate verification between Phase 2 (R4) and Phase 3 (R1). R4 breakage not caught before R1 layers on top (at: Phase 5)
  Suggestion: Add R4 checkpoint grep between Phase 2 and Phase 3.
- [warning] [feasibility] grep verification for implement.md R4 cannot distinguish old prose from new JSON schema block (at: Phase 2 item 5 verification)
  Suggestion: Use more specific verification checking for `"approved":` pattern in the 7a dispatch block.
- [warning] [assumption] V1 dispatch does not specify which spec.md to use for validation test (at: Phase 1 item 1)
  Suggestion: Explicitly state V1 uses current feature's spec.md.
- [suggestion] NFR3 validation needs concrete computation formula with specified inputs

**Changes Made:**
1. Added V1 spec.md path to Phase 1 item 1 (BLOCKER: test regression)
2. Added Phase 4 item 2: update `test_fresh_dispatch_in_all_reviewer_loops` test (BLOCKER)
3. Updated dependency graph and notes: per-file dependency Phase 2 → Phase 3 (WARNING: dependency)
4. Added git working tree assumption and self-correction note to Phase 3 preamble (WARNING: assumption)
5. Clarified "Fix and rerun" SHA handling in Phase 3 item 1 deliverable (WARNING: failure-mode)
6. Added R4 Checkpoint after Phase 2 item 5 with grep command (WARNING: tdd-order)
7. Updated Phase 2 item 5 verification to check for `"approved":` pattern (WARNING: feasibility)
8. Specified V1 uses `docs/features/031-prompt-caching-reviewer-reuse/spec.md` (WARNING: assumption)
9. Added concrete NFR3 computation formula with representative inputs (SUGGESTION)
10. Updated Risk Areas, Testing Strategy, and Definition of Done for test regression item

---
