# Review History: 031-prompt-caching-reviewer-reuse

## Design Review - Iteration 1 - 2026-02-28T13:30:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Annotation count stated as 13 but actual is 12; 0 in implement.md (at: Architecture Overview annotation count)
  Challenge: Verify by grep — implement.md has zero "Fresh dispatch" annotations.
- [blocker] [completeness] I1-R4 canonical template assumes uniform prompt structure across all reviewers, but plan-reviewer and task-reviewer have no Iteration Context, implementation-reviewer has prose-only return (at: I1-R4 template + deviations)
  Challenge: Each reviewer's prompt structure must be documented individually.
- [blocker] [feasibility] TD2 "In-memory string comparison" conflates LLM orchestration with programmatic operations — LLMs cannot compute diffs (at: TD2)
  Challenge: The orchestrator is an LLM following markdown instructions; it needs Bash tool for diffs.
- [warning] [consistency] TD3 specifies `git diff HEAD~1` but no per-iteration commits exist (at: TD3)
  Challenge: Without intermediate commits, git diff shows cumulative changes.
- [warning] [completeness] I2-FV references git diff between iterations but resume_state has no commit SHA field (at: I2-FV + I6)
  Challenge: Need `last_commit_sha` field for diff range calculation.
- [warning] [completeness] Per-reviewer JSON schema field variations not documented — task-reviewer uses 'task' not 'location', plan-reviewer omits 'category', implementation-reviewer has prose (at: I1-R4 deviations)
  Challenge: Schema deviations must be explicit so implementation doesn't use wrong fields.
- [warning] [assumptions] R4 token count benefit not estimated — stable prefix may be below 1,024-token minimum (at: R4 section)
  Challenge: Estimate actual token savings to validate R4 value proposition.
- [warning] [completeness] Unified text diff format for R1.2a unspecified for LLM orchestrator (at: TD2)
  Challenge: LLM needs explicit mechanism (Bash tool) to produce diffs.
- [suggestion] Move "Your job: Find weaknesses..." rubric coda to stable prefix
- [suggestion] Add decision matrix table for implement.md template variants

**Changes Made:**
1. Fixed annotation count from 13 to 12, removed incorrect implement.md claim, documented per-reviewer prompt structure variations
2. Replaced simplified BEFORE/AFTER diagram with per-reviewer R4 transformation table showing exact current-to-target reordering. Added token count estimate with explanation of how Claude Code cache breakpoints work
3. Replaced TD2 "In-Memory Diff" with "Bash Diff" approach using `cp` + `diff -u` via Bash tool. Added explicit mechanism steps for command files
4. Updated TD3 to specify per-iteration commits: `git add -A && git commit -m "review iteration {n} fixes"` after each implementer fix dispatch
5. Added `last_commit_sha` field to I6 resume_state dict with lifecycle documentation
6. Added per-reviewer JSON schema field deviations to I1-R4 per-command deviations (task-reviewer 'task' field, plan-reviewer no 'category', implementation-reviewer prose→explicit JSON, code-quality/security-reviewer specific categories)
7. Added R4 Guiding Principle statement: "All static content MUST appear at TOP, all dynamic content MUST appear at BOTTOM"
8. Updated C3 component description from "In-memory string comparison preferred" to Bash diff mechanism
9. Updated implement.md File Change Summary row (removed incorrect "1 annotation" claim, added explicit JSON schema block for implementation-reviewer)
10. Added Template Selection Decision Matrix for implement.md dispatch scenarios
11. Moved rubric coda into stable prefix in I1-R4 template, added validate/check list placement in template
12. Updated R4 transformation table with explicit column showing reordered structure per reviewer

---

## Design Review - Iteration 2 - 2026-02-28T14:00:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] I2 template uses `git diff HEAD~1` but I6 specifies `git diff {last_commit_sha} HEAD`. Contradictory — HEAD~1 is wrong for selective re-dispatch where multiple commits intervene (at: I2 delta section + I6 last_commit_sha)
  Challenge: HEAD~1 only works when exactly one commit separates iterations; selective re-dispatch and final validation break this assumption.
- [warning] [consistency] design-reviewer agent's JSON schema has 'challenge' field not in dispatch prompt (uses 'suggestion' instead). Pre-existing but should document (at: I1-R4 per-command deviations)
  Challenge: Implementation may use wrong field name if not documented.
- [warning] [feasibility] Empty commit scenario — `git commit` fails if no changes staged. Need to handle (at: TD2 mechanism)
  Challenge: If orchestrator revisions produce no file changes, git commit exits non-zero.
- [warning] [consistency] Spec R1.2a prefers in-memory first, design uses git exclusively. Should document deviation (at: TD2 rationale)
  Challenge: Spec says "prefer simplest available mechanism: in-memory string comparison" — design should acknowledge deviation.
- [warning] [consistency] TD3 numbering gap (merged into TD2). Should document or renumber (at: Technical Decisions section)
  Challenge: Missing TD3 confuses implementers looking for sequential numbering.
- [warning] [completeness] 50% delta size guard applicability to I2-FV not stated (at: I2-FV section)
  Challenge: Unclear whether final validation resumes are subject to delta size guard.
- [suggestion] .meta.json schema change for r1_deferred_reason not in File Change Summary
- [suggestion] Per-iteration commits may pollute git history — check finish-feature squash logic

**Changes Made:**
1. Fixed I2 template and TD2 decision text to use `git diff {last_commit_sha} HEAD` consistently instead of `HEAD~1` (BLOCKER)
2. Fixed C3 component descriptions to use `{last_commit_sha}` instead of `HEAD~1` for consistency
3. Added `git diff --cached --quiet && echo "NO_CHANGES" || git commit` pattern in TD2 mechanism for empty commit handling (WARNING: empty commit)
4. Added spec deviation acknowledgment in TD2 rationale: "The spec prefers in-memory string comparison, but the orchestrator is an LLM that cannot programmatically compute diffs." (WARNING: spec deviation)
5. Added "TD3 merged into TD2" note between TD2 and TD4 (WARNING: numbering gap)
6. Added explicit delta size guard exemption for I2-FV: "50% threshold does NOT apply to I2-FV. Final validation is mandatory." (WARNING: delta guard for I2-FV)
7. Documented design-reviewer 'challenge' vs 'suggestion' field inconsistency in per-command deviations (WARNING: field mismatch)
8. Added .meta.json row to File Change Summary for r1_deferred_reason field (SUGGESTION)
9. Updated TD2 working commits note: finish-feature uses `git merge` (not `--squash`), per-iteration commits persist as audit trail (SUGGESTION)

---

## Design Review - Iteration 3 - 2026-02-28T14:30:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [warning] [completeness] resume_state not explicitly documented as reset when "Fix and rerun reviews" resets iteration counters (at: TD4 / I6)
  Challenge: Stale agent_ids could be used if resume_state survives a rerun.
- [warning] [consistency] spec-reviewer stable prefix is thinner (only PRD line) — cache benefit is minimal (at: I1-R4 per-command deviations)
  Challenge: Reviewer self-withdrew — already documented, no change needed.
- [warning] [feasibility] Context compaction could lose stored SHAs mid-loop (at: TD2)
  Challenge: LLM has no variable binding; SHA values must survive in context across turns.
- [warning] [completeness] git diff handles file deletions in implement.md I2 (at: I2 template)
  Challenge: Reviewer self-withdrew — git diff --stat correctly shows deletions.
- [suggestion] Add suggested order for R4 implementation across 5 files (at: Implementation Sequence)
- [suggestion] Phase-reviewer static section ordering within stable prefix (at: I1-R4 / R4 table)

**Changes Made:**
1. Added "Reset on rerun" note in TD4: resume_state is reset when iteration counters reset (WARNING: resume_state rerun)
2. Added context compaction SHA fallback note in TD2: fall back to I3 fresh dispatch if SHA lost (WARNING: context compaction)
3. Warnings 2 and 4 self-withdrawn by reviewer — no changes needed
4. Suggestions noted as low-priority — not blocking

---

## Handoff Review - Iteration 1 - 2026-02-28T14:40:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Implementation sequence does not explicitly state conditional branch for R1.0 failure (at: Implementation Sequence)
- [warning] Template Selection Decision Matrix missing implementer fix delta-too-large row (at: Decision Matrix)
- [suggestion] NO_CHANGES branch in TD2 does not specify resume_state behavior (at: TD2 mechanism)

**Changes Made:**
1. Added explicit conditional branch in Implementation Sequence: "If R1.0 fails: skip step 3, proceed with steps 2, 4, 5 only"
2. Added implementer fix delta-too-large row to Template Selection Decision Matrix
3. Added resume_state reset note for NO_CHANGES branch in TD2

---

## Handoff Review - Iteration 2 - 2026-02-28T14:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
(none)

**Changes Made:**
(none required)

---
