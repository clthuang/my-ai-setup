# Review History — Feature 028: Enriched Documentation Phase

## Design Review - Iteration 0 - 2026-02-25T20:20:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] Hardcoded `plugins/iflow/references/doc-schema.md` paths violate CLAUDE.md plugin portability rules and will fail validate.sh (at: C1, C2, C3, C4, I2, I4)
- [blocker] [completeness] Inconsistency about whether agents read doc-schema.md themselves or receive it inlined in prompts (at: C2, C3, I2)
- [blocker] [completeness] Drift detection output format does not match spec's required `{ tier, file, last_updated, latest_source_change, reason }` schema (at: I1)
- [warning] [consistency] C8 parenthetical '(currently defined in wrap-up skill)' is wrong — wrap-up is a command (at: C8)
- [warning] [consistency] Writer "do not create new files" constraint wording mischaracterized — existing constraint is conditional "unless explicitly needed" (at: C3)
- [warning] [completeness] Scaffold dispatch budget unclear: 1 researcher + 1 writer per tier clarification needed (at: C4)
- [warning] [completeness] Doc tier directories vs {iflow_artifacts_root} path semantics not clarified (at: Architecture Overview)
- [warning] [completeness] No adaptation instructions for existing docs structure beyond non-overwriting (at: I2a)
- [warning] [assumptions] ADR supersession matching reliability for LLM — needs integration testing (at: R3, C3)
- [warning] [completeness] Tier-to-source monitoring directory mapping not specified in design (at: C2, I7)
- [warning] [completeness] Token budget for multi-feature ADR extraction unbounded in generate-docs (at: C5, I5)

**Changes Made:**
- C1: Added access pattern using two-location Glob + inline content injection; agents never reference file path directly
- C2: Changed to receive doc-schema.md inlined in prompt; added tier_drift output array matching spec format
- C3: Changed to receive doc-schema.md inlined in prompt; clarified "do not create new files" constraint is satisfied by scaffold mode context
- C4: Clarified scaffold dispatch as 1 researcher + 3 writers (max 4); changed to content injection via calling command
- C5: Added 10-feature cap for ADR extraction; added doc sync implementation note
- C8: Fixed parenthetical to "(modify existing command)"
- Architecture Overview: Added path semantics clarification (docs/ always at project root, independent of artifacts_root)
- I1: Added tier_drift array with spec-required format
- I2: Added prompt assembly priority ordering
- I2a: Added adaptation instructions (cross-reference existing docs, add cross-links)
- I4: Removed hardcoded path, replaced with inlined content
- I6: Added empty tiers early exit behavior
- I7: Added tier-to-source monitoring directory mapping section
- R3: Added integration testing and verification requirements
- Plugin-Level References technical decision: Added two-location Glob and portability rationale

---

## Design Review - Iteration 1 - 2026-02-25T20:45:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Scaffold dispatch budget does not account for README/CHANGELOG as a separate concern — budget was 4 but README/CHANGELOG needs a 5th dispatch (at: C4, I9)
- [blocker] [consistency] Generate-docs command frontmatter uses structured `arguments` YAML field that doesn't exist in the command system — all existing commands use `argument-hint` flat string (at: I5)
- [warning] [completeness] tier_drift entries do not force no_updates_needed to false — interaction with existing Critical Rule undefined (at: C2, I1, I9)
- [warning] [completeness] Scaffold-during-finish-feature UX: heavy scaffolding mid-feature-completion could surprise users — no opt-out described (at: C7, I9)
- [warning] [feasibility] Incremental mode prompt size has no fallback strategy when all tiers + ADRs + README/CHANGELOG converge (at: C3, R1)
- [warning] [assumptions] Config injection assumes .claude/ exists — projects without it need default handling clarification (at: C6, I6)
- [warning] [completeness] Workflow-artifacts.md page format unspecified — writer may produce inconsistent output (at: I2a, I7)
- [warning] [consistency] YAML frontmatter last-updated format ambiguous — "ISO date" vs full ISO 8601 datetime (at: I7, I8)

**Changes Made:**
- C4: Updated scaffold dispatch budget to max 5 (1 researcher + 3 tier writers + 1 README/CHANGELOG writer); clarified per-tier writers focus exclusively on their tier
- I5: Replaced structured `arguments` field with standard `argument-hint: "[mode]"` matching existing command frontmatter convention
- C2: Added Critical Rule extension — tier_drift entries also force no_updates_needed to false
- I1: Added dual drift mechanism note explaining drift_detected vs tier_drift relationship
- C7: Added Scaffold UX gate — prompt user before scaffolding during finish-feature with Skip/Scaffold/Defer options
- I9: Added step 1b (Scaffold UX gate), updated step 3 to check tier_drift, split step 5 into 5 (tier writers) + 5b (README/CHANGELOG)
- R1: Added incremental mode fallback strategy — shed ADR Context first per I2 priority, then split into 2 writer dispatches
- C6: Added note that read_local_md_field handles missing files by returning default value (existing pattern)
- I7: Added workflow-artifacts.md table format specification (Feature, Status, Artifacts columns)
- I7: Specified last-updated as full ISO 8601 datetime with UTC timezone (e.g., 2026-02-25T14:30:00Z)
- I8: Updated ADR frontmatter to match datetime format
- I7: Replaced vague "config files" and "architecture-relevant files" in tier-to-source mapping with concrete file patterns

---

## Design Review - Iteration 2 - 2026-02-25T21:10:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [consistency] Ambiguity about whether updating-docs skill or commands (finish-feature/wrap-up) orchestrate dispatches — both commands inline dispatches directly, never invoke the skill (at: C4, C7, C8, TD implicit)
- [warning] [completeness] YOLO mode behavior for enriched doc pipeline not specified — scaffold UX gate and incremental gate need auto-decisions (at: C7, I9)
- [warning] [consistency] I9 Step 3 tier_drift check redundant with Critical Rule extension in C2 — double-checks same condition (at: I9 Step 3, C2)
- [warning] [completeness] Doc-schema injection requires explicit Glob+Read instructions in interface definitions — agents need step-by-step resolution (at: I9, I10)
- [warning] [feasibility] Incremental fallback budget math doesn't add up — splitting to 2 writers leaves no room for README/CHANGELOG writer (at: R1)
- [warning] [completeness] ADR numbering for multiple ADRs in single dispatch unspecified — could produce duplicates (at: I8)
- [warning] [consistency] Workflow-artifacts.md marker conflict in incremental mode — no markers = skip rule contradicts full regeneration intent (at: I2b)
- [suggestion] [completeness] ADR context graceful degradation when spec.md missing — should synthesize from title alone (at: I2a)
- [suggestion] [completeness] {iflow_artifacts_root} variable resolution in inlined doc-schema — needs pre-injection replacement (at: I4, I10)

**Changes Made:**
- Added TD7 "Dispatch Ownership: Skill vs Commands" resolving the blocker — skill serves generate-docs and standalone usage; finish-feature and wrap-up inline dispatches directly
- C4: Rewrote purpose to clarify "for generate-docs command and standalone usage" with TD7 reference
- C7: Added "Inlines agent dispatch directly (does not delegate to updating-docs skill — see TD7)" and YOLO mode overrides paragraph (scaffold auto-skips, incremental proceeds if affected_tiers non-empty)
- C8: Added inline dispatch note referencing TD7
- I9: Added Step 1b (Resolve doc-schema content via two-location Glob + Read); renamed existing 1b to 1c; simplified Step 3 (removed redundant tier_drift check, rely on Critical Rule); added {doc_schema_content} to step descriptions
- I10: Added Step 1b (doc-schema resolution with two-location Glob, Read, variable replacement)
- R1: Fixed incremental fallback budget math — fold README/CHANGELOG into one of 2 tier writer dispatches (1 researcher + 2 writers = 3 budget)
- I8: Added ADR numbering clarification — single-scan existing ADRs then increment sequentially for multi-ADR dispatches
- I2b: Added workflow-artifacts.md exception — always fully regenerated regardless of markers (not user-editable)
- I2a: Added ADR context degradation for missing spec.md — synthesize from feature title alone
- I4: Added variable resolution note ({iflow_artifacts_root} replaced before injection)
- I10: Added variable resolution note for {iflow_artifacts_root} in doc-schema content

---

## Design Review - Iteration 3 - 2026-02-25T21:35:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (approved: true, but 6 warnings)

**Issues:**
- [warning] [consistency] I9 Step 3 comment about Critical Rule "already factoring in" tier_drift is misleading — the real gate is the AND condition (no_updates_needed AND affected_tiers empty), and the Critical Rule is defense-in-depth (at: I9 Step 3)
- [warning] [completeness] Wrap-up silently does nothing for tier docs when no tier dirs exist — no informational message to guide user to /generate-docs (at: C8, I10)
- [warning] [completeness] I5 manual --mode override creates undocumented edge cases (forced scaffold with existing files, forced incremental without dirs) — spec does not mention manual mode override (at: I5, C5)
- [warning] [feasibility] Researcher agent is READ-ONLY (Read, Glob, Grep tools only) but design says it retrieves git timestamps via git log — cannot execute shell commands (at: C2, I7)
- [warning] [consistency] Config variable naming inconsistent — I6 injects as iflow_doc_tiers, I4 references as doc_tiers, I9 uses iflow_doc_tiers (at: I4 vs I6 vs I9)
- [warning] [completeness] ADR numbering instruction missing from I2b incremental mode instructions — writer needs explicit scan-and-increment guidance (at: I2b, I8)
- [suggestion] [complexity] R1 fallback cascade has no practical trigger threshold for token limits — defer runtime token counting to follow-up (at: R1, I2)
- [suggestion] [completeness] Workflow-artifacts.md status column does not document valid .meta.json status values (at: I7)

**Changes Made:**
- C2: Clarified drift detection uses pre-computed git timestamps injected by calling command, not researcher running git commands
- I7: Updated YAML Frontmatter note to explain pre-computed timestamps pattern; researcher does not run git commands
- C8: Added missing tier dirs informational message ("Run /iflow:generate-docs to scaffold")
- I5: Removed manual --mode override (Step 4); mode always auto-detected per spec. Standardized to use iflow_doc_tiers.
- I4: Standardized config reference from doc_tiers to iflow_doc_tiers
- I2b: Added explicit ADR numbering instruction (scan Existing ADRs list, start at 001 if none, increment sequentially)
- I9: Added Step 1d (pre-compute git timestamps via git log for drift detection, keeps researcher READ-ONLY); updated Step 2 to include pre-computed timestamps; rewrote Step 3 comment for defense-in-depth clarity
- I10: Added Step 1c (pre-compute git timestamps); updated Step 2 to include pre-computed timestamps

---

## Design Review - Iteration 4 - 2026-02-25T22:00:00Z

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision (approved: true, but 3 warnings)

**Issues:**
- [warning] [consistency] Scaffold dispatch budget: spec says max 4, design says max 5 — spec-design mismatch needs acknowledgment (at: C4, I9 Step 5b vs Spec)
- [warning] [consistency] I5 argument-hint still says "[mode]" despite removal of manual mode override in iteration 3 (at: I5)
- [warning] [completeness] TD7 acknowledges dispatch logic repetition across 3 files but no implementation note on preventing divergence (at: TD7, C4, C7/I9, C8/I10)
- [suggestion] [completeness] C8 wrap-up: when no tier dirs exist, pipeline degrades to existing behavior but this is not explicitly stated (at: C8)
- [suggestion] [completeness] Writer needs {iflow_artifacts_root} value for workflow-artifacts.md link construction but it's not in I2 prompt contract (at: I7, I2)

**Changes Made:**
- C4: Added note acknowledging spec says max 4 and explaining why design uses max 5 (README/CHANGELOG separation); spec should be updated during implementation
- I5: Changed argument-hint from "[mode]" to "" — mode is always auto-detected
- TD7: Added implementation note recommending extraction of common operations (Glob resolution, timestamp pre-computation, prompt assembly) into reusable templates to prevent divergence
- C8: Added graceful degradation explanation — when no tier dirs exist, pipeline falls back to existing README/CHANGELOG-only behavior
- I2: Added Artifacts Root field to writer prompt contract so writer can construct correct workflow-artifacts.md relative paths

---

## Handoff Review - Iteration 0 - 2026-02-25T22:20:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] I3 action values not enumerated — actually already listed (5 examples) but strengthened with 6th example and clarified as free-text strings
- [warning] Error condition for writer receiving empty tier list or malformed researcher JSON unspecified (at: I2, I6)
- [warning] Sequencing rule between researcher and writer in C7/C8 is implicit (at: I9, I10)
- [suggestion] TD7 implementation note vague about which operations to extract (at: TD7)

**Changes Made:**
- I3: Strengthened action value listing with annotations, added 6th example ("Skipped"), added error handling paragraph
- I2: Added error conditions paragraph — empty tiers exits at command layer; malformed researcher JSON falls back to best-effort mode
- I9: Added sequencing invariant — researcher always first, writer always follows, skip only via Step 3 gate
- I10: Added same sequencing invariant

---

## Handoff Review - Iteration 1 - 2026-02-25T22:35:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] Spec/design divergence on scaffold dispatch cap — spec states max 4, design states max 5. Deferred correction leaves planner with conflicting authoritative sources (at: C4, spec.md line 65)
- [suggestion] I5 command flow step numbering gap — steps jump from 4 to 6 after removal of manual mode override in design-review iteration 3 (at: I5)

**Changes Made:**
- spec.md: Updated scaffold dispatch cap from "max 4 dispatches for three tiers plus README/CHANGELOG" to "max 5 dispatches (1 researcher + 3 tier writers + 1 README/CHANGELOG writer)" — resolves spec/design divergence
- C4: Replaced deferred-update note with aligned statement ("spec and design both use max 5")
- I5: Renumbered step 6 → step 5, fixing numbering gap left by step 4 removal

---

## Handoff Review - Iteration 2 - 2026-02-25T22:50:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] C5 (generate-docs) does not specify YOLO mode behavior for scaffold confirmation gate — C7 (finish-feature) documents explicit YOLO overrides but C5 has an analogous gate with no override defined (at: C5, compare C7)
- [suggestion] Scaffold confirmation flow split across C5 (command presents summary) and I2a (writer told to "ask for confirmation") — dual responsibility is ambiguous (at: C5, I2a)

**Changes Made:**
- C5: Added YOLO mode overrides paragraph — scaffold confirmation gate auto-skipped in YOLO (generate-docs is explicit user invocation, auto-scaffold acceptable)
- I2a: Replaced "Present a summary... Ask for confirmation" with note that confirmation gate is owned by C5 command, not the writer agent

---

## Handoff Review - Iteration 3 - 2026-02-25T23:00:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] TD7 implementation note defers shared-logic strategy to implementation ("copy-paste templates or extracted into reusable prompt sections") — plan phase needs a clear decision to sequence work correctly (at: TD7)
- [suggestion] I5 Step 5 does not repeat the feature cap and sort order from C5 — not self-contained for plan phase (at: I5 Step 5)

**Changes Made:**
- TD7: Replaced vague implementation note with explicit decision: "copy-paste with sync markers" using `<!-- SYNC: enriched-doc-dispatch -->` comment for grep-based verification. Separate reference file rejected (indirection for 3 short operations, no include mechanism).
- I5 Step 5: Added explicit sort order (directory number descending), cap (10 most recent), and log message for skipped features

---

## Handoff Review - Iteration 4 - 2026-02-25T23:10:00Z

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [warning] I9 Step 5 "(max 3)" is misleading — refers to tier writers only, not total dispatches. Planner may implement hard 3-dispatch guard blocking README/CHANGELOG dispatch (at: I9 Step 5)
- [warning] I9 Step 1c collapses "Skip" and "Defer" identically but doesn't clarify whether "Defer" stores state — planner may ask whether distinct behavior is needed (at: C7, I9 Step 1c)
- [suggestion] Scaffold mode per-tier writers could race on ADR numbering if dispatched in parallel — needs sequential dispatch or clarification that only technical-tier writer handles ADRs (at: I8, I9 Step 5)

**Changes Made:**
- I9 Step 5: Changed "(max 3)" to "(max 3 tier writers)" and added total scaffold cap comment (max 5: 1 researcher + 3 tier writers + 1 README/CHANGELOG). Added "dispatched sequentially" and ADR collision note.
- I9 Step 1c: Added inline comment clarifying "Skip" and "Defer" are behaviorally identical — no deferred state stored, "Defer" is UX label suggesting /generate-docs later.

---
