# Review History — 033-comprehensive-prompt-refactor (specify)

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-28T20:20:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [testability] SC-2/AC-8 claim ~28 subjective adjective instances; actual grep returns 73 raw matches (44 agents, 12 commands, 17 SKILL.md files). Work estimate materially wrong. (at: SC-2, AC-8, FR-9)
  Suggestion: Run actual grep and update count
- [blocker] [testability] AC-7 "orthogonal task" undefined — <=3 constraint untestable without definition and enumerated splits (at: AC-7, SC-6)
  Suggestion: Define orthogonal task and enumerate specific splits per command
- [blocker] [assumptions] AC-4/AC-13 behavioral equivalence undefined — "functionally identical" and "equivalent quality" have no verification procedure, despite PRD noting content ordering affects model attention (at: AC-4, AC-13)
  Suggestion: Define concrete comparison procedure
- [warning] [testability] SC-1/AC-1 cache-friendliness behavioral anchors not specified (at: SC-1, AC-1)
  Suggestion: Add Pass/Partial/Fail anchors
- [warning] [assumptions] AC-6/SC-5 contradiction: "zero math" vs secretary "keep if simple enough" (at: AC-6, SC-5)
  Suggestion: Make decision and define trivial-math boundary
- [warning] [scope] AC-5 JSON schema location unclear (command dispatch vs agent file) (at: AC-5, FR-6)
  Suggestion: Clarify coordination between command and agent schemas
- [warning] [testability] AC-3 60-minute time constraint not meaningfully testable (at: AC-3, NFR-1)
  Suggestion: Soften to soft target
- [warning] [clarity] AC-9 terminology convention doesn't cover commands (at: AC-9)
  Suggestion: Extend convention to all component types
- [warning] [traceability] PRD SC about agent caching preservation missing from spec (at: Success Criteria)
  Suggestion: Add SC-10
- [warning] [assumptions] AC-11 hookify mechanism undefined (at: AC-11, SC-8)
  Suggestion: Reference existing hookify plugin

**Changes Made:**
- Updated subjective adjective count from ~28 to ~73 raw matches across 38 files — Reason: blocker 1
- Defined "orthogonal task" and enumerated specific chain splits for both commands — Reason: blocker 2
- Added concrete behavioral equivalence verification procedure to AC-13 with 5-step comparison — Reason: blocker 3
- Added cache-friendliness Pass/Partial/Fail behavioral anchors to AC-1 — Reason: warning 1
- Resolved math contradiction: defined trivial-math exception in SC-5, applied to secretary scoring in AC-6 — Reason: warning 2
- Clarified AC-5 schema goes in command dispatch, must be consistent with agent file — Reason: warning 3
- Softened AC-3 time constraint to soft target with API variance note — Reason: warning 4
- Extended terminology convention in AC-9 to cover commands — Reason: warning 5
- Added SC-10 for agent caching preservation — Reason: warning 6
- Referenced existing hookify plugin in AC-11 — Reason: warning 7
- Scoped AC-10 passive voice verification to promptimize as verifier — Reason: suggestion 1
- Resolved all Open Questions and promoted to Resolved Decisions — Reason: suggestion 3

---

## Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-28T20:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved with warnings

**Issues:**
- [warning] [traceability] SC-5 refines PRD's blanket "zero math" without noting the divergence (at: SC-5, AC-6)
  Suggestion: Add explicit refinement note with rationale
- [warning] [testability] SC-10 "spot check" is not reproducible verification (at: SC-10)
  Suggestion: Define concrete verification method
- [warning] [testability] AC-3 soft target in acceptance criteria is not acceptance-gating (at: AC-3)
  Suggestion: Move runtime to non-functional note
- [warning] [assumptions] AC-7 unclear whether agent files are split or same agent called multiple times (at: AC-7)
  Suggestion: Clarify agent invocation approach
- [warning] [scope] AC-8 adjective removal and SC-10 ordering preservation have no conflict procedure (at: SC-10, AC-8)
  Suggestion: Add preservation note to AC-8
- [warning] [testability] AC-13 behavioral equivalence allows severity distribution shifts (at: AC-13 step 4)
  Suggestion: Add severity shift check
- [warning] [assumptions] AC-1 covers skill but promptimize command Step 5 also needs denominator update (at: AC-1, SC-1)
  Suggestion: Mention both skill and command explicitly

**Changes Made:**
- Added refinement note to SC-5 explaining divergence from PRD with rationale — Reason: warning 1
- Replaced "spot check" with concrete diff-based verification of all 28 agent files — Reason: warning 2
- Separated AC-3 runtime into non-functional note (not acceptance-gating) — Reason: warning 3
- Clarified AC-7: same agent called with narrower scope per chain, no new agent files — Reason: warning 4
- Added SC-10 preservation note to AC-8 for adjective replacements in agent files — Reason: warning 5
- Added severity distribution shift check to AC-13 step 4 — Reason: warning 6
- Updated AC-1 to cover both promptimize skill and command file updates — Reason: warning 7
- Fixed AC-10 to reference technique_currency dimension by name — Reason: suggestion
- Clarified AC-4 behavioral equivalence scope: full procedure for pilot files, diff review for rest — Reason: suggestion

---

## Stage 1: Spec-Reviewer Review - Iteration 3 - 2026-02-28T20:45:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved with warnings

**Issues:**
- [warning] [traceability] SC-5 PRD divergence: PRD is not updated retroactively, should clarify relationship (at: SC-5)
  Suggestion: Add note that PRD is input document, spec refinements expected
- [warning] [testability] AC-8 domain-specific adjective exclusion boundary not clearly defined for data science review checklists (at: AC-8, SC-2)
  Suggestion: Add explicit definition of domain-specific term exclusion
- [warning] [testability] AC-4 non-pilot verification "manual review of diff" is not measurable (at: AC-4)
  Suggestion: Add automated diff check criteria (no lines deleted/added, only moved)
- [warning] [assumptions] AC-7 agent system prompt may cause evaluation of out-of-scope axes when dispatched with subset (at: AC-7)
  Suggestion: Add explicit subset scope override instruction requirement
- [warning] [scope] AC-4/FR-4/FR-5 no selection rationale for the 9 files chosen for restructuring (at: AC-4, In Scope)
  Suggestion: Add one-liner explaining selection criteria

**Changes Made:**
- Added note to SC-5 that PRD is input document, not retroactively updated — Reason: warning 1
- Added domain-specific term exclusion definition to AC-8 for statistical terminology — Reason: warning 2
- Replaced manual diff review with automated diff criteria for non-pilot files in AC-4 — Reason: warning 3
- Added subset scope override requirement to AC-7 for agent dispatch — Reason: warning 4
- Added selection rationale for 9 files in scope section — Reason: warning 5

---

## Stage 1: Spec-Reviewer Review - Iteration 4 - 2026-02-28T20:55:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] [assumptions] AC-4 automated diff "no lines added" may conflict with boundary marker comments (at: AC-4)
  Suggestion: Amend to permit structural markers
- [suggestion] [clarity] AC-7 synthesis chain input contract not explicit (at: AC-7)
  Suggestion: Specify Chain 3 receives JSON outputs of Chain 1 and 2

**Changes Made:**
None required — zero blockers and zero warnings. Suggestions noted for design phase.

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-28T21:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved with warnings

**Issues:**
- [warning] [testability] AC-4 non-pilot automated diff lacks semantic ordering check (at: AC-4)
  Suggestion: Add condition that named static sections are fully before first dynamic marker
- [warning] [clarity] AC-7 synthesis chain (Chain 3) input contract not specified (at: AC-7)
  Suggestion: Specify Chain 3 receives JSON outputs from Chains 1 and 2
- [warning] [assumptions] AC-11 hookify rule `.local.md` naming ambiguous — local-only vs committed (at: AC-11)
  Suggestion: Clarify that `.local.md` is intentional local-only convention

**Changes Made:**
- Added semantic ordering condition (c) to AC-4 non-pilot verification — Reason: warning 1
- Added synthesis chain input contract to AC-7 (Chain 3 receives JSON from Chains 1+2, no re-read) — Reason: warning 2
- Clarified AC-11 `.local.md` naming as intentional local-only per project convention — Reason: warning 3

---

## Stage 2: Phase Review - Iteration 2 - 2026-02-28T21:10:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] [testability] AC-9 hook script verification method unspecified (at: AC-9)
  Suggestion: Add grep-based verification method
- [suggestion] [traceability] SC-5 PRD divergence note could explicitly reference PRD SC-5 (at: SC-5)
  Suggestion: Add cross-reference to PRD Success Criteria SC-5

**Changes Made:**
None required — zero blockers and zero warnings. Suggestions noted for design phase.

---

## Design Review - Iteration 1 - 2026-02-28T22:05:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] `claude --print` may not support plugin slash commands for batch-promptimize invocation (at: C2.3, TD-2, I-3)
  Challenge: Verify exact CLI invocation mechanism
- [blocker] [completeness] No specification for extracting scores from promptimize markdown output in batch script (at: C2.3, I-3)
  Challenge: Define deterministic parsing for score extraction
- [blocker] [completeness] Undefined data-passing mechanism between chained Task() dispatches in God Prompt split (at: C3.1, C3.2)
  Challenge: Specify how Chain 3 receives Chain 1+2 outputs
- [warning] [feasibility] Secretary.md caching restructure — static/dynamic content deeply interleaved, block movement insufficient (at: C3.4)
  Challenge: Routing tables reference dynamic discovery output mid-flow
- [warning] [consistency] Math-in-LLM self-contradiction: promptimize.md Step 5 IS LLM-interpreted markdown formula (at: C3.3, AC-6)
  Challenge: Step 5 formula is LLM math, contradicts "already in command file" claim
- [warning] [completeness] validate.sh simple grep produces false positives for domain-specific adjective terms (at: C5.1, AC-8)
  Challenge: Need exclusion mechanism matching AC-8 boundary
- [warning] [consistency] Adjective count ~73 in design vs ~80 actual — discrepancy in scope estimate (at: C4.1)
  Challenge: Align count with spec or note as estimate
- [warning] [completeness] God Prompt chain error handling missing — what if Chain 1 or 2 fails? (at: C3.1, C3.2)
  Challenge: Specify failure handling for partial chain execution
- [warning] [assumptions] Scope restriction reliability — LLMs may not reliably ignore system prompt axes (at: I-7, AC-7)
  Challenge: Need safeguard beyond instruction alone
- [warning] [assumptions] Hookify matcher format uses brace expansion glob which may not be supported (at: I-6)
  Challenge: Verify hookify matcher syntax
- [suggestion] [consistency] AC-13 "same JSON structure" check contradicts God Prompt schema change for ds-code/ds-analysis (at: C5.3, AC-13)
  Suggestion: Clarify comparison applies to Chain 3 synthesis output only
- [suggestion] [clarity] Pilot sequencing relative to phases unclear — when exactly are pilots verified? (at: C5.3)
  Suggestion: Specify pilot timing in execution sequence
- [suggestion] [completeness] Batch-promptimize timeout value unspecified (at: C2.3, I-3)
  Suggestion: Add per-file timeout

**Changes Made:**
- Replaced `claude --print` with `claude -p` (print mode) with exact invocation syntax, confirmed plugin slash commands available — Reason: blocker 1
- Added deterministic `SCORE:{N}` output format with regex extraction and error/timeout handling — Reason: blocker 2
- Added explicit data flow specification: Chain 3 prompt includes Chain 1+2 JSON outputs inline in `## Prior Chain Results` section — Reason: blocker 3
- Expanded secretary.md restructure strategy: extract static tables to dedicated top section with named anchors — Reason: warning 1
- Fixed math-in-LLM: promptimize.md Step 5 now outputs raw scores JSON, computation moves to bash arithmetic in batch script — Reason: warning 2
- Added domain-specific compound term subtraction to validate.sh grep logic — Reason: warning 3
- Clarified adjective count as estimate from spec, exact count TBD by batch audit — Reason: warning 4
- Added chain error handling policy to C3.1 and C3.2 — Reason: warning 5
- Added two-layer scope leakage mitigation (prompt position + deterministic stripping) to I-7 — Reason: warning 6
- Updated hookify matcher to use substring path matching instead of brace expansion — Reason: warning 7
- Clarified AC-13 JSON structure check applies to Chain 3 synthesis output — Reason: suggestion 1
- Added pilot sequencing note: verified after all Phase 1-4 changes applied — Reason: suggestion 2
- Added 120s per-file timeout to batch-promptimize with `[TIMEOUT]` status — Reason: suggestion 3
- Added R-7 (scope leakage) and R-8 (chain failure) to Risks table
- Updated TD-2 to reflect `claude -p` mechanism
- Updated C2.2 to specify raw scores output (math moves to orchestrating code)

---

## Design Review - Iteration 2 - 2026-02-28T22:25:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] `claude -p` does NOT support plugin slash commands in headless mode (GitHub #837, #14246) — batch-promptimize.sh cannot invoke `/iflow:promptimize` (at: C2.3, I-3, TD-2)
  Challenge: Core execution mechanism for batch scoring is broken
- [blocker] [consistency] Interactive promptimize score computation unspecified — C2.2 says raw scores only but interactive path has no "calling script" to compute percentage (at: C2.2, C3.3)
  Challenge: AC-6 partially unsatisfied for interactive use
- [warning] [consistency] Adjective count ~73 vs ~80 actual — should update estimate (at: C4.1, Phase 4)
  Challenge: Planning accuracy
- [warning] [completeness] validate.sh code-fence exclusion mentioned in prose but not implemented in grep logic (at: C5.1)
  Challenge: Potential false positives from code examples
- [warning] [assumptions] God Prompt chain "capture" mechanism — command files are prompt templates, not executable scripts; need explicit LLM-orchestration note (at: C3.1, C3.2)
  Challenge: Clarify orchestration mechanism
- [warning] [feasibility] Score extraction inconsistency: I-3 says SCORE:{N} regex but C2.2 says raw JSON scores — two incompatible extraction strategies (at: I-3, C2.2)
  Challenge: Pick one approach
- [warning] [completeness] SKILL.md Phase 1 output "exactly 9 entries" at line 117 not explicitly called out for update (at: C2.1)
  Challenge: Missing update location
- [warning] [assumptions] scoring-rubric.md uses "appropriate emphasis" — subjective adjective in the quality standard itself (at: C1.1)
  Challenge: Meta-consistency concern
- [suggestion] [complexity] Bash rounding formula `$(( (sum*100+15)/30 ))` — needs explanatory comment (at: C2.3, C3.3, I-3)
  Challenge: Maintainability
- [suggestion] [completeness] Pilot representative inputs not specified for 4 of 5 pilot files (at: C5.3)
  Challenge: Reproducible testing

**Changes Made:**
- Restructured batch-promptimize.sh to use `claude -p` with inline scoring prompt (no slash commands); raw JSON scores returned, percentage computed in bash — Reason: blocker 1
- Documented interactive promptimize score computation as trivial-math exception (10-integer sum + divide + round); batch path computes in bash (AC-6 satisfied); interactive path documented exception — Reason: blocker 2
- Updated adjective count from ~73 to ~80 with per-component-type breakdown — Reason: warning 1
- Accepted code-fence exclusion as known limitation; documented allowlist fallback — Reason: warning 2
- Added explicit LLM-orchestration mechanism note to C3.1 (conversation context pattern, bounded context growth) — Reason: warning 3
- Updated I-3 score extraction to parse JSON `{"scores": {...}}` instead of SCORE:{N} regex — Reason: warning 4
- Added explicit mention of SKILL.md line 117 "exactly 9 entries" as second update location in C2.1 — Reason: warning 5
- Documented scoring-rubric "appropriate emphasis" as accepted inconsistency (reference files excluded from AC-8) — Reason: warning 6
- Added half-divisor rounding comment to bash formula — Reason: suggestion 1
- Added representative inputs for all 5 pilot files — Reason: suggestion 2
- Updated TD-2 to reflect inline scoring prompt approach (slash commands unavailable in headless mode)

---

## Design Review - Iteration 3 - 2026-02-28T22:45:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved with warnings

**Issues:**
- [warning] [feasibility] `grep -oP` (Perl regex) unavailable on macOS BSD grep — batch-promptimize JSON extraction will fail (at: I-3, C2.3)
  Challenge: Has the script been tested with macOS BSD grep?
- [warning] [assumptions] `claude -p` slash command limitation (GitHub #837, #14246) could not be independently verified (at: C2.3, TD-2)
  Challenge: Is assumption still current?
- [warning] [completeness] validate.sh grep pattern lacks word boundaries — 'proper' matches 'property', 'robust' matches 'robustness' (at: C5.1, I-5)
  Challenge: False positives from substring matching
- [warning] [consistency] Adjective count ~80 in design vs ~73 in spec — discrepancy persists (at: Phase 4, spec In Scope)
  Challenge: Which number is authoritative?
- [warning] [feasibility] `claude -p` output may include preamble text or code fences before JSON — regex extraction fragile (at: I-3, Score extraction)
  Challenge: How robust is JSON extraction against varied output formats?
- [suggestion] [completeness] Chain 1+2 output size unbounded — large JSON payloads could grow context (at: C3.1)
  Suggestion: Add expected size note and warning threshold
- [suggestion] [consistency] I-7 says "deterministic code-level stripping" but command files are LLM-interpreted markdown (at: I-7)
  Suggestion: Reword to accurately describe LLM-executed filtering
- [suggestion] [complexity] AC-13 pilot verification = 20-30 manual test runs (at: C5.3)
  Suggestion: Informational — effort proportional to risk

**Changes Made:**
- Replaced `grep -oP` with Python one-liner as primary JSON extraction method (portable macOS/Linux) — Reason: warning 1 + warning 5
- Added revisitability comment to batch-promptimize.sh about slash command assumption — Reason: warning 2
- Added `\b` word boundary markers to validate.sh grep pattern and I-5 — Reason: warning 3
- Noted spec's 73 was earlier count; design's 80 is verified and authoritative — Reason: warning 4
- Added Chain 1+2 expected output size (<2KB) and >5KB warning threshold to C3.1 — Reason: suggestion 1
- Reworded I-7 scope leakage mitigation to accurately describe LLM-executed filtering — Reason: suggestion 2

---

## Handoff Review - Iteration 1 - 2026-02-28T23:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved with warnings

**Issues:**
- [warning] [completeness] Pilot placement in Phase 5 lacks explicit "gate" ordering — planner may not sequence pilot-before-full-batch correctly (at: Phase 5, C5.3, Dependency Graph)
  Suggestion: Add explicit pilot gate note and dependency edge
- [warning] [completeness] I-7 scope leakage filtering location unspecified — planner won't know where instruction lives in command file (at: I-7, C3.1)
  Suggestion: Specify filtering instruction placement between Chain 2 return and Chain 3 dispatch
- [warning] [assumptions] batch-promptimize.sh relative path `plugins/iflow/...` requires specific CWD but no guard specified (at: C2.3, I-3)
  Suggestion: Add CWD requirement and startup guard
- [suggestion] [clarity] secretary.md restructure scope unmeasured — planner can't size the task (at: C3.4)
  Suggestion: Add rough estimate of blocks to extract
- [suggestion] [consistency] AC-7→AC-5 dependency direction inverted — schemas are part of split, not prerequisite (at: Dependency Graph)
  Suggestion: Merge AC-5 into AC-7 dependency

**Changes Made:**
- Added explicit pilot gate note to Phase 5 execution order with "remaining files blocked until pilot passes" — Reason: warning 1
- Added dependency edge: AC-13 (pilot pass) → Phase 4 full batch — Reason: warning 1
- Specified filtering instruction placement: between Chain 2 return and Chain 3 dispatch with explicit instruction text — Reason: warning 2
- Added CWD requirement and startup guard for scoring-rubric.md existence to C2.3 — Reason: warning 3
- Merged AC-5 into AC-7 dependency in graph — Reason: suggestion 2

---
