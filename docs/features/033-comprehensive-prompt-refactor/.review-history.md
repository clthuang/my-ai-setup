# Review History — 033-comprehensive-prompt-refactor (specify)

## Stage 1: Spec-Reviewer Review - Iteration 1 - 2026-02-28T20:20:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [testability] SC-2/AC-8 claim ~28 subjective adjective instances; actual grep returns 73 raw matches (44 agents, 12 commands, 17 SKILL.md files). Work estimate materially wrong. (at: SC-2, AC-8, FR-9)
  Suggestion: Run actual grep and update count
- [blocker] [testability] AC-7 "orthogonal task" undefined — <=3 constraint untestable without definition and enumerated splits (at: AC-7, SC-6)
  Suggestion: Define orthogonal task and enumerate specific splits per command
- [blocker] [assumptions] AC-4/AC-13 behavioral equivalence undefined — "functionally identical" and "equivalent quality" have no verification procedure, despite PRD noting content ordering affects model attention (at: AC-4, AC-13)
  Suggestion: Define concrete comparison procedure
- [warning] [testability] SC-1/AC-1 cache-friendliness behavioral anchors not specified (at: SC-1, AC-1)
  Suggestion: Add Pass/Partial/Fail anchors
- [warning] [assumptions] AC-6/SC-5 contradiction: "zero math" vs secretary "keep if simple enough" (at: AC-6, SC-5)
  Suggestion: Make decision and define trivial-math boundary
- [warning] [scope] AC-5 JSON schema location unclear (command dispatch vs agent file) (at: AC-5, FR-6)
  Suggestion: Clarify coordination between command and agent schemas
- [warning] [testability] AC-3 60-minute time constraint not meaningfully testable (at: AC-3, NFR-1)
  Suggestion: Soften to soft target
- [warning] [clarity] AC-9 terminology convention doesn't cover commands (at: AC-9)
  Suggestion: Extend convention to all component types
- [warning] [traceability] PRD SC about agent caching preservation missing from spec (at: Success Criteria)
  Suggestion: Add SC-10
- [warning] [assumptions] AC-11 hookify mechanism undefined (at: AC-11, SC-8)
  Suggestion: Reference existing hookify plugin

**Changes Made:**
- Updated subjective adjective count from ~28 to ~73 raw matches across 38 files — Reason: blocker 1
- Defined "orthogonal task" and enumerated specific chain splits for both commands — Reason: blocker 2
- Added concrete behavioral equivalence verification procedure to AC-13 with 5-step comparison — Reason: blocker 3
- Added cache-friendliness Pass/Partial/Fail behavioral anchors to AC-1 — Reason: warning 1
- Resolved math contradiction: defined trivial-math exception in SC-5, applied to secretary scoring in AC-6 — Reason: warning 2
- Clarified AC-5 schema goes in command dispatch, must be consistent with agent file — Reason: warning 3
- Softened AC-3 time constraint to soft target with API variance note — Reason: warning 4
- Extended terminology convention in AC-9 to cover commands — Reason: warning 5
- Added SC-10 for agent caching preservation — Reason: warning 6
- Referenced existing hookify plugin in AC-11 — Reason: warning 7
- Scoped AC-10 passive voice verification to promptimize as verifier — Reason: suggestion 1
- Resolved all Open Questions and promoted to Resolved Decisions — Reason: suggestion 3

---

## Stage 1: Spec-Reviewer Review - Iteration 2 - 2026-02-28T20:30:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved with warnings

**Issues:**
- [warning] [traceability] SC-5 refines PRD's blanket "zero math" without noting the divergence (at: SC-5, AC-6)
  Suggestion: Add explicit refinement note with rationale
- [warning] [testability] SC-10 "spot check" is not reproducible verification (at: SC-10)
  Suggestion: Define concrete verification method
- [warning] [testability] AC-3 soft target in acceptance criteria is not acceptance-gating (at: AC-3)
  Suggestion: Move runtime to non-functional note
- [warning] [assumptions] AC-7 unclear whether agent files are split or same agent called multiple times (at: AC-7)
  Suggestion: Clarify agent invocation approach
- [warning] [scope] AC-8 adjective removal and SC-10 ordering preservation have no conflict procedure (at: SC-10, AC-8)
  Suggestion: Add preservation note to AC-8
- [warning] [testability] AC-13 behavioral equivalence allows severity distribution shifts (at: AC-13 step 4)
  Suggestion: Add severity shift check
- [warning] [assumptions] AC-1 covers skill but promptimize command Step 5 also needs denominator update (at: AC-1, SC-1)
  Suggestion: Mention both skill and command explicitly

**Changes Made:**
- Added refinement note to SC-5 explaining divergence from PRD with rationale — Reason: warning 1
- Replaced "spot check" with concrete diff-based verification of all 28 agent files — Reason: warning 2
- Separated AC-3 runtime into non-functional note (not acceptance-gating) — Reason: warning 3
- Clarified AC-7: same agent called with narrower scope per chain, no new agent files — Reason: warning 4
- Added SC-10 preservation note to AC-8 for adjective replacements in agent files — Reason: warning 5
- Added severity distribution shift check to AC-13 step 4 — Reason: warning 6
- Updated AC-1 to cover both promptimize skill and command file updates — Reason: warning 7
- Fixed AC-10 to reference technique_currency dimension by name — Reason: suggestion
- Clarified AC-4 behavioral equivalence scope: full procedure for pilot files, diff review for rest — Reason: suggestion

---

## Stage 1: Spec-Reviewer Review - Iteration 3 - 2026-02-28T20:45:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved with warnings

**Issues:**
- [warning] [traceability] SC-5 PRD divergence: PRD is not updated retroactively, should clarify relationship (at: SC-5)
  Suggestion: Add note that PRD is input document, spec refinements expected
- [warning] [testability] AC-8 domain-specific adjective exclusion boundary not clearly defined for data science review checklists (at: AC-8, SC-2)
  Suggestion: Add explicit definition of domain-specific term exclusion
- [warning] [testability] AC-4 non-pilot verification "manual review of diff" is not measurable (at: AC-4)
  Suggestion: Add automated diff check criteria (no lines deleted/added, only moved)
- [warning] [assumptions] AC-7 agent system prompt may cause evaluation of out-of-scope axes when dispatched with subset (at: AC-7)
  Suggestion: Add explicit subset scope override instruction requirement
- [warning] [scope] AC-4/FR-4/FR-5 no selection rationale for the 9 files chosen for restructuring (at: AC-4, In Scope)
  Suggestion: Add one-liner explaining selection criteria

**Changes Made:**
- Added note to SC-5 that PRD is input document, not retroactively updated — Reason: warning 1
- Added domain-specific term exclusion definition to AC-8 for statistical terminology — Reason: warning 2
- Replaced manual diff review with automated diff criteria for non-pilot files in AC-4 — Reason: warning 3
- Added subset scope override requirement to AC-7 for agent dispatch — Reason: warning 4
- Added selection rationale for 9 files in scope section — Reason: warning 5

---

## Stage 1: Spec-Reviewer Review - Iteration 4 - 2026-02-28T20:55:00+08:00

**Reviewer:** spec-reviewer (skeptic)
**Decision:** Approved

**Issues:**
- [suggestion] [assumptions] AC-4 automated diff "no lines added" may conflict with boundary marker comments (at: AC-4)
  Suggestion: Amend to permit structural markers
- [suggestion] [clarity] AC-7 synthesis chain input contract not explicit (at: AC-7)
  Suggestion: Specify Chain 3 receives JSON outputs of Chain 1 and 2

**Changes Made:**
None required — zero blockers and zero warnings. Suggestions noted for design phase.

---

## Stage 2: Phase Review - Iteration 1 - 2026-02-28T21:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved with warnings

**Issues:**
- [warning] [testability] AC-4 non-pilot automated diff lacks semantic ordering check (at: AC-4)
  Suggestion: Add condition that named static sections are fully before first dynamic marker
- [warning] [clarity] AC-7 synthesis chain (Chain 3) input contract not specified (at: AC-7)
  Suggestion: Specify Chain 3 receives JSON outputs from Chains 1 and 2
- [warning] [assumptions] AC-11 hookify rule `.local.md` naming ambiguous — local-only vs committed (at: AC-11)
  Suggestion: Clarify that `.local.md` is intentional local-only convention

**Changes Made:**
- Added semantic ordering condition (c) to AC-4 non-pilot verification — Reason: warning 1
- Added synthesis chain input contract to AC-7 (Chain 3 receives JSON from Chains 1+2, no re-read) — Reason: warning 2
- Clarified AC-11 `.local.md` naming as intentional local-only per project convention — Reason: warning 3

---

## Stage 2: Phase Review - Iteration 2 - 2026-02-28T21:10:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] [testability] AC-9 hook script verification method unspecified (at: AC-9)
  Suggestion: Add grep-based verification method
- [suggestion] [traceability] SC-5 PRD divergence note could explicitly reference PRD SC-5 (at: SC-5)
  Suggestion: Add cross-reference to PRD Success Criteria SC-5

**Changes Made:**
None required — zero blockers and zero warnings. Suggestions noted for design phase.

---

## Design Review - Iteration 1 - 2026-02-28T22:05:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] `claude --print` may not support plugin slash commands for batch-promptimize invocation (at: C2.3, TD-2, I-3)
  Challenge: Verify exact CLI invocation mechanism
- [blocker] [completeness] No specification for extracting scores from promptimize markdown output in batch script (at: C2.3, I-3)
  Challenge: Define deterministic parsing for score extraction
- [blocker] [completeness] Undefined data-passing mechanism between chained Task() dispatches in God Prompt split (at: C3.1, C3.2)
  Challenge: Specify how Chain 3 receives Chain 1+2 outputs
- [warning] [feasibility] Secretary.md caching restructure — static/dynamic content deeply interleaved, block movement insufficient (at: C3.4)
  Challenge: Routing tables reference dynamic discovery output mid-flow
- [warning] [consistency] Math-in-LLM self-contradiction: promptimize.md Step 5 IS LLM-interpreted markdown formula (at: C3.3, AC-6)
  Challenge: Step 5 formula is LLM math, contradicts "already in command file" claim
- [warning] [completeness] validate.sh simple grep produces false positives for domain-specific adjective terms (at: C5.1, AC-8)
  Challenge: Need exclusion mechanism matching AC-8 boundary
- [warning] [consistency] Adjective count ~73 in design vs ~80 actual — discrepancy in scope estimate (at: C4.1)
  Challenge: Align count with spec or note as estimate
- [warning] [completeness] God Prompt chain error handling missing — what if Chain 1 or 2 fails? (at: C3.1, C3.2)
  Challenge: Specify failure handling for partial chain execution
- [warning] [assumptions] Scope restriction reliability — LLMs may not reliably ignore system prompt axes (at: I-7, AC-7)
  Challenge: Need safeguard beyond instruction alone
- [warning] [assumptions] Hookify matcher format uses brace expansion glob which may not be supported (at: I-6)
  Challenge: Verify hookify matcher syntax
- [suggestion] [consistency] AC-13 "same JSON structure" check contradicts God Prompt schema change for ds-code/ds-analysis (at: C5.3, AC-13)
  Suggestion: Clarify comparison applies to Chain 3 synthesis output only
- [suggestion] [clarity] Pilot sequencing relative to phases unclear — when exactly are pilots verified? (at: C5.3)
  Suggestion: Specify pilot timing in execution sequence
- [suggestion] [completeness] Batch-promptimize timeout value unspecified (at: C2.3, I-3)
  Suggestion: Add per-file timeout

**Changes Made:**
- Replaced `claude --print` with `claude -p` (print mode) with exact invocation syntax, confirmed plugin slash commands available — Reason: blocker 1
- Added deterministic `SCORE:{N}` output format with regex extraction and error/timeout handling — Reason: blocker 2
- Added explicit data flow specification: Chain 3 prompt includes Chain 1+2 JSON outputs inline in `## Prior Chain Results` section — Reason: blocker 3
- Expanded secretary.md restructure strategy: extract static tables to dedicated top section with named anchors — Reason: warning 1
- Fixed math-in-LLM: promptimize.md Step 5 now outputs raw scores JSON, computation moves to bash arithmetic in batch script — Reason: warning 2
- Added domain-specific compound term subtraction to validate.sh grep logic — Reason: warning 3
- Clarified adjective count as estimate from spec, exact count TBD by batch audit — Reason: warning 4
- Added chain error handling policy to C3.1 and C3.2 — Reason: warning 5
- Added two-layer scope leakage mitigation (prompt position + deterministic stripping) to I-7 — Reason: warning 6
- Updated hookify matcher to use substring path matching instead of brace expansion — Reason: warning 7
- Clarified AC-13 JSON structure check applies to Chain 3 synthesis output — Reason: suggestion 1
- Added pilot sequencing note: verified after all Phase 1-4 changes applied — Reason: suggestion 2
- Added 120s per-file timeout to batch-promptimize with `[TIMEOUT]` status — Reason: suggestion 3
- Added R-7 (scope leakage) and R-8 (chain failure) to Risks table
- Updated TD-2 to reflect `claude -p` mechanism
- Updated C2.2 to specify raw scores output (math moves to orchestrating code)

---

## Design Review - Iteration 2 - 2026-02-28T22:25:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [feasibility] `claude -p` does NOT support plugin slash commands in headless mode (GitHub #837, #14246) — batch-promptimize.sh cannot invoke `/iflow:promptimize` (at: C2.3, I-3, TD-2)
  Challenge: Core execution mechanism for batch scoring is broken
- [blocker] [consistency] Interactive promptimize score computation unspecified — C2.2 says raw scores only but interactive path has no "calling script" to compute percentage (at: C2.2, C3.3)
  Challenge: AC-6 partially unsatisfied for interactive use
- [warning] [consistency] Adjective count ~73 vs ~80 actual — should update estimate (at: C4.1, Phase 4)
  Challenge: Planning accuracy
- [warning] [completeness] validate.sh code-fence exclusion mentioned in prose but not implemented in grep logic (at: C5.1)
  Challenge: Potential false positives from code examples
- [warning] [assumptions] God Prompt chain "capture" mechanism — command files are prompt templates, not executable scripts; need explicit LLM-orchestration note (at: C3.1, C3.2)
  Challenge: Clarify orchestration mechanism
- [warning] [feasibility] Score extraction inconsistency: I-3 says SCORE:{N} regex but C2.2 says raw JSON scores — two incompatible extraction strategies (at: I-3, C2.2)
  Challenge: Pick one approach
- [warning] [completeness] SKILL.md Phase 1 output "exactly 9 entries" at line 117 not explicitly called out for update (at: C2.1)
  Challenge: Missing update location
- [warning] [assumptions] scoring-rubric.md uses "appropriate emphasis" — subjective adjective in the quality standard itself (at: C1.1)
  Challenge: Meta-consistency concern
- [suggestion] [complexity] Bash rounding formula `$(( (sum*100+15)/30 ))` — needs explanatory comment (at: C2.3, C3.3, I-3)
  Challenge: Maintainability
- [suggestion] [completeness] Pilot representative inputs not specified for 4 of 5 pilot files (at: C5.3)
  Challenge: Reproducible testing

**Changes Made:**
- Restructured batch-promptimize.sh to use `claude -p` with inline scoring prompt (no slash commands); raw JSON scores returned, percentage computed in bash — Reason: blocker 1
- Documented interactive promptimize score computation as trivial-math exception (10-integer sum + divide + round); batch path computes in bash (AC-6 satisfied); interactive path documented exception — Reason: blocker 2
- Updated adjective count from ~73 to ~80 with per-component-type breakdown — Reason: warning 1
- Accepted code-fence exclusion as known limitation; documented allowlist fallback — Reason: warning 2
- Added explicit LLM-orchestration mechanism note to C3.1 (conversation context pattern, bounded context growth) — Reason: warning 3
- Updated I-3 score extraction to parse JSON `{"scores": {...}}` instead of SCORE:{N} regex — Reason: warning 4
- Added explicit mention of SKILL.md line 117 "exactly 9 entries" as second update location in C2.1 — Reason: warning 5
- Documented scoring-rubric "appropriate emphasis" as accepted inconsistency (reference files excluded from AC-8) — Reason: warning 6
- Added half-divisor rounding comment to bash formula — Reason: suggestion 1
- Added representative inputs for all 5 pilot files — Reason: suggestion 2
- Updated TD-2 to reflect inline scoring prompt approach (slash commands unavailable in headless mode)

---

## Design Review - Iteration 3 - 2026-02-28T22:45:00+08:00

**Reviewer:** design-reviewer (skeptic)
**Decision:** Approved with warnings

**Issues:**
- [warning] [feasibility] `grep -oP` (Perl regex) unavailable on macOS BSD grep — batch-promptimize JSON extraction will fail (at: I-3, C2.3)
  Challenge: Has the script been tested with macOS BSD grep?
- [warning] [assumptions] `claude -p` slash command limitation (GitHub #837, #14246) could not be independently verified (at: C2.3, TD-2)
  Challenge: Is assumption still current?
- [warning] [completeness] validate.sh grep pattern lacks word boundaries — 'proper' matches 'property', 'robust' matches 'robustness' (at: C5.1, I-5)
  Challenge: False positives from substring matching
- [warning] [consistency] Adjective count ~80 in design vs ~73 in spec — discrepancy persists (at: Phase 4, spec In Scope)
  Challenge: Which number is authoritative?
- [warning] [feasibility] `claude -p` output may include preamble text or code fences before JSON — regex extraction fragile (at: I-3, Score extraction)
  Challenge: How robust is JSON extraction against varied output formats?
- [suggestion] [completeness] Chain 1+2 output size unbounded — large JSON payloads could grow context (at: C3.1)
  Suggestion: Add expected size note and warning threshold
- [suggestion] [consistency] I-7 says "deterministic code-level stripping" but command files are LLM-interpreted markdown (at: I-7)
  Suggestion: Reword to accurately describe LLM-executed filtering
- [suggestion] [complexity] AC-13 pilot verification = 20-30 manual test runs (at: C5.3)
  Suggestion: Informational — effort proportional to risk

**Changes Made:**
- Replaced `grep -oP` with Python one-liner as primary JSON extraction method (portable macOS/Linux) — Reason: warning 1 + warning 5
- Added revisitability comment to batch-promptimize.sh about slash command assumption — Reason: warning 2
- Added `\b` word boundary markers to validate.sh grep pattern and I-5 — Reason: warning 3
- Noted spec's 73 was earlier count; design's 80 is verified and authoritative — Reason: warning 4
- Added Chain 1+2 expected output size (<2KB) and >5KB warning threshold to C3.1 — Reason: suggestion 1
- Reworded I-7 scope leakage mitigation to accurately describe LLM-executed filtering — Reason: suggestion 2

---

## Handoff Review - Iteration 1 - 2026-02-28T23:00:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved with warnings

**Issues:**
- [warning] [completeness] Pilot placement in Phase 5 lacks explicit "gate" ordering — planner may not sequence pilot-before-full-batch correctly (at: Phase 5, C5.3, Dependency Graph)
  Suggestion: Add explicit pilot gate note and dependency edge
- [warning] [completeness] I-7 scope leakage filtering location unspecified — planner won't know where instruction lives in command file (at: I-7, C3.1)
  Suggestion: Specify filtering instruction placement between Chain 2 return and Chain 3 dispatch
- [warning] [assumptions] batch-promptimize.sh relative path `plugins/iflow/...` requires specific CWD but no guard specified (at: C2.3, I-3)
  Suggestion: Add CWD requirement and startup guard
- [suggestion] [clarity] secretary.md restructure scope unmeasured — planner can't size the task (at: C3.4)
  Suggestion: Add rough estimate of blocks to extract
- [suggestion] [consistency] AC-7→AC-5 dependency direction inverted — schemas are part of split, not prerequisite (at: Dependency Graph)
  Suggestion: Merge AC-5 into AC-7 dependency

**Changes Made:**
- Added explicit pilot gate note to Phase 5 execution order with "remaining files blocked until pilot passes" — Reason: warning 1
- Added dependency edge: AC-13 (pilot pass) → Phase 4 full batch — Reason: warning 1
- Specified filtering instruction placement: between Chain 2 return and Chain 3 dispatch with explicit instruction text — Reason: warning 2
- Added CWD requirement and startup guard for scoring-rubric.md existence to C2.3 — Reason: warning 3
- Merged AC-5 into AC-7 dependency in graph — Reason: suggestion 2

---

## Handoff Review - Iteration 2 - 2026-02-28T23:15:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved

**Issues:**
- [suggestion] [clarity] Dependency graph label "Phase 4 full batch" is ambiguous — could imply Phase 4 doesn't start until Phase 5 (at: Dependency Graph)
  Suggestion: Rename to "Phase 4 remaining batch (~80 non-pilot files)"

**Changes Made:**
None required — zero blockers and zero warnings. Suggestion applied for clarity.

---

## Stage 1: Plan Review - Iteration 1 - 2026-02-28T23:30:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [completeness] Missing test-promptimize-content.sh update — changing rubric from 9→10 dimensions breaks ~15 assertions in the test file (at: Phase 2 / Step 2.1)
  Suggestion: Add TDD Red step to update test assertions before implementation
- [blocker] [testability] TDD anchors use ad-hoc grep instead of referencing actual automated test suite (at: TDD Anchors table)
  Suggestion: Reference test-promptimize-content.sh as the real Red-Green cycle
- [warning] [consistency] Secretary.md touched in 5 separate steps without intermediate verification (at: Steps 3.4, 4.1, 4.2, 4.3, 5.1)
  Suggestion: Add intermediate routing verification after structural changes
- [warning] [feasibility] `claude -p` flag syntax unverified for `--allowedTools` and `--model` (at: Step 2.3)
  Suggestion: Verify exact CLI flag names
- [warning] [completeness] Chain output handling between dispatches unspecified in Steps 3.1/3.2 (at: Steps 3.1, 3.2)
  Suggestion: Add explicit chain output handling instructions
- [warning] [assumptions] In-scope file count may differ from estimate; no pre-sweep audit planned (at: Phase 4)
  Suggestion: Add pre-sweep audit step to produce definitive file list
- [warning] [completeness] validate.sh domain-specific exclusion may have gaps (at: Step 5.1)
  Suggestion: Document known false positive patterns
- [warning] [completeness] Pre-refactor baseline capture strategy unclear — "git stash" won't work after Phase 1-4 commits (at: Phase 5 / AC-13)
  Suggestion: Add Phase 0 baseline capture before any modifications
- [warning] [consistency] SKILL.md "exactly 9 entries" appears in different text patterns at line 58 vs 117 (at: Step 2.1)
  Suggestion: Correct text patterns in plan
- [warning] [assumptions] Phase 2 dependency chain overstated — batch script depends only on rubric, not SKILL.md/command (at: Dependency Graph)
  Suggestion: Fix dependency to show Step 2.3 parallel with 2.1b/2.2

**Changes Made:**
- Added Phase 0: Baseline Capture (Step 0.1) for pre-refactor promptimize scores and representative outputs — Reason: warning 8
- Added Step 2.1a: Update test-promptimize-content.sh assertions from 9→10 (TDD Red) — Reason: blocker 1
- Renamed original Step 2.1 to Step 2.1b (TDD Green) — Reason: blocker 1
- Updated TDD Anchors table to reference actual test-promptimize-content.sh file — Reason: blocker 2
- Added secretary.md intermediate verification (3 routing prompts after restructure) — Reason: warning 1
- Added note confirming `--allowedTools` and `--model` flags verified via `claude --help` — Reason: warning 2
- Added chain output handling instructions to Steps 3.1/3.2 — Reason: warning 3
- Added Step 4.0: Pre-Sweep Audit to produce definitive in-scope file list — Reason: warning 4
- Added known false positive patterns to validate.sh step — Reason: warning 5
- Corrected SKILL.md text patterns: line 58 "all 9 dimensions", line 117 "exactly 9 entries" — Reason: warning 7
- Fixed Phase 2 dependency: Step 2.3 parallel with 2.1b/2.2, depends only on Step 1.1 — Reason: warning 8
- Added secretary.md TD-3 exception note for named anchors — Reason: warning 1
- Added Commit Strategy section with 10 commit points — Reason: general improvement
- Added Complexity classifications per step — Reason: general improvement
- Updated File Manifest with test-promptimize-content.sh and adjective-audit.md — Reason: completeness

---

## Stage 1: Plan Review - Iteration 2 - 2026-02-28T23:45:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Needs Revision

**Issues:**
- [blocker] [assumption] Step 2.1a grep pattern for dimension counting hardcodes 9 names; adding `|Cache` required (at: Step 2.1a — test_rubric_has_exactly_9_dimensions grep)
  Suggestion: Add `|Cache` to grep pattern in both dimension-counting test functions
- [blocker] [assumption] `test_cmd_score_formula_contains_27_and_100` missing from Step 2.1a update list; will break when 27→30 (at: Step 2.1a — missing test function)
  Suggestion: Add this test to the update list with 27→30 change
- [blocker] [assumption] Line numbers in Step 2.1a inaccurate; missed runner lines 1362 and 1413 (at: Step 2.1a — runner references)
  Suggestion: Use function names as anchors instead of line numbers
- [warning] [failure-mode] Step 2.2 example values unspecified for 10-score update (at: Step 2.2)
  Suggestion: Specify concrete example with 10 scores
- [warning] [failure-mode] Secretary.md 5 separate editing passes could invalidate static-first ordering (at: Steps 3.3-4.3)
  Suggestion: Add final ordering re-verification after all secretary.md edits
- [warning] [dependency] Step 3.3 dependency on 2.2 overstated — secretary.md comment is independent (at: Step 3.3)
  Suggestion: Clarify dependency is verification-only
- [warning] [failure-mode] Step 0.1 test inputs not stored as reproducible artifacts (at: Step 0.1)
  Suggestion: Create test-inputs/ directory with stored inputs
- [warning] [feasibility] batch-promptimize.sh no smoke test for score extraction (at: Step 2.3)
  Suggestion: Add single-file smoke test
- [warning] [tdd-order] Steps 3.1/3.2 TDD anchors are structural only, not behavioral (at: TDD Anchors)
  Suggestion: Acknowledge and note behavioral verification is in Step 5.3
- [warning] [failure-mode] Step 4.0 audit timing note missing — runs after restructure (at: Step 4.0)
  Suggestion: Note audit produces authoritative count post-restructure
- [warning] [failure-mode] Word-boundary regex excludes derived forms intentionally (at: Step 4.0/5.1)
  Suggestion: Document this in audit methodology

**Changes Made:**
- Replaced hardcoded line numbers with function name anchors in Step 2.1a — Reason: blocker 3
- Added `|Cache` grep pattern extension to Step 2.1a for both dimension-counting test functions — Reason: blocker 1
- Added `test_cmd_score_formula_contains_27_and_100` to Step 2.1a update list with 27→30 change — Reason: blocker 2
- Added concrete 10-score example to Step 2.2: `[3,2,1,3,2,3,3,3,2,2] → sum=24 → score=80` — Reason: warning 1
- Added secretary.md final ordering re-verification after all editing passes — Reason: warning 2
- Clarified Step 3.3 dependency is verification-only; secretary.md comment independent — Reason: warning 3
- Added test-inputs/ directory to Step 0.1 for reproducible test artifacts — Reason: warning 4
- Added single-file smoke test to Step 2.3 — Reason: warning 5
- Added "structural verification only" notes to TDD Anchors for Steps 3.1/3.2 — Reason: warning 6
- Added audit methodology note: post-restructure timing and derived-form exclusion — Reason: warnings 7+8
- Allowed Phase 1 to run parallel with Step 0.1 (reference files only, no pilot files) — Reason: suggestion 1
- Updated dependency graph to reflect all changes — Reason: consistency
- Updated File Manifest with test-inputs/ directory — Reason: completeness

---

## Stage 1: Plan Review - Iteration 3 - 2026-02-28T23:55:00+08:00

**Reviewer:** plan-reviewer (skeptic)
**Decision:** Approved with warnings (6 warnings, 3 suggestions)

LAZY-LOAD-WARNING: plan-reviewer did not confirm artifact reads

**Issues:**
- [warning] [assumption] Step 2.1b line numbers (58, 117) are approximate — no dependency modifies SKILL.md before 2.1b but should note as approximate (at: Step 2.1b)
- [warning] [assumption] Adjective count estimates (~38 files) may differ from actual (~28 non-reference files in scope) — Step 4.0 audit is self-correcting (at: Step 4.0, Phase 4 Estimated Scope)
- [warning] [dependency] test_scoring_formula_max_denominator_is_27 naming implies denominator check but actual assertion is dim_count — plan instructions are functionally correct (at: Step 2.1a)
- [warning] [failure-mode] Chain output JSON extraction from LLM response is fragile — mitigated by AC-13 pilot and fail-fast error handling (at: Steps 3.1, 3.2)
- [warning] [assumption] claude -p flag syntax assumed stable — mitigated by smoke test in Step 2.3 (at: Step 2.3)
- [warning] [tdd-order] promptimize.md line 145 "Sum all 9 dimension scores" not explicitly listed in Step 2.2 Action (at: Step 2.2)
- [suggestion] Secretary.md has 3 verification points (after restructure, after Phase 4, Step 5.3 pilot) — thorough, no change needed
- [suggestion] batch-promptimize.sh executability implicitly covered by test
- [suggestion] Commit granularity is good for git bisect

**Changes Made:**
1. Step 2.1b: Added note that line numbers are approximate — use text-match search (grep for exact strings) rather than relying on line numbers
2. Step 2.2: Added "Step 5 preamble: 'Sum all 9 dimension scores' → 'Sum all 10 dimension scores' (~line 145)" to Action section
3. No other changes needed — remaining warnings explicitly noted as "no action required" by reviewer (self-correcting via existing audit steps, pilot verification, and smoke tests)

---

## Stage 2: Chain Review - Iteration 1 - 2026-03-01T00:10:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Approved with 1 warning

**Issues:**
- [warning] Steps 3.3 and 3.4 both touch secretary.md in parallel — risks edit conflicts (at: Phase 3 Steps 3.3/3.4)
  Suggestion: Add micro-dependency — complete Step 3.4 restructure on secretary.md first, then add Step 3.3 comment
- [suggestion] Step 2.1b still has approximate line numbers (~Line 58, ~Line 117) that contradict the function-name-as-anchor guidance

**Changes Made:**
1. Step 3.3 Dependencies: Added explicit micro-dependency for secretary.md — "complete Step 3.4 (cache restructure) first, then add the trivial-math comment"
2. Step 2.1b line numbers: Retained as approximate references since the grep-match text is already present as primary locator — removing would reduce navigability without safety benefit

---

## Task Review Iteration 1 - 2026-03-01T00:35:00+08:00

**Decision:** Needs Revision

**Issues:**
- [blocker] T02: Group A parallel with T01 but appends to baseline-scores.md which T01 creates — dependency conflict
- [blocker] overall: Zero tasks have 'Why' traceability field linking to plan step/AC
- [blocker] T02: Representative test inputs not concrete — engineer must construct from scratch
- [blocker] T25/T26/T27: No grep command specified for adjective verification
- [blocker] T26: Secretary.md batching instruction creates ambiguity about which task owns adjective+passive+terminology changes
- [blocker] T41: Gate/decision point, not executable task — no artifact produced
- [warning] T19/T20/T21/T22: Automated diff verification has no concrete command
- [warning] T29: Done criteria uses subjective promptimize score, not binary grep check
- [warning] T30: No grep command or README list for terminology audit
- [warning] T42: Unbounded iteration — no stopping condition for files scoring <80
- [warning] T15: Single-grep verification duplicates T09 Done criteria — fold into T09
- [warning] T16: Single-grep verification duplicates T10 Done criteria — fold into T10
- [warning] T08: Grep count "returns 1 match" fragile — use >=1
- [suggestion] T03: No file naming convention specified for test inputs
- [suggestion] T34: Test procedure not concrete
- [suggestion] T23: Automated diff command not specified

**Changes Made:**
1. Added 'Why' field to all tasks tracing to plan steps and success criteria
2. Fixed T02 deps: now depends on T01, removed from parallel Group A
3. Added concrete test input descriptions to T02 with specific content requirements
4. Added exact grep verification commands to T23/T24/T25 (old T25/T26/T27)
5. Clarified T24 (old T26) — removed secretary.md batching ambiguity, adjective-only scope
6. Reframed T39 (old T41) as artifact-producing task: compile pilot gate report
7. Folded T15/T16 into T09/T10 Done criteria, removed as standalone tasks, renumbered T17-T42 to T15-T40
8. Added concrete diff commands to T17-T20, T21 (old T19-T22, T23)
9. Replaced T27 (old T29) subjective done criteria with grep-based passive voice check
10. Added exact grep command and README list to T28 (old T30)
11. Added stopping condition to T40 (old T42): max 2 fix iterations per file, document deferrals
12. Fixed T08 grep count to >=1 instead of exactly 1
13. Added file naming convention to T03
14. Added concrete test procedure to T32 (old T34)

---

## Task Review Iteration 2 - 2026-03-01T01:00:00+08:00

**Decision:** Needs Revision

**Issues:**
- [blocker] T02: No invocation mechanism specified — HOW to run each pilot file type not described
- [blocker] T22: Deps omit T12/T13 — God Prompt splits could introduce new text containing adjectives
- [warning] T15: Routing prompts not specified (T30 has them but T15 doesn't)
- [warning] T27: Passive voice grep pattern `\b(should be|is returned|are provided|will be validated|is expected to|are expected to)\b` too narrow — misses common constructions
- [warning] T28: Manual verification unbounded — no count or time cap
- [warning] T07: Possible 8th function rename missing (reviewer notes mapping table function)
- [warning] T40: `below-threshold-files.md` path not explicit

**Changes Made:**
1. T02: Added explicit invocation mechanism per pilot file type (agent → Task dispatch, command → Skill invoke, skill → Skill invoke)
2. T22: Added T12, T13 to deps — God Prompt splits must complete before adjective audit
3. T15: Added 3 concrete routing prompts to Done criteria matching T30 prompts
4. T27: Expanded passive voice grep pattern to include `\bcan be\b|\bhas been\b|\bwere .+ed\b|\bis .+ed\b|\bare .+ed\b`
5. T28: Added count target — verify all instances conform, bounded to files touched in T23-T25 + T27
6. T07: Verified — task already lists all 7 function renames including mapping table entry; no 8th needed (6 test functions + 1 runner invocation pattern update)
7. T40: Added explicit path `docs/features/033-comprehensive-prompt-refactor/below-threshold-files.md`

---

## Task Review Iteration 3 - 2026-03-01T01:30:00+08:00

**Decision:** Needs Revision

**Issues:**
- [blocker] T02: `Task()` and `Skill()` invocation syntax appears as pseudo-code — need to clarify these are Claude Code tool names or use slash command alternatives
- [blocker] T02: `baseline-outputs.md` naming conflicts with `baseline-scores.md` from T01 — confusing which file holds what
- [blocker] T10: Done criterion 5 "No claude -p call performs score computation" self-contradictory — LLM must score dimensions, only percentage is bash
- [blocker] T28: `HEAD~{n}` placeholder has no concrete value — engineer can't execute
- [warning] T15: No invocation mechanism for routing prompt verification
- [warning] T21: Third done check has no concrete command for verifying static-section-before-dynamic
- [warning] T27: Grep pattern limited — won't catch all passive voice constructions
- [warning] T30: Same invocation mechanism gap as T15 for routing prompts
- [warning] T34: No invocation mechanism for agent behavioral verification
- [warning] T35: Same invocation mechanism gap for secretary behavioral verification
- [warning] T40: Per-dimension scores not available from batch output — no guidance for fixing failing files
- [warning] T39: BLOCKED case done criterion ambiguous — unclear what artifact state means "done"

**Changes Made:**
1. T02: Clarified `Task()` and `Skill()` are Claude Code tool names (not CLI); added alternative slash-command note
2. T02: Renamed output file to `baseline-behaviors.md` to disambiguate from `baseline-scores.md`
3. T10: Reworded Done criterion 5 to distinguish dimension scoring (LLM) from percentage computation (bash arithmetic)
4. T28: Replaced `HEAD~{n}` with concrete approach: `git diff --name-only` against Phase 4 commit tag
5. T15: Added verification method — read file and confirm static sections precede dynamic
6. T21: Added concrete grep command for static-before-dynamic verification
7. T27: Added supplementary note: use promptimize `technique_currency` dimension for comprehensive passive voice detection
8. T30: Added same verification method as T15
9. T34: Added invocation mechanism — dispatch agent via Task() with stored test input
10. T35: Added invocation mechanism — invoke secretary via Skill() with stored routing prompts
11. T40: Added instruction to run interactive `/iflow:promptimize` on failing files for per-dimension diagnosis
12. T39: Clarified BLOCKED case: report documents failures with investigation notes; gate decision artifact exists regardless

---

## Task Review Iteration 4 - 2026-03-01T02:00:00+08:00

**Decision:** Needs Revision

**Issues:**
- [blocker] T02, T30, T34, T35: 'Agent tool' and 'Skill tool' references — reviewer wants slash command invocations instead
- [blocker] T14: Dependency Summary diagram missing T15→T14 edge
- [blocker] T28: git log grep for commit tag will fail because commit doesn't exist yet during Phase 4
- [blocker] T36: No specific invocation method or binary done criteria
- [warning] T02: baseline-behaviors.md creation not explicitly stated in Action
- [warning] T07: 'all runner invocations' scope ambiguous
- [warning] T10: grep pattern `$(( ` needs escaping note
- [warning] T12: chain error handling verification subjective
- [warning] T17: {filepath} placeholder not expanded
- [warning] T21: nested grep comparison not executable as single command
- [warning] T22: brace expansion may not work in all shells
- [warning] T40: 95% fallback deviates from SC-1

**Changes Made:**
1. T02, T30, T34, T35: Replaced ALL 'Agent tool' / 'Skill tool' references with concrete slash command invocations (/iflow:secretary, /iflow:review-ds-code, /iflow:review-ds-analysis) or `claude -p` for agent dispatch
2. T14: Added T15→T14 edge in Dependency Summary diagram
3. T28: Replaced git log grep with simpler approach: reference adjective-audit.md file list directly
4. T36: Added concrete invocation (`/iflow:brainstorming` with test topic) and binary done criteria
5. T02: Made baseline-behaviors.md file creation explicit in Action step
6. T07: Clarified runner invocation scope — 7 function renames covers all dimension-related functions
7. T10: Added escaping note for `$(( ` grep pattern
8. T12: Added concrete grep verification for chain error handling
9. T17: Expanded {filepath} placeholder to actual file paths
10. T21: Split nested grep into two sequential verification steps
11. T22: Added explicit `bash -O extglob` note for brace expansion
12. T40: Added note that 95% pass rate is deviation from SC-1 threshold with deferral documentation

---

## Task Review Iteration 5 - 2026-03-01T02:30:00+08:00

**Decision:** Needs Revision (ITERATION CAP REACHED — proceeding with concerns)

**Issues:**
- [blocker] T02: `claude -p` invocation still underspecified — how to assemble system prompt flag and where to read agent prompt from
- [blocker] T02: brainstorming skill invocation mechanism unclear — CC session vs standalone CLI approach
- [blocker] T07: runner call site update "figure out call sites" is not self-verifying — needs explicit grep
- [blocker] T10: grep pattern `'\$((  '` has trailing spaces that won't match reliably
- [blocker] T14/T15: task ordering confusing — T14 appears before T15 in file but depends on T15
- [blocker] T22: missing T21 as dependency — audit should run after cache restructure verification
- [warning] T02: plan file name vs task file name mismatch (baseline-outputs.md vs baseline-behaviors.md) needs note
- [warning] T17: git diff baseline ambiguous — diff against HEAD vs specific commit unclear
- [warning] T21: hardcoded section header patterns may miss files with different naming conventions
- [warning] T27: done criteria defers comprehensive passive voice detection to future promptimize task
- [warning] T28: scope narrower than plan requirement — only checks adjective-audit.md files, not all 85
- [warning] T33: promptimize evaluation of 3-chain commands (ds-code, ds-analysis) unclear — which file to score
- [warning] T40: spec deviation (95% fallback) not formally flagged as spec divergence

**Changes Made:**
None — iteration cap (5/5) reached. Concerns documented and proceeding to chain validation (Stage 2).

---

## Stage 2: Chain Review - Iteration 1 - 2026-03-01T02:45:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision

**Issues:**
- [blocker] T02: `claude -p` invocation for design-reviewer.md underspecified — no pattern for system prompt assembly
- [blocker] T02: brainstorming skill invocation mechanism unclear — CC session vs standalone CLI
- [blocker] T07: runner call site update not self-verifying — old function names may persist
- [blocker] T10: grep pattern `'\$(( '` with trailing spaces unreliable
- [blocker] T14/T15: task ordering inverted in file — T14 before T15 despite T14 depending on T15
- [blocker] T22: missing T21 as dependency — audit should gate on cache restructure verification
- [warning] T17: git diff HEAD baseline ambiguous relative to commit timing
- [warning] T21: hardcoded section header patterns may miss files with different naming
- [warning] T27: done criteria defers comprehensive passive voice to future promptimize task
- [warning] T28: scope narrower than plan — only checks adjective-audit.md files, not all 85
- [warning] T33: promptimize evaluation of 3-chain commands unclear
- [warning] T40: spec deviation (95% fallback) not formally flagged

**Changes Made:**
1. T02: Added exact `claude -p` pattern with `--system-prompt` flag for agent invocation; clarified brainstorming runs interactively in CC session
2. T07: Added grep verification that all 7 old function names return 0 matches
3. T10: Replaced trailing-spaces grep with `grep -c 'sum \* 100'` formula verification
4. T14/T15: Reordered T15 before T14 in file to match dependency order
5. T22: Added T21 to deps; updated dependency graph
6. T17: Clarified git diff runs before committing restructure changes
7. T21: Added requirement for standard `## Static Reference` section header
8. T27: Added manual audit of 3 known passive voice files from plan
9. T28: Expanded Done criteria to grep all 85 files + READMEs
10. T33: Added note about evaluating 3-chain orchestration files
11. T40: Added pre-approved deviation note with escalation threshold

---

## Stage 2: Chain Review - Iteration 2 - 2026-03-01T01:45:00+08:00

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (approved: true but 11 warnings)

**Issues:**
- [warning] T02: claude -p --system-prompt does not strip YAML frontmatter from agent files
- [warning] T02: brainstorming CC session requirement not explicit about headless unavailability
- [warning] T07: grep -c output "0" ambiguous — exit code vs stdout
- [warning] T10: grep pattern 'sum \* 100' too loose — does not catch operator precedence errors
- [warning] T17/T18: git diff HEAD may include prior uncommitted edits, not isolated to T17 changes
- [warning] T21: scope clarification needed — non-pilot files only, pilot verification happens elsewhere
- [warning] T27: 'can be' in grep pattern produces false positives on modal constructions
- [warning] T27: plan diverges from batch-promptimize discovery; grep + manual review used instead
- [warning] T28: no automated violation detection — manual inspection of hundreds of matches needed
- [warning] T33: no halt/investigate path if pilot scores <80
- [warning] T40: 'pre-approved deviation without spec update' creates spec inconsistency
- [suggestion] T22: T14 missing from deps — secretary.md math comment should complete before content sweep
- [suggestion] T33: T01 missing from explicit deps — baseline-scores.md needed for comparison

**Changes Made:**
1. T02: Added frontmatter stripping note and explicit headless-unavailability warning
2. T07: Clarified grep -c outputs integer `0` (single file, zero matches)
3. T10: Strengthened grep to match exact formula `(sum * 100 + 15) / 30`
4. T17/T18: Added isolation note — stash or wc -l pre/post if prior edits exist
5. T21: Added scope clarification note about non-pilot files only
6. T27: Removed 'can be' from grep; added plan-divergence note in Action
7. T28: Added scoped violation-detection grep patterns for machine-detectable checks
8. T33: Added halt/investigate path for <80 scores with max 2 fix iterations
9. T40: Changed to require SC-1 spec amendment if Option (b) is used
10. T22: Added T14 to deps list
11. T33: Changed deps to include T01 explicitly

---

## Stage 2: Chain Review - Iteration 3 - 2026-03-01T01:45:00+08:00

LAZY-LOAD-WARNING: phase-reviewer did not confirm artifact reads

**Reviewer:** phase-reviewer (gatekeeper)
**Decision:** Needs Revision (approved: true, but 2 warnings remain)

**Issues:**
- [warning] T21 Step 2 and Step 3 hardcode grep for '## Static Reference' but T17 Done criteria says 'or equivalent named static section'. If any of the 7 files use a differently-named header, T21's grep returns no match and ordering verification produces a false negative.
  Suggestion: Remove 'or equivalent' escape hatch from T17 — mandate exactly '## Static Reference' as the required header name.
- [warning] T40 Done criterion (b) allows implementer to unilaterally amend spec.md SC-1 with no review gate — self-authorizes modifying the spec that governs feature completion.
  Suggestion: Add explicit escalation step before option (b): require backlog item + deviation note before amending spec.md.
- [suggestion] T13 Done criteria says 'Same verification as T12 adapted for analysis review axes' without spelling out adapted grep patterns.
  Suggestion: Expand T13 Done to mirror T12's explicit 4-step verification with file-specific grep commands.

**Changes Made:**
1. T17: Removed 'or equivalent named static section' — mandated exactly '## Static Reference' as required header
2. T40: Added explicit escalation step before option (b) — backlog item + deviation note required before spec amendment
3. T13: Expanded Done criteria to mirror T12's explicit 4-step verification pattern

---
