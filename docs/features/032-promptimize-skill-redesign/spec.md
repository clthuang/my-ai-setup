# Specification: Promptimize Skill Redesign

## Problem Statement

The `promptimize` skill (`plugins/iflow/skills/promptimize/SKILL.md`) and its command (`plugins/iflow/commands/promptimize.md`) violate four Anthropic prompt engineering best practices identified in the feedback report (`docs/retrospectives/2026-02-28-promptimize-feedback.md`):

1. **God Prompt anti-pattern** — Steps 4-7 (evaluate 9 dimensions, calculate score, generate improved version, generate report) execute in a single LLM pass, risking context degradation and hallucination.
2. **HTML comments instead of XML tags** — Step 6 uses `<!-- CHANGE -->` / `<!-- END CHANGE -->` markers instead of Claude-native `<change>` XML tags.
3. **Math in LLM** — Step 5 asks the LLM to compute `(sum / 27 * 100)`, which is unreliable.
4. **Brittle merge algorithm** — Step 8's "Accept some" logic uses string replacement against LLM-generated boundary markers, which corrupts files when markers are malformed.

## Scope

### In Scope

- Refactor `SKILL.md` to decompose the God Prompt into two chained passes (Grader + Rewriter)
- Replace HTML comment markers with XML tags in the Rewriter output format
- Move score calculation out of the LLM — the orchestrating command computes the final score from raw dimension scores
- Replace the "Accept some" string-replacement merge with a diff/patch-based approach
- Update `commands/promptimize.md` to orchestrate the two-pass flow and perform score calculation
- Update `references/scoring-rubric.md` if structural changes are needed to support the new flow

### Out of Scope

- Changes to `references/prompt-guidelines.md` content (the guidelines themselves are correct)
- Adding new scoring dimensions beyond the existing 9
- Changing the staleness check logic (Step 3)
- Changing the command's interactive file selection (Steps 1-2 of command)
- Changing component type detection logic (Step 1 of skill)
- Changing reference file loading logic (Step 2 of skill)

## Requirements

### R1: Two-Pass Decomposition (Grader + Rewriter)

**R1.1** The skill MUST split the current single-pass Steps 4-7 into two distinct phases:
- **Phase 1 (Grade):** Evaluate 9 dimensions against the scoring rubric. Output ONLY structured JSON with scores, findings, and suggestions per dimension.
- **Phase 2 (Rewrite):** Consume the Phase 1 JSON output as context. Generate the improved version of the target file with change markers.

**R1.2** Phase 1 output schema:
```json
{
  "dimensions": [
    {
      "name": "structure_compliance",
      "score": 3,
      "finding": "Matches macro-structure exactly",
      "suggestion": null,
      "auto_passed": false
    }
  ]
}
```

**R1.3** Phase 2 MUST receive the Phase 1 JSON as explicit input context (not rely on prior conversation state).

**R1.4** The report (current Step 7) is generated by the command from the Phase 1 JSON and Phase 2 output — not by the LLM in a third pass.

### R2: XML Change Markers

**R2.1** Phase 2 (Rewriter) MUST use XML tags instead of HTML comments:
```xml
<change dimension="token_economy" rationale="Remove redundant preamble">
modified content here
</change>
```

**R2.2** Multi-region changes for one dimension: each region gets its own `<change>` tag with the same `dimension` attribute.

**R2.3** Overlapping dimensions (two dimensions modify the same text): use comma-separated dimension names in the `dimension` attribute:
```xml
<change dimension="token_economy,structure_compliance" rationale="Combined fix">
modified content
</change>
```

**R2.4** Pass dimensions (score=3) MUST NOT have `<change>` tags — their content remains unchanged.

### R3: Score Calculation Outside LLM

**R3.1** The LLM MUST NOT compute the overall score. Phase 1 outputs raw integer scores (1-3) per dimension.

**R3.2** The command (`promptimize.md`) computes the overall score: `Math.round((sum of scores / 27) * 100)`.

**R3.3** Auto-passed dimensions contribute a fixed score of 3 to the sum, as currently specified.

### R4: Diff-Based Partial Acceptance

**R4.1** The "Accept some" flow MUST NOT use string replacement against LLM-generated markers.

**R4.2** Instead, the "Accept some" flow works as follows:
1. Parse `<change>` XML tags from the Phase 2 output to identify changed regions by dimension.
2. Present each dimension as a multiSelect option (unchanged from current UX).
3. For **selected** dimensions: keep the content inside their `<change>` tags (strip the tags).
4. For **unselected** dimensions: replace the `<change>` block (tags + content) with the corresponding original text from the source file.
5. Strip all remaining `<change>` tags.

**R4.3** The command MUST validate XML well-formedness of `<change>` tags before attempting partial acceptance. If malformed, degrade to Accept all / Reject with warning (same fallback as current behavior).

**R4.4** "Accept all" strips all `<change>` tags and writes the result. No merge logic needed.

### R5: Report Generation

**R5.1** The report template remains the same structure (component type, score, guidelines version, strengths, issues table, improved version).

**R5.2** The report is assembled by the command using:
- Phase 1 JSON for: dimension scores, findings, suggestions, strengths, issues table
- Computed overall score (R3.2)
- Phase 2 output for: the improved version section

**R5.3** Staleness warning and over-budget warning logic remain unchanged.

### R6: Backward Compatibility

**R6.1** No backward compatibility required — this is private tooling per CLAUDE.md principles.

**R6.2** The command's external interface (file path argument, interactive selection, AskUserQuestion approval) remains the same.

**R6.3** YOLO mode behavior remains: auto-select "Accept all" in Step 8.

## Acceptance Criteria

- [ ] **AC1:** Running `/iflow:promptimize` on a skill file produces a grading JSON in Phase 1 and a rewrite with XML `<change>` tags in Phase 2 — never in a single pass.
- [ ] **AC2:** The overall score in the report matches deterministic calculation from raw dimension scores, not LLM output.
- [ ] **AC3:** "Accept some" correctly applies only selected dimensions using XML tag parsing — no string replacement against original content boundaries.
- [ ] **AC4:** Malformed `<change>` tags trigger the fallback warning and degrade to Accept all / Reject.
- [ ] **AC5:** "Accept all" produces a clean file with no residual XML tags.
- [ ] **AC6:** Auto-passed dimensions score 3 and have no `<change>` tags in the output.
- [ ] **AC7:** YOLO mode auto-selects "Accept all" without prompting.
- [ ] **AC8:** The staleness check and over-budget warning still function correctly.
- [ ] **AC9:** `./validate.sh` passes after changes.

## Files to Modify

| File | Change |
|------|--------|
| `plugins/iflow/skills/promptimize/SKILL.md` | Decompose into Phase 1 (Grade) and Phase 2 (Rewrite); replace HTML markers with XML; remove score calculation |
| `plugins/iflow/commands/promptimize.md` | Orchestrate two-pass flow; compute score; assemble report; implement XML-based partial acceptance |
| `plugins/iflow/skills/promptimize/references/scoring-rubric.md` | No changes expected — rubric content is correct |
| `plugins/iflow/skills/promptimize/references/prompt-guidelines.md` | No changes expected |

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Phase 2 Rewriter ignores Phase 1 findings | Medium | High | Include Phase 1 JSON as explicit `<grading_result>` XML context block in Phase 2 prompt |
| XML `<change>` tags get mangled by LLM | Low | Medium | Validate well-formedness before merge; fallback to Accept all / Reject |
| Two-pass adds latency | Medium | Low | Acceptable tradeoff for correctness; both passes are fast for single-file review |
| Command becomes too complex with orchestration logic | Medium | Medium | Keep orchestration steps clearly numbered; progressive disclosure pattern for the command |

## Dependencies

- None — self-contained within the promptimize skill and command files.
